<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>传统锁回顾 | 我的笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notes/favicon.ico">
    <script data-ad-client="ca-pub-4147143076931995" async="true" src="/notes//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="记录Java的学习过程">
    
    <link rel="preload" href="/notes/assets/css/0.styles.db9e9bf4.css" as="style"><link rel="preload" href="/notes/assets/js/app.4394edef.js" as="script"><link rel="preload" href="/notes/assets/js/3.499ba1d5.js" as="script"><link rel="preload" href="/notes/assets/js/4.0eddc376.js" as="script"><link rel="prefetch" href="/notes/assets/js/1.38d69124.js"><link rel="prefetch" href="/notes/assets/js/10.a5dbd791.js"><link rel="prefetch" href="/notes/assets/js/100.855dee90.js"><link rel="prefetch" href="/notes/assets/js/101.5f61e033.js"><link rel="prefetch" href="/notes/assets/js/102.3469dfe6.js"><link rel="prefetch" href="/notes/assets/js/103.f97cd3c4.js"><link rel="prefetch" href="/notes/assets/js/104.d1be0323.js"><link rel="prefetch" href="/notes/assets/js/105.bff5ad21.js"><link rel="prefetch" href="/notes/assets/js/106.8bfda405.js"><link rel="prefetch" href="/notes/assets/js/107.fd4a3526.js"><link rel="prefetch" href="/notes/assets/js/108.ec803d12.js"><link rel="prefetch" href="/notes/assets/js/109.8bf97b71.js"><link rel="prefetch" href="/notes/assets/js/11.e807a7ed.js"><link rel="prefetch" href="/notes/assets/js/110.3cbf71f4.js"><link rel="prefetch" href="/notes/assets/js/111.d4476b7a.js"><link rel="prefetch" href="/notes/assets/js/112.3d5957bd.js"><link rel="prefetch" href="/notes/assets/js/113.f101f928.js"><link rel="prefetch" href="/notes/assets/js/114.b45be011.js"><link rel="prefetch" href="/notes/assets/js/115.36fae589.js"><link rel="prefetch" href="/notes/assets/js/116.9f5abe3a.js"><link rel="prefetch" href="/notes/assets/js/117.ea710cb4.js"><link rel="prefetch" href="/notes/assets/js/118.cc44a183.js"><link rel="prefetch" href="/notes/assets/js/119.58bcbadf.js"><link rel="prefetch" href="/notes/assets/js/12.b8e9ea0e.js"><link rel="prefetch" href="/notes/assets/js/120.38ae234a.js"><link rel="prefetch" href="/notes/assets/js/121.20e6693e.js"><link rel="prefetch" href="/notes/assets/js/122.9d14160c.js"><link rel="prefetch" href="/notes/assets/js/123.56e221ac.js"><link rel="prefetch" href="/notes/assets/js/124.80c6fac9.js"><link rel="prefetch" href="/notes/assets/js/125.b851edf2.js"><link rel="prefetch" href="/notes/assets/js/126.565b012b.js"><link rel="prefetch" href="/notes/assets/js/127.d7d6e0ea.js"><link rel="prefetch" href="/notes/assets/js/128.2242a066.js"><link rel="prefetch" href="/notes/assets/js/129.02e60c5d.js"><link rel="prefetch" href="/notes/assets/js/13.ee61224b.js"><link rel="prefetch" href="/notes/assets/js/130.869b1fef.js"><link rel="prefetch" href="/notes/assets/js/131.e7f3e93e.js"><link rel="prefetch" href="/notes/assets/js/132.29465758.js"><link rel="prefetch" href="/notes/assets/js/133.758d34b1.js"><link rel="prefetch" href="/notes/assets/js/134.b91b657f.js"><link rel="prefetch" href="/notes/assets/js/135.f22c78a9.js"><link rel="prefetch" href="/notes/assets/js/136.ff7a4dfb.js"><link rel="prefetch" href="/notes/assets/js/137.0217e3a6.js"><link rel="prefetch" href="/notes/assets/js/138.4530d752.js"><link rel="prefetch" href="/notes/assets/js/139.66f5ff99.js"><link rel="prefetch" href="/notes/assets/js/14.b0ee0bd3.js"><link rel="prefetch" href="/notes/assets/js/140.e98b7a29.js"><link rel="prefetch" href="/notes/assets/js/141.17370b53.js"><link rel="prefetch" href="/notes/assets/js/142.9171a17e.js"><link rel="prefetch" href="/notes/assets/js/143.123cb882.js"><link rel="prefetch" href="/notes/assets/js/144.a3ab3c1e.js"><link rel="prefetch" href="/notes/assets/js/145.df6095ce.js"><link rel="prefetch" href="/notes/assets/js/146.297a5691.js"><link rel="prefetch" href="/notes/assets/js/147.8b775c1d.js"><link rel="prefetch" href="/notes/assets/js/148.5d1953b6.js"><link rel="prefetch" href="/notes/assets/js/149.e86e91d0.js"><link rel="prefetch" href="/notes/assets/js/15.598de02e.js"><link rel="prefetch" href="/notes/assets/js/150.a98bca9c.js"><link rel="prefetch" href="/notes/assets/js/151.f29d3d49.js"><link rel="prefetch" href="/notes/assets/js/152.76982dca.js"><link rel="prefetch" href="/notes/assets/js/153.6cfba964.js"><link rel="prefetch" href="/notes/assets/js/154.cc02a668.js"><link rel="prefetch" href="/notes/assets/js/155.974eb41d.js"><link rel="prefetch" href="/notes/assets/js/156.ecf561d9.js"><link rel="prefetch" href="/notes/assets/js/157.79282e02.js"><link rel="prefetch" href="/notes/assets/js/158.bbd922f3.js"><link rel="prefetch" href="/notes/assets/js/159.89c0c986.js"><link rel="prefetch" href="/notes/assets/js/16.44d6776e.js"><link rel="prefetch" href="/notes/assets/js/160.baf9d921.js"><link rel="prefetch" href="/notes/assets/js/161.a9b8f635.js"><link rel="prefetch" href="/notes/assets/js/162.6d6a7ec5.js"><link rel="prefetch" href="/notes/assets/js/163.a3c7488c.js"><link rel="prefetch" href="/notes/assets/js/164.c9f0500c.js"><link rel="prefetch" href="/notes/assets/js/165.30411c9b.js"><link rel="prefetch" href="/notes/assets/js/166.bc3d5911.js"><link rel="prefetch" href="/notes/assets/js/167.c661fd7b.js"><link rel="prefetch" href="/notes/assets/js/168.cbc5ab9b.js"><link rel="prefetch" href="/notes/assets/js/169.5dee4e88.js"><link rel="prefetch" href="/notes/assets/js/17.d7b8971a.js"><link rel="prefetch" href="/notes/assets/js/170.9e2897f5.js"><link rel="prefetch" href="/notes/assets/js/171.057d9ad1.js"><link rel="prefetch" href="/notes/assets/js/172.fa910130.js"><link rel="prefetch" href="/notes/assets/js/173.4723064f.js"><link rel="prefetch" href="/notes/assets/js/174.8ad20ad0.js"><link rel="prefetch" href="/notes/assets/js/175.ad7ca5e6.js"><link rel="prefetch" href="/notes/assets/js/176.ddd3d12c.js"><link rel="prefetch" href="/notes/assets/js/177.5fb19a05.js"><link rel="prefetch" href="/notes/assets/js/178.8647fda3.js"><link rel="prefetch" href="/notes/assets/js/179.b08f05a2.js"><link rel="prefetch" href="/notes/assets/js/18.42070e39.js"><link rel="prefetch" href="/notes/assets/js/180.4013a5e3.js"><link rel="prefetch" href="/notes/assets/js/181.2ff5d065.js"><link rel="prefetch" href="/notes/assets/js/182.84cb537c.js"><link rel="prefetch" href="/notes/assets/js/183.f5eabd47.js"><link rel="prefetch" href="/notes/assets/js/184.a01b9e48.js"><link rel="prefetch" href="/notes/assets/js/185.e7d88f1a.js"><link rel="prefetch" href="/notes/assets/js/186.358a2348.js"><link rel="prefetch" href="/notes/assets/js/187.9c01f97b.js"><link rel="prefetch" href="/notes/assets/js/188.a26520e2.js"><link rel="prefetch" href="/notes/assets/js/189.e8101173.js"><link rel="prefetch" href="/notes/assets/js/19.deaea0cd.js"><link rel="prefetch" href="/notes/assets/js/190.4db66d1c.js"><link rel="prefetch" href="/notes/assets/js/191.c4fb68e3.js"><link rel="prefetch" href="/notes/assets/js/192.3898a6bb.js"><link rel="prefetch" href="/notes/assets/js/193.e1645fe5.js"><link rel="prefetch" href="/notes/assets/js/194.444e8222.js"><link rel="prefetch" href="/notes/assets/js/195.5a6c28d2.js"><link rel="prefetch" href="/notes/assets/js/196.70fb07df.js"><link rel="prefetch" href="/notes/assets/js/197.e0c5fd7e.js"><link rel="prefetch" href="/notes/assets/js/198.fff60e9b.js"><link rel="prefetch" href="/notes/assets/js/199.38151e80.js"><link rel="prefetch" href="/notes/assets/js/20.31d3a4b3.js"><link rel="prefetch" href="/notes/assets/js/200.746630e8.js"><link rel="prefetch" href="/notes/assets/js/201.c19c0234.js"><link rel="prefetch" href="/notes/assets/js/202.e3cbb9d0.js"><link rel="prefetch" href="/notes/assets/js/203.d433a129.js"><link rel="prefetch" href="/notes/assets/js/204.de75ac01.js"><link rel="prefetch" href="/notes/assets/js/205.55f064b3.js"><link rel="prefetch" href="/notes/assets/js/206.2e4c6536.js"><link rel="prefetch" href="/notes/assets/js/207.658b0485.js"><link rel="prefetch" href="/notes/assets/js/208.0414daa5.js"><link rel="prefetch" href="/notes/assets/js/209.a8c2b910.js"><link rel="prefetch" href="/notes/assets/js/21.998ed6e0.js"><link rel="prefetch" href="/notes/assets/js/210.aad4c8fc.js"><link rel="prefetch" href="/notes/assets/js/211.f116cd27.js"><link rel="prefetch" href="/notes/assets/js/212.f4628715.js"><link rel="prefetch" href="/notes/assets/js/213.ceadc213.js"><link rel="prefetch" href="/notes/assets/js/214.20425d7e.js"><link rel="prefetch" href="/notes/assets/js/215.ea509344.js"><link rel="prefetch" href="/notes/assets/js/216.a4ab1a13.js"><link rel="prefetch" href="/notes/assets/js/217.e7f07700.js"><link rel="prefetch" href="/notes/assets/js/218.d34a6368.js"><link rel="prefetch" href="/notes/assets/js/219.c6aa2c44.js"><link rel="prefetch" href="/notes/assets/js/22.0bde63c4.js"><link rel="prefetch" href="/notes/assets/js/220.a20be513.js"><link rel="prefetch" href="/notes/assets/js/221.7316596a.js"><link rel="prefetch" href="/notes/assets/js/222.841353ed.js"><link rel="prefetch" href="/notes/assets/js/223.e33bec57.js"><link rel="prefetch" href="/notes/assets/js/224.354d6301.js"><link rel="prefetch" href="/notes/assets/js/225.282386c1.js"><link rel="prefetch" href="/notes/assets/js/226.abb99fb7.js"><link rel="prefetch" href="/notes/assets/js/227.b2ab63ea.js"><link rel="prefetch" href="/notes/assets/js/228.df447bd0.js"><link rel="prefetch" href="/notes/assets/js/229.fd1b2705.js"><link rel="prefetch" href="/notes/assets/js/23.d600cd4a.js"><link rel="prefetch" href="/notes/assets/js/230.56479e93.js"><link rel="prefetch" href="/notes/assets/js/231.7fe06ae5.js"><link rel="prefetch" href="/notes/assets/js/232.40909175.js"><link rel="prefetch" href="/notes/assets/js/233.bba63cc0.js"><link rel="prefetch" href="/notes/assets/js/234.ca29b35e.js"><link rel="prefetch" href="/notes/assets/js/235.f8a823b0.js"><link rel="prefetch" href="/notes/assets/js/236.a2235fd6.js"><link rel="prefetch" href="/notes/assets/js/237.0a512d23.js"><link rel="prefetch" href="/notes/assets/js/238.74752a3f.js"><link rel="prefetch" href="/notes/assets/js/239.c2bca48c.js"><link rel="prefetch" href="/notes/assets/js/24.39be2e8d.js"><link rel="prefetch" href="/notes/assets/js/240.ced33249.js"><link rel="prefetch" href="/notes/assets/js/241.a18de0bf.js"><link rel="prefetch" href="/notes/assets/js/242.669b3661.js"><link rel="prefetch" href="/notes/assets/js/243.8d12af13.js"><link rel="prefetch" href="/notes/assets/js/244.94929fbd.js"><link rel="prefetch" href="/notes/assets/js/245.01f98b2d.js"><link rel="prefetch" href="/notes/assets/js/246.1c7cb7bc.js"><link rel="prefetch" href="/notes/assets/js/247.5d018884.js"><link rel="prefetch" href="/notes/assets/js/248.20cc0c3b.js"><link rel="prefetch" href="/notes/assets/js/249.a10fbf5a.js"><link rel="prefetch" href="/notes/assets/js/25.f7a1c429.js"><link rel="prefetch" href="/notes/assets/js/250.cea231a0.js"><link rel="prefetch" href="/notes/assets/js/251.52736b60.js"><link rel="prefetch" href="/notes/assets/js/252.60f6e80e.js"><link rel="prefetch" href="/notes/assets/js/253.e2ab134e.js"><link rel="prefetch" href="/notes/assets/js/254.d221539b.js"><link rel="prefetch" href="/notes/assets/js/255.9acb0f08.js"><link rel="prefetch" href="/notes/assets/js/256.22c747ac.js"><link rel="prefetch" href="/notes/assets/js/257.f836ea8d.js"><link rel="prefetch" href="/notes/assets/js/258.a11bcb0e.js"><link rel="prefetch" href="/notes/assets/js/259.08eb5bd9.js"><link rel="prefetch" href="/notes/assets/js/26.718316a9.js"><link rel="prefetch" href="/notes/assets/js/260.55db7d07.js"><link rel="prefetch" href="/notes/assets/js/261.a0f04612.js"><link rel="prefetch" href="/notes/assets/js/262.e507e349.js"><link rel="prefetch" href="/notes/assets/js/263.bc2798af.js"><link rel="prefetch" href="/notes/assets/js/264.aa2a7ed5.js"><link rel="prefetch" href="/notes/assets/js/265.b3125de8.js"><link rel="prefetch" href="/notes/assets/js/266.01bf6375.js"><link rel="prefetch" href="/notes/assets/js/267.ccea1a20.js"><link rel="prefetch" href="/notes/assets/js/268.be1e4e72.js"><link rel="prefetch" href="/notes/assets/js/269.dbd08cee.js"><link rel="prefetch" href="/notes/assets/js/27.94862e46.js"><link rel="prefetch" href="/notes/assets/js/270.1ca726b8.js"><link rel="prefetch" href="/notes/assets/js/271.f5474b97.js"><link rel="prefetch" href="/notes/assets/js/272.b0ef680f.js"><link rel="prefetch" href="/notes/assets/js/273.c4136437.js"><link rel="prefetch" href="/notes/assets/js/274.4e8bdfd6.js"><link rel="prefetch" href="/notes/assets/js/275.fb644fb5.js"><link rel="prefetch" href="/notes/assets/js/276.5cb09d9f.js"><link rel="prefetch" href="/notes/assets/js/277.57e58373.js"><link rel="prefetch" href="/notes/assets/js/278.43c33939.js"><link rel="prefetch" href="/notes/assets/js/279.914a110e.js"><link rel="prefetch" href="/notes/assets/js/28.a5e6fe66.js"><link rel="prefetch" href="/notes/assets/js/280.cf3b7a68.js"><link rel="prefetch" href="/notes/assets/js/281.de48ba8f.js"><link rel="prefetch" href="/notes/assets/js/282.c069db9c.js"><link rel="prefetch" href="/notes/assets/js/283.747f23a6.js"><link rel="prefetch" href="/notes/assets/js/284.d04f54b2.js"><link rel="prefetch" href="/notes/assets/js/285.39ac6b15.js"><link rel="prefetch" href="/notes/assets/js/286.43b88694.js"><link rel="prefetch" href="/notes/assets/js/287.2cafdc4d.js"><link rel="prefetch" href="/notes/assets/js/288.84d97b4e.js"><link rel="prefetch" href="/notes/assets/js/289.b2118bba.js"><link rel="prefetch" href="/notes/assets/js/29.ab3b6aaf.js"><link rel="prefetch" href="/notes/assets/js/290.16f2afe5.js"><link rel="prefetch" href="/notes/assets/js/291.bc6c61b0.js"><link rel="prefetch" href="/notes/assets/js/292.8bff7b6b.js"><link rel="prefetch" href="/notes/assets/js/293.a3a4b0f8.js"><link rel="prefetch" href="/notes/assets/js/294.0f2cb4da.js"><link rel="prefetch" href="/notes/assets/js/295.28aba777.js"><link rel="prefetch" href="/notes/assets/js/296.2371cb58.js"><link rel="prefetch" href="/notes/assets/js/297.61203718.js"><link rel="prefetch" href="/notes/assets/js/298.037c63f7.js"><link rel="prefetch" href="/notes/assets/js/299.b74b878c.js"><link rel="prefetch" href="/notes/assets/js/30.27ec9a11.js"><link rel="prefetch" href="/notes/assets/js/300.edf28f31.js"><link rel="prefetch" href="/notes/assets/js/301.b6986f4d.js"><link rel="prefetch" href="/notes/assets/js/302.48f59fa0.js"><link rel="prefetch" href="/notes/assets/js/303.c1e4d4ae.js"><link rel="prefetch" href="/notes/assets/js/304.b280da5f.js"><link rel="prefetch" href="/notes/assets/js/305.14e777bd.js"><link rel="prefetch" href="/notes/assets/js/306.3de8374a.js"><link rel="prefetch" href="/notes/assets/js/307.bb6b675d.js"><link rel="prefetch" href="/notes/assets/js/308.2dc4265f.js"><link rel="prefetch" href="/notes/assets/js/309.65b16b58.js"><link rel="prefetch" href="/notes/assets/js/31.20c8bfc3.js"><link rel="prefetch" href="/notes/assets/js/310.8e4c18ae.js"><link rel="prefetch" href="/notes/assets/js/311.c910a30b.js"><link rel="prefetch" href="/notes/assets/js/312.7036cc34.js"><link rel="prefetch" href="/notes/assets/js/313.103ece8b.js"><link rel="prefetch" href="/notes/assets/js/314.2e248349.js"><link rel="prefetch" href="/notes/assets/js/315.9affc380.js"><link rel="prefetch" href="/notes/assets/js/316.ebb4f037.js"><link rel="prefetch" href="/notes/assets/js/317.0dacd35e.js"><link rel="prefetch" href="/notes/assets/js/318.738240d2.js"><link rel="prefetch" href="/notes/assets/js/319.b54a8183.js"><link rel="prefetch" href="/notes/assets/js/32.2c249dba.js"><link rel="prefetch" href="/notes/assets/js/320.7262fc62.js"><link rel="prefetch" href="/notes/assets/js/321.b4d79334.js"><link rel="prefetch" href="/notes/assets/js/322.ad66b9bd.js"><link rel="prefetch" href="/notes/assets/js/323.a8dccd01.js"><link rel="prefetch" href="/notes/assets/js/324.d4051798.js"><link rel="prefetch" href="/notes/assets/js/325.c91a654f.js"><link rel="prefetch" href="/notes/assets/js/326.7ee08c62.js"><link rel="prefetch" href="/notes/assets/js/327.6215a570.js"><link rel="prefetch" href="/notes/assets/js/328.71120a1a.js"><link rel="prefetch" href="/notes/assets/js/329.22e47ea7.js"><link rel="prefetch" href="/notes/assets/js/33.e597a7df.js"><link rel="prefetch" href="/notes/assets/js/330.34079108.js"><link rel="prefetch" href="/notes/assets/js/331.d770f721.js"><link rel="prefetch" href="/notes/assets/js/332.aa85145a.js"><link rel="prefetch" href="/notes/assets/js/333.64e140e4.js"><link rel="prefetch" href="/notes/assets/js/334.cd240324.js"><link rel="prefetch" href="/notes/assets/js/335.cd547635.js"><link rel="prefetch" href="/notes/assets/js/336.91dab600.js"><link rel="prefetch" href="/notes/assets/js/337.2ec5cdc7.js"><link rel="prefetch" href="/notes/assets/js/338.59043c82.js"><link rel="prefetch" href="/notes/assets/js/339.8e5d1e06.js"><link rel="prefetch" href="/notes/assets/js/34.8d4b28aa.js"><link rel="prefetch" href="/notes/assets/js/340.9e2d2874.js"><link rel="prefetch" href="/notes/assets/js/341.61e6092a.js"><link rel="prefetch" href="/notes/assets/js/342.d0ee898b.js"><link rel="prefetch" href="/notes/assets/js/343.fb16ffba.js"><link rel="prefetch" href="/notes/assets/js/344.0bb46145.js"><link rel="prefetch" href="/notes/assets/js/345.ef6bfd94.js"><link rel="prefetch" href="/notes/assets/js/346.523ba3d0.js"><link rel="prefetch" href="/notes/assets/js/347.b7fd68da.js"><link rel="prefetch" href="/notes/assets/js/348.b6778cbf.js"><link rel="prefetch" href="/notes/assets/js/349.566ca9a1.js"><link rel="prefetch" href="/notes/assets/js/35.c2b72c34.js"><link rel="prefetch" href="/notes/assets/js/350.aa159fd9.js"><link rel="prefetch" href="/notes/assets/js/351.fe309038.js"><link rel="prefetch" href="/notes/assets/js/352.62097177.js"><link rel="prefetch" href="/notes/assets/js/353.8c8811bc.js"><link rel="prefetch" href="/notes/assets/js/354.d2ada007.js"><link rel="prefetch" href="/notes/assets/js/355.5d345cc6.js"><link rel="prefetch" href="/notes/assets/js/356.c6810cd7.js"><link rel="prefetch" href="/notes/assets/js/357.ac10961e.js"><link rel="prefetch" href="/notes/assets/js/358.0340e23d.js"><link rel="prefetch" href="/notes/assets/js/359.16bc2223.js"><link rel="prefetch" href="/notes/assets/js/36.57ca532c.js"><link rel="prefetch" href="/notes/assets/js/360.e45f7ea9.js"><link rel="prefetch" href="/notes/assets/js/361.a39d091e.js"><link rel="prefetch" href="/notes/assets/js/362.0283b5a9.js"><link rel="prefetch" href="/notes/assets/js/363.48fa48fe.js"><link rel="prefetch" href="/notes/assets/js/364.25a549cd.js"><link rel="prefetch" href="/notes/assets/js/365.2eddb807.js"><link rel="prefetch" href="/notes/assets/js/366.ef272f1a.js"><link rel="prefetch" href="/notes/assets/js/367.28e17043.js"><link rel="prefetch" href="/notes/assets/js/368.255a80fb.js"><link rel="prefetch" href="/notes/assets/js/369.ae66dd9f.js"><link rel="prefetch" href="/notes/assets/js/37.c545dd68.js"><link rel="prefetch" href="/notes/assets/js/370.88f9a32c.js"><link rel="prefetch" href="/notes/assets/js/371.7ffd8780.js"><link rel="prefetch" href="/notes/assets/js/372.605383d1.js"><link rel="prefetch" href="/notes/assets/js/373.c11f5dfe.js"><link rel="prefetch" href="/notes/assets/js/374.c00642a8.js"><link rel="prefetch" href="/notes/assets/js/375.0b004b06.js"><link rel="prefetch" href="/notes/assets/js/376.2769e761.js"><link rel="prefetch" href="/notes/assets/js/377.816e6da6.js"><link rel="prefetch" href="/notes/assets/js/378.cabaa608.js"><link rel="prefetch" href="/notes/assets/js/379.f3e43a5a.js"><link rel="prefetch" href="/notes/assets/js/38.3d798baf.js"><link rel="prefetch" href="/notes/assets/js/380.1ef68ac8.js"><link rel="prefetch" href="/notes/assets/js/381.f554891d.js"><link rel="prefetch" href="/notes/assets/js/382.4eeb9fb7.js"><link rel="prefetch" href="/notes/assets/js/383.de837b94.js"><link rel="prefetch" href="/notes/assets/js/384.085f9f09.js"><link rel="prefetch" href="/notes/assets/js/385.8fa51abb.js"><link rel="prefetch" href="/notes/assets/js/386.040eac11.js"><link rel="prefetch" href="/notes/assets/js/387.88990e8b.js"><link rel="prefetch" href="/notes/assets/js/388.1ea4a37c.js"><link rel="prefetch" href="/notes/assets/js/389.a323e4b9.js"><link rel="prefetch" href="/notes/assets/js/39.e9da77b7.js"><link rel="prefetch" href="/notes/assets/js/390.22026053.js"><link rel="prefetch" href="/notes/assets/js/391.9f02c56d.js"><link rel="prefetch" href="/notes/assets/js/392.d55d9034.js"><link rel="prefetch" href="/notes/assets/js/393.1cbbcf50.js"><link rel="prefetch" href="/notes/assets/js/394.55ea930c.js"><link rel="prefetch" href="/notes/assets/js/395.d0415c56.js"><link rel="prefetch" href="/notes/assets/js/396.a1f242c0.js"><link rel="prefetch" href="/notes/assets/js/397.ad062a1e.js"><link rel="prefetch" href="/notes/assets/js/398.401acbf5.js"><link rel="prefetch" href="/notes/assets/js/399.7fcb37f1.js"><link rel="prefetch" href="/notes/assets/js/40.152fb70e.js"><link rel="prefetch" href="/notes/assets/js/400.7cad41d3.js"><link rel="prefetch" href="/notes/assets/js/401.bf6e604c.js"><link rel="prefetch" href="/notes/assets/js/402.5271fc7c.js"><link rel="prefetch" href="/notes/assets/js/403.a960210f.js"><link rel="prefetch" href="/notes/assets/js/404.220d9814.js"><link rel="prefetch" href="/notes/assets/js/405.fbeefca5.js"><link rel="prefetch" href="/notes/assets/js/406.1a7a3651.js"><link rel="prefetch" href="/notes/assets/js/407.92451b0d.js"><link rel="prefetch" href="/notes/assets/js/408.9081c518.js"><link rel="prefetch" href="/notes/assets/js/409.5b8705a8.js"><link rel="prefetch" href="/notes/assets/js/41.c973cd04.js"><link rel="prefetch" href="/notes/assets/js/410.2afd45ff.js"><link rel="prefetch" href="/notes/assets/js/411.30a6778b.js"><link rel="prefetch" href="/notes/assets/js/412.5b5fbb7a.js"><link rel="prefetch" href="/notes/assets/js/413.37b4db3c.js"><link rel="prefetch" href="/notes/assets/js/414.41f671f5.js"><link rel="prefetch" href="/notes/assets/js/415.5797eb0a.js"><link rel="prefetch" href="/notes/assets/js/416.5ec4dc00.js"><link rel="prefetch" href="/notes/assets/js/417.471b2657.js"><link rel="prefetch" href="/notes/assets/js/418.93bf4420.js"><link rel="prefetch" href="/notes/assets/js/419.483e75ac.js"><link rel="prefetch" href="/notes/assets/js/42.cefe7a26.js"><link rel="prefetch" href="/notes/assets/js/420.56ce2d80.js"><link rel="prefetch" href="/notes/assets/js/421.b1ed157a.js"><link rel="prefetch" href="/notes/assets/js/422.04adcf20.js"><link rel="prefetch" href="/notes/assets/js/423.4ef69085.js"><link rel="prefetch" href="/notes/assets/js/424.ee6c15ef.js"><link rel="prefetch" href="/notes/assets/js/425.ae40528c.js"><link rel="prefetch" href="/notes/assets/js/426.2ff5016e.js"><link rel="prefetch" href="/notes/assets/js/427.074660ad.js"><link rel="prefetch" href="/notes/assets/js/428.2eda923b.js"><link rel="prefetch" href="/notes/assets/js/429.2a6e7e7b.js"><link rel="prefetch" href="/notes/assets/js/43.bfaf3f9b.js"><link rel="prefetch" href="/notes/assets/js/430.f0fd4c44.js"><link rel="prefetch" href="/notes/assets/js/431.4c505b64.js"><link rel="prefetch" href="/notes/assets/js/432.2a188436.js"><link rel="prefetch" href="/notes/assets/js/433.8610f4fb.js"><link rel="prefetch" href="/notes/assets/js/434.ec313029.js"><link rel="prefetch" href="/notes/assets/js/435.0c6c1f6a.js"><link rel="prefetch" href="/notes/assets/js/436.2a3487db.js"><link rel="prefetch" href="/notes/assets/js/437.d132d27c.js"><link rel="prefetch" href="/notes/assets/js/438.ff4142c6.js"><link rel="prefetch" href="/notes/assets/js/439.0c474ccb.js"><link rel="prefetch" href="/notes/assets/js/44.d3333975.js"><link rel="prefetch" href="/notes/assets/js/440.7b882d15.js"><link rel="prefetch" href="/notes/assets/js/441.ab1bf371.js"><link rel="prefetch" href="/notes/assets/js/442.134f0456.js"><link rel="prefetch" href="/notes/assets/js/443.c6393d96.js"><link rel="prefetch" href="/notes/assets/js/444.2c9b16f1.js"><link rel="prefetch" href="/notes/assets/js/445.6decb9e1.js"><link rel="prefetch" href="/notes/assets/js/446.d6fccd3e.js"><link rel="prefetch" href="/notes/assets/js/447.90f4ab24.js"><link rel="prefetch" href="/notes/assets/js/448.55d87002.js"><link rel="prefetch" href="/notes/assets/js/449.308c7f75.js"><link rel="prefetch" href="/notes/assets/js/45.e63f1fc2.js"><link rel="prefetch" href="/notes/assets/js/450.72f5279e.js"><link rel="prefetch" href="/notes/assets/js/451.26d6e91c.js"><link rel="prefetch" href="/notes/assets/js/452.3184fdb4.js"><link rel="prefetch" href="/notes/assets/js/453.9d6d9af6.js"><link rel="prefetch" href="/notes/assets/js/454.f03ce01d.js"><link rel="prefetch" href="/notes/assets/js/455.f6fbc7a5.js"><link rel="prefetch" href="/notes/assets/js/456.cb5a72dd.js"><link rel="prefetch" href="/notes/assets/js/457.83d89808.js"><link rel="prefetch" href="/notes/assets/js/458.a4761ae2.js"><link rel="prefetch" href="/notes/assets/js/459.0a453ce2.js"><link rel="prefetch" href="/notes/assets/js/46.285c38fe.js"><link rel="prefetch" href="/notes/assets/js/460.39470724.js"><link rel="prefetch" href="/notes/assets/js/461.d84eac44.js"><link rel="prefetch" href="/notes/assets/js/462.2542bb78.js"><link rel="prefetch" href="/notes/assets/js/463.9b5715d0.js"><link rel="prefetch" href="/notes/assets/js/464.f9215414.js"><link rel="prefetch" href="/notes/assets/js/465.c6571f8d.js"><link rel="prefetch" href="/notes/assets/js/466.10c3a729.js"><link rel="prefetch" href="/notes/assets/js/467.917690aa.js"><link rel="prefetch" href="/notes/assets/js/468.e4e05fb0.js"><link rel="prefetch" href="/notes/assets/js/469.6ee1f0bf.js"><link rel="prefetch" href="/notes/assets/js/47.e179b803.js"><link rel="prefetch" href="/notes/assets/js/470.109daa98.js"><link rel="prefetch" href="/notes/assets/js/471.20e17539.js"><link rel="prefetch" href="/notes/assets/js/472.de465397.js"><link rel="prefetch" href="/notes/assets/js/473.697bece5.js"><link rel="prefetch" href="/notes/assets/js/474.c0500f50.js"><link rel="prefetch" href="/notes/assets/js/475.7a0de490.js"><link rel="prefetch" href="/notes/assets/js/476.3b6c2663.js"><link rel="prefetch" href="/notes/assets/js/477.fe61522a.js"><link rel="prefetch" href="/notes/assets/js/478.b33a7744.js"><link rel="prefetch" href="/notes/assets/js/479.29224709.js"><link rel="prefetch" href="/notes/assets/js/48.f6ca3943.js"><link rel="prefetch" href="/notes/assets/js/49.574091cd.js"><link rel="prefetch" href="/notes/assets/js/5.a09c7da9.js"><link rel="prefetch" href="/notes/assets/js/50.3a0ff583.js"><link rel="prefetch" href="/notes/assets/js/51.57db0225.js"><link rel="prefetch" href="/notes/assets/js/52.0ecf5693.js"><link rel="prefetch" href="/notes/assets/js/53.1f76ee65.js"><link rel="prefetch" href="/notes/assets/js/54.abcb27d8.js"><link rel="prefetch" href="/notes/assets/js/55.2e25c2d0.js"><link rel="prefetch" href="/notes/assets/js/56.bb6f65a5.js"><link rel="prefetch" href="/notes/assets/js/57.da9a0590.js"><link rel="prefetch" href="/notes/assets/js/58.1835be90.js"><link rel="prefetch" href="/notes/assets/js/59.af675de6.js"><link rel="prefetch" href="/notes/assets/js/6.3cd82c9a.js"><link rel="prefetch" href="/notes/assets/js/60.0ef43601.js"><link rel="prefetch" href="/notes/assets/js/61.c74e9f39.js"><link rel="prefetch" href="/notes/assets/js/62.1bedfdf6.js"><link rel="prefetch" href="/notes/assets/js/63.a0deef5f.js"><link rel="prefetch" href="/notes/assets/js/64.382724a8.js"><link rel="prefetch" href="/notes/assets/js/65.89029c37.js"><link rel="prefetch" href="/notes/assets/js/66.81ca5639.js"><link rel="prefetch" href="/notes/assets/js/67.cbbb38d7.js"><link rel="prefetch" href="/notes/assets/js/68.000bfd35.js"><link rel="prefetch" href="/notes/assets/js/69.c2d07d56.js"><link rel="prefetch" href="/notes/assets/js/7.7d6ad91c.js"><link rel="prefetch" href="/notes/assets/js/70.217180de.js"><link rel="prefetch" href="/notes/assets/js/71.98765c00.js"><link rel="prefetch" href="/notes/assets/js/72.1c955ea7.js"><link rel="prefetch" href="/notes/assets/js/73.d2706f61.js"><link rel="prefetch" href="/notes/assets/js/74.60cc2008.js"><link rel="prefetch" href="/notes/assets/js/75.4b361813.js"><link rel="prefetch" href="/notes/assets/js/76.38d96cc9.js"><link rel="prefetch" href="/notes/assets/js/77.438af426.js"><link rel="prefetch" href="/notes/assets/js/78.bcd8b2ed.js"><link rel="prefetch" href="/notes/assets/js/79.f5f68b99.js"><link rel="prefetch" href="/notes/assets/js/8.d3bec3c0.js"><link rel="prefetch" href="/notes/assets/js/80.56ed8ba9.js"><link rel="prefetch" href="/notes/assets/js/81.f8dbf3cf.js"><link rel="prefetch" href="/notes/assets/js/82.e794a34b.js"><link rel="prefetch" href="/notes/assets/js/83.e2c87fbb.js"><link rel="prefetch" href="/notes/assets/js/84.1afc1456.js"><link rel="prefetch" href="/notes/assets/js/85.b7c7c05b.js"><link rel="prefetch" href="/notes/assets/js/86.f3a12e4c.js"><link rel="prefetch" href="/notes/assets/js/87.4cd44f76.js"><link rel="prefetch" href="/notes/assets/js/88.57dc2780.js"><link rel="prefetch" href="/notes/assets/js/89.f604b335.js"><link rel="prefetch" href="/notes/assets/js/9.e1f148ec.js"><link rel="prefetch" href="/notes/assets/js/90.6ee867a3.js"><link rel="prefetch" href="/notes/assets/js/91.d509a153.js"><link rel="prefetch" href="/notes/assets/js/92.dbe29fc9.js"><link rel="prefetch" href="/notes/assets/js/93.00a12f11.js"><link rel="prefetch" href="/notes/assets/js/94.b910d5ad.js"><link rel="prefetch" href="/notes/assets/js/95.f2f8c392.js"><link rel="prefetch" href="/notes/assets/js/96.846bfa91.js"><link rel="prefetch" href="/notes/assets/js/97.2aaef136.js"><link rel="prefetch" href="/notes/assets/js/98.2fc7c21e.js"><link rel="prefetch" href="/notes/assets/js/99.c571e816.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.db9e9bf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">我的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/guide/" class="nav-link">
  指南
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/guide/" class="nav-link">
  指南
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>传统锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/" aria-current="page" class="active sidebar-link">传统锁回顾</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#从减库存开始" class="sidebar-link">从减库存开始</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#准备" class="sidebar-link">准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#建表" class="sidebar-link">建表</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#创建项目" class="sidebar-link">创建项目</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#演示超卖现象" class="sidebar-link">演示超卖现象</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#问题演示" class="sidebar-link">问题演示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#添加-jvm-锁" class="sidebar-link">添加 jvm 锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#添加-juc-锁" class="sidebar-link">添加 juc 锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#添加事务" class="sidebar-link">添加事务</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#多服务问题" class="sidebar-link">多服务问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#多例模式" class="sidebar-link">多例模式</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#多服务模式" class="sidebar-link">多服务模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#mysql-锁演示" class="sidebar-link">MySQL 锁演示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#mysql-锁范围" class="sidebar-link">MySQL 锁范围</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#悲观锁" class="sidebar-link">悲观锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#乐观锁" class="sidebar-link">乐观锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#mysql-锁缺陷" class="sidebar-link">MySQL 锁缺陷</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html" class="sidebar-link">基于 Redis 实现分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Zookeeper 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 Zookeeper 实现分布式锁.html" class="sidebar-link">基于 Zookeeper 实现分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 MySQL 实现分布式锁.html" class="sidebar-link">基于 MySQL 实现分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/总结.html" class="sidebar-link">总结</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="传统锁回顾"><a href="#传统锁回顾" class="header-anchor">#</a> 传统锁回顾</h1> <h2 id="从减库存开始"><a href="#从减库存开始" class="header-anchor">#</a> 从减库存开始</h2> <p>多线程并发安全问题最典型的代表就是超卖现象。库存在并发量较大情况下很容易发生超卖现象，一旦发生超卖现象，就会出现多成交了订单而发不了货的情况。</p> <p><img src="/notes/assets/img/835e365699b348648bb17717e3b5e83a.ceef2c51.png" alt=""></p> <blockquote><p>商品S库存余量为5时，用户A和B同时来购买一个商品，此时查询库存数都为5，库存充足则开始减库存：</p> <p>用户A：update db_stock set stock = stock - 1 where id = 1</p> <p>用户B：update db_stock set stock = stock - 1 where id = 1</p> <p>并发情况下，更新后的结果可能是4，而实际的最终库存量应该是3才对。</p></blockquote> <h2 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h2> <h3 id="建表"><a href="#建表" class="header-anchor">#</a> 建表</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>db_stock<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>product_code<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品编号'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>stock_code<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'仓库编号'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'库存量'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre></div><p><img src="data:image/png;base64,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YIQ85QejUyqKYk+BCgCAJh/5AQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJAhUAQJJABQCQJFABACQJVAAASQIVAECSQAUAkCRQAQAkCVQAAEkCFQBAkkAFAJAkUAEAJAlUAABJ/w+hPVZz6jQrVQAAAABJRU5ErkJggg==" alt="image-20221227141519983"></p> <h3 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h3> <p><img src="/notes/assets/img/image-20221227141725461.862d313d.png" alt="image-20221227141725461"></p> <p>pom.xml</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.lock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>distributed-lock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>distributed-lock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>distributed-lock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
<span class="token comment">#  configuration:</span>
<span class="token comment">#    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*.xml</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.25.10<span class="token punctuation">:</span>3306/lock<span class="token punctuation">?</span>characterEncoding=utf8<span class="token important">&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span>
  <span class="token key atrule">jackson</span><span class="token punctuation">:</span>
    <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss
    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
</code></pre></div><p>Pojo</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;db_stock&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stock</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 商品编号
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;product_code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productCode<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 仓库编号
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;stock_code&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stockCode<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 库存量
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;`count`&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> COL_ID <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> COL_PRODUCT_CODE <span class="token operator">=</span> <span class="token string">&quot;product_code&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> COL_STOCK_CODE <span class="token operator">=</span> <span class="token string">&quot;stock_code&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> COL_COUNT <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Mapper</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StockMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Service</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_PRODUCT_CODE<span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> stock <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Controller</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockService</span> stockService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;stock/deduct&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stockService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello stock deduct！！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="演示超卖现象"><a href="#演示超卖现象" class="header-anchor">#</a> 演示超卖现象</h2> <p>接下来咱们使用jmeter压力测试工具，高并发下压测一下，添加线程组：并发100循环50次，即5000次请求。</p> <p><img src="/notes/assets/img/1606442946203.e704b298.png" alt="1606442946203"></p> <p><img src="/notes/assets/img/1606443124589.542ee9eb.png" alt="1606443124589"></p> <p>给线程组添加HTTP Request请求：</p> <p><img src="/notes/assets/img/1606443172072.747ffb9e.png" alt="1606443172072"></p> <p>填写测试接口路径如下：</p> <p><img src="/notes/assets/img/1606443276322.c652cf9b.png" alt="1606443276322"></p> <p>再选择你想要的测试报表，例如这里选择聚合报告：</p> <p><img src="/notes/assets/img/1606443541407.83700bd1.png" alt="1606443541407"></p> <p>启动测试，查看压力测试报告：</p> <p><img src="/notes/assets/img/image-20220313204754310.2c3b25a0.png" alt="image-20220313204754310"></p> <ul><li>Label          取样器别名，如果勾选<strong>Include group name</strong> ，则会添加线程组的名称作为前缀</li> <li># Samples      取样器运行次数</li> <li>Average       请求（事务）的平均响应时间</li> <li>Median        中位数</li> <li>90% Line       90%用户响应时间</li> <li>95% Line       90%用户响应时间</li> <li>99% Line       90%用户响应时间</li> <li>Min           最小响应时间</li> <li>Max           最大响应时间</li> <li>Error          错误率</li> <li>Throughput     吞吐率</li> <li>Received KB/sec  每秒收到的千字节</li> <li>Sent KB/sec      每秒收到的千字节</li></ul> <p>测试结果：请求总数5000次，平均请求时间37ms，中位数（50%）请求是在36ms内完成的，错误率0%，每秒钟平均吞吐量2568.1次。</p> <p>查看mysql数据库剩余库存数：还有4870</p> <p><img src="data:image/png;base64,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" alt="1606445079298"></p> <p>此时如果还有人来下单，就会出现超卖现象（别人购买成功，而无货可发）。</p> <h2 id="问题演示"><a href="#问题演示" class="header-anchor">#</a> 问题演示</h2> <h3 id="添加-jvm-锁"><a href="#添加-jvm-锁" class="header-anchor">#</a> 添加 jvm 锁</h3> <p>修改service</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//加上synchronized修饰符</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_PRODUCT_CODE<span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> stock <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/notes/assets/img/image-20221227150903715.fbe9c33e.png" alt="image-20221227150903715"></p> <p>查看MySql，发现完美解决了。</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAc4AAAB3CAYAAACKVKC5AAAaqklEQVR4nO3dfXAb5Z0H8K/iJE7Im3olJCG8GEWOiCFQNJxa2wdHrieFOG3BnVHSXjvEBWpHuSvZQHOH21KmA0XteHpWcnNVklJqaJkGPDcuN8Qm1kBoe0nAHD7Iu2JZF6YNhEsK67zagXjvj5Xk1WpX2tWLJTnfz4wGvNp99DzPvvyeNykWURQlEBERkSGTip0BIiKicsLASUREZAIDZ4k4efJksbNAVBZ4r1CxMXASERGZwMBJRERkAgMnERGRCQycREREJkzOtMPIyAgOHz6MY8eO4YMPPsD58+dx4cIFAMD06dNxxRVXYMGCBaiqqsKSJUtQWVlZ8EyT7Nlnn0U0Gk27z7Jly3DXXXeNU46K76d7hzHw8aWsjq3+TAX+pXZannM0Pr7Tex4A8G+eKxLbHn/88bTH/OhHPyponkrFq0f+gi1/+DMufGLsurhiagX+6a7rcGf1Zwqcs/y7nMpaTJZ0P4Dw7rvvYvfu3XA4HLjhhhswf/58zJ49G9OmyQ+X4eFhnD59GidOnMCxY8dw5MgR1NfX49Zbbx23AkwUJ0+exNy5c00d8/jjj2PdunVYvHix5vsPP/wwRkdHL7vgeTl6sPscAODphhlFzknhmb1XVv3iXZy/aK4xNbOyAtsfLL/n2OVU1mJKO1Tb3d2N5uZmfPWrX8Vtt92GBQsWYMaMGaioqEBFRQVmzJiBBQsW4LbbbkNjYyOam5vxyiuvaCcWDcJjtcJq6iUgNJYAgh4rhJBW4iEIVg+C6TtfOR4TgmDV+/zi0QuaADA6OopJkyZh165deP3117NKPySoz4OpoyFkfWx2ntk3gge7z+HB7nN48/1PU7alez3z7ohuutGgR7seYte19nURRdCjvsaU1102122haecpJFjhCUaR/j7UolUH48tsIAGAsyOZjpGfB0aeY540hY8GPbB6gshX9ZRyWROiQXjG+bmQb2mHaoeHh/H000+jpqYGVVVVmDdvHmbOnJkYjh0ZGcHZs2fx4Ycf4tixYzh06BDOnz+vnZjNh17RF/sjiqDHifBGEQG3Yp9oEB5nGBvFANwpCQwi3OeCY1Fq0tFgGzqaNkK0ab3ngbO1T7+QTitatbY3dUJUZC4keNEBAF6r/F8Dx5QCZfAEYLrn6Q6I6IQVXo8D/b0+aFRxSfnmTZU4Jo7i/bOjeG7/RVw/e1LSNj0LZk7CN2/WmWaIBrG2tQ9AH7xWxdlv6kS/owt9APrU14XLj/5eH3wba2BdG8TyeN2FdqDD1Yj+cajI0hiqtWF5I+BU1sGE0YROzWfVmJBgRVua922+XnSGrXAK9pJ7diTLsqwhAVYvMh4rB+c2OPp74SuDiyTjHOf69euxb98+HDhwAN3d3Th9+jTOnZOHhWbMmIHZs2fjuuuuw6JFi+B2u/Hoo48WJqfRCA6hBitTKjWEzV2N6O+VT0tIsMJ7yJ94yNt8vUjEa9VxRk9USLDC2wHoXTxycAb8DxXnwvf+9v2kvzu/fjUA4JZbbsG+ffswOjoKi8WCXbt26QROuSGTrn0BtMJp1WhiuPzobOyCN83BHVbtpobL34/ePN8lUyuAtc5KPLn7AkYuSQj+zwi+Xzc9sU2rQT61AvA5KzG1QivFEARnK2o6RWyJeODsahxrQESD8Dhr0Cn2AoIVO1aqGoIA4H4I/jYnNod8CLijCLZ1AH1IrsukxlvmB5RR4z6HGRJg9eo1K/u0r59xamz+8XvLEv/v/e37iXtEb9sdT+0qeJ7i3IF++D1OeIL5uR9KuawTRcbAOW3aNLhcLrhcrvHIj4YQBKs30ZpPtPhjN1xIaINjS2+iJRu/CNcGlysuwjSBQd3jdPmTelYhwQovOiGKbjlAWj3wJ4JtPF2XYtv4U98Ycffff3/S34Ig6KRgg69XhNy+iCLoWQts0SmPZgvSp9E4UdS5qk4L7eqZci/zmX0jOH5mFM8fHMG3bqlMbFP7xk2VuHqm9qxFSPACnbGA6O5FPzyJayu0WQ6obgAIiIBghQB18LTBt7EJ1h0hBLADrX3KwFhareyxBiLk+6KpCU0dHYl7z+Uf27dD0cNOagCN87kuro7kEQgdynrTZsPyRhdaWzcj5MtPoyn/8lXWiSFj4Hz++eexZMkSzJs3D7NmzcKUKVMwffr0xPvnzp2DKIo4ceIEDh06VIAsuhEQRTwU9GAttqDXZ5MDWBhASEAbarSHW/vWIrg8+YHU1Kl8qGk8tEICrMqxhpCANkc/xNgONl8vRLsAq+LzXP5+iL3FfUzo9TizY4O9pg9tO6PwaTzNQzs6gKbOjDd3SHCiq9GPpr4wHI1dqoZM4dVdMxlHPrqEPX/+FLtjL839Fk5G/TX6t4E7II6VNSTIPc4tO+GxtqIPADpUQ7Txv5U9KXcAohsA3BDF3MpVSO6ACDGgui8CAQSQOgyXfC+pGRnBKMyIgx71PaL+W29besaHLxMNcM1Ki2JnlzwV0BZ8CO4c66S0yzoxZAyc9fX1OHjwIPr6+nDq1CmcPXsWw8PDCAQCAIBLly5h//79uHTpEu688068/fbbGqno3Eg684XqeSQxsAg7u/pQs1G+oAbDfXA5IhC8HZA7NGPBLS4kWOHdHIIv4EZIiH221uelBF0XdkZ98kPDHUBvUqD1phzf1+qEtTV/w2vZyC1QpnI/5EebU6v1G8KODhf8/elLGg165BvHBwitYdh9W9DoSW3IGGG1WlO2iQajT6a5zbTzmgmK+fj4pqT5+thQfXhjyoNirAfngr9/C7DW4KhHnoYvizfHGR/BiN0z8V5oNAiPsxV9GP8RGuU9ojV8qXbHU2EDqR5CJAq405RDbnhFEfQATRt1zml0J7r6XPB3NqLLm3uvM1NZU4dqC11W7d5q6jYXyqXDmjFwVlVVoaqqSvO99gM+rLZ9F3fffXdi23XXXaexp3IoENAdDtRdHBRCuK8JK93ysZFDQM1KHwKib+xhpuIOiBCV/5+yo9YwmbxtLI/KB10TOkVR+/NiKyu9iV3Ht7WVqfVoOrDafNjYZE1p/aZbhDW2T3we0A0k1s3Z4OvdKK/WNPnAFEUxKXgaDZpA8nynem4z/bxmZknDmgAAL8aeA7GGlKIHl3QPJF3nhRuuzSUwhjd7YEWNgaHadEFQHi0KhAT5HLr86BfFkhzGvTg6jF9HnsQDi58EALz8j84MR7ixsskLr97iQjWXH3rtzdDmVvQ1daLX7YZd477LN/XzoKBldQcgqh++ms955bO39OU0VLv/4//Cwf69uGu+F41V38GMybPx8MMPY2hoKEOqgwj3AQ6juQztQIfLgYcSx8pBNO2K2VgrdzDlAaeidTE4rWh1+dGfFOzjeRFgbVOtMFX1QMZbvnucQLzXqeglhgQ4W2vQKeo3CORg0oROUWuOy41AfwQepxXhtMN8qeLB00zQjFPOdyqlm9c0Kj7UmNTjjD0UMh/sgMYC8aJLrB6PD7VlMVS7U7CiVeue60tdYDaew7V6jp+LYEt4I46fiyQCpxHaDfIxeiMRqp3QphjFSbnv8mmrRf5vi+5X93VlW1bjw7ZycNabIio1OQ/VjkqX8NoH29F3aifuvX4d7prvzZAi0qyQ1RFbmegU7Oh3yL2eACB/90mrd6eYq9Q/4fo9TuW21J6FrJgrBNX0epw5BVSbD72dYVidHqCzEV3eQ/D39+oMIcV75xmGrG0+9PYDHqcVHpMPzGyCZlzdNZNTAme6ec1CC21uRV9Np2bPy9DDtlD5Eqxoc/jRhC44clghvjwgwpfSyVCVKxqEx9mFxuXFm+Ps/PrV2P3hS/h15ElcHB0GANz/x6W4YvIs3DTrb7ByfgvmTLlSlZKx+VvFJ42NRKQsnIoiuDbW24xvtPmwxd8FZ2yaKRt6ZcVUK3BRBE6+Bcz9a/nN178Fyy1+SBXTNVLKvawTVU5DtUpnP/kYv4n8GK+9vx1fnrcON876vO6+0Z1d6GvaaGIcXx7msgtWOFuBpk5zF5Re8AOgOcepHGdPDrw63z+F/GBYW6Q+RCF6nAAAdwD9fg+c3la4/P26LeCQ4EQr/OgXfUDQA6vqTlN+HcXl70evaIdgdcIaLq8FBFF5jgA2AIPZpaBoYGiXW56/N3Ydff/3F/DhueT52/gvCH12ugU/XSb//J7eXKd6KFeeowpBiN0Q6vtGb1Vt4iGpqJ/05ICBNNdUvpmZ4zz/6Rm89XEPBs6+DcG+TRU81dNO+jI1gqLBtfJ9o3rf5tuS09dTdMta9WXg6K+B0Crg718ArnIB4Q7MOPEmztf/CqOzb1SllHtZs7tPSl/awHnzzTdnXFWrJkkZhgGiQcj3jNkHpjy3CQAdXg8c/b1YbvDI7OY4UyUChEbWB02NPedX3uc4gViPoBV9Lj/6xY3YbHXC2qo9n6WcT0bS92ZDEKw7sDKlF2qT577M56oI5IcHEEWwrU9/gYeeaASHIF8aygbGWBWq549c8Bv8dYT7bp6K9reG8alq7dMkC7Bm6diip2znOpX3Teah2iiCXUbrx/gDudDq592Dqpk3IXjku3j//CCeuWM/Bs/sw88PPYKPL57AyyeC+Ma1j+kcHWsI1ZhvAMrTTDU60xo2+Lb40eV0QrCbm9ZIy/UT4P3XgTPHgK6xjk3F0GHM3LkMw7f/DBdv+Ae9HGdd1okobeD0er04fvw4BgYG8MYbb+Cjjz7CmTNnMDIykhiqjZs+eRZWzm9G7We+gkkWnRUXsS9IN3WKJluasdV5TZ0Qe91yOmuDsDcC6FAuylDI9IUixQNtjBsBrZ5A/Ivd8c9PTSzW2C7O2Hw+e5xj88byYqh4aQOiiEA0CE/sAV8Kc1PZsljMHxMSYg8N3WdGBEGPVx7Win1dJ/HDGJ2N6HJ60Ngvai6syjR/pMfx2Qp8raYSvzmQPAy9eslU1FyZ5aqnbIU2yz3pEnym3nrNrJQv+d/xVDixKGYm5mK9bSv+4/i/YmhoCFfietx//VP42cD9OHB6d5qU5QbA8qAHVusOwyvrx9YC5H9aI31ZZ2DSF0Oo3PcjTPnzDlg+OW0ozViGsiorAN1ntNZK23L5HmjGodqFCxdi4cKFKdvjC4AmWSpQ+1dfwYp5D2LG5Dn6CSW+OC+aXGodRdAjfwk98dCKfS8uGuzKOMeZmpZizF45t6Cb51jAVD3ZUoZ/06yaK6SjR4+m/b1a5X7pxMvj8vdD1Fs2q1gEJf+GLUryZwbTsVmNfAVFJSTEfo1qrJxJ3+8EANhTelGDYSR66D5xOYIeK6xG5otM1Old103G8TOj2PXeJ7G/p+CLVVMMHauW9AtZJttEoR1ygzgp16pfEjI7xZIvP76nOuM+UydNw9ev/V7i72umy/fU8KWzGY9V/jpZ8nMh9atbiV820+xppiRselojU1lHp8/Hhc8HcSHW4Zyz3YrR2TfifP2vcGnOkozpmykrYK5RmOnnCUtJ2n8dJZOt//sI7lnwHcyflnkOlNLL5l9HMfLPiinZbDasWbPGbNYmhO///gJWLpqC2msmI4sOZ0kblYBNbw1DAvDQ7dMwWbVY2OgcZ7nI5l4hbdPfXIfh23+msziI9OQUOCl/+DAgMob3ChVbbl9kIyIiuswwcBIREZnAwElERGQCAycREZEJXBxERERkAnucREREJkwGgDlz0vxwgY7BwUEsWlSK/76DvnLMMxUer4uJYXBwEJfmXFvsbJS0iqE/8VrPA/Y4iYiITGDgJCIiMoGBk4iIyAQGTiIiIhMYOImIiEzIW+DsabHAUhdAJO1eEQTqLLC09OTrY8vY5VIXl0s586OnpVTriueRKC5PgTOC8P78pERERFTK8hQ47RD2SJD2CLDnJ0HKWg9aLBawY1AorF/K1iv44dxK/PDVYueDcsU5TiIiIhMKO8fZ0wKLxTL2ank5Xx+XF4k8RwKoS8pnj+Z+PYE6+X1lOdXH6vVGMtaF3JOpC0RUh2nNHcv7JtKKvR8J1MFiacA2ANsa5PfU6aWpDc00E/JWTp30Ms6Pj6fkuoiXM2P9Gq2jTHWt3LOF5zE3ci/PEX+t2Iz3lG9HN2O18v2UHqF8/OotyaX6wyPKtCLoWFEJxyOv4L0tf6tIax3+ENtf3n4PXgDwwtfk99VpUvkoXI+zpwWWhm1o7pYgSfKrGxuwYW/BPjE7ezeg+j7guVgepYF21G5rSF0EsXcDGg4/Ju8TH5LuaYGlegOWKsooDbRjf4PqQZfPuuhpgcXSgP3tA2Of+Rzwcg9gF/ZAkrrRDCQ+a49gYPA8TZqJ9/NZzp4WWKpfxKqB+H4DaMcGVJfEQ7cHLaq6uDcs5ytt/Zqpo3R1rRAJ1KFhm/xZPI9ZeHUdHHPvQfiJgwifHJFf/w7selXx/uc3wrF9ZOz9N9sQ/lqWQe25e/DP+GUsrZewGr/Etx95BQBw/drfx7YBq2Of98JaTmyVLVEUpWxEIpGkv7ubIaG2XRqQ/5KaAam2fUB11IDUXgsJzd1ZfWauNPOMZkmdm4H22qTt2vvplVF9vNG60N4vuV6N1J+cjvEqzpRmvssp/53ycQPtUi1qJY2PKbik62KgXapNW39a9Wu0jjKfv+7m2PvdzRJ00tTG8xiJRKTwyZHY66DUejsk3PeSYpvy9ZK0GpA+98TBlPd6n/iCBDwg/SLNfr+4DxJub5N6lZ+V+FsrnbG0Vm/Xys/4vNTPQMpOYXqckTD2A1jqKIMWVe0SVKs22R1LAexHOJJmvzRlTDo+n3UReRkv7gWa712Re1pG08x3OWOfFx/qTLyqN2Av9uLwQI7lyZX9S1hVG8uf0Z6T4ToyeP72P4G6hm2obR8w1tOEgbQvt/MY7UbPfwOrG+7Wef8owgAc1anlvL76JgAHEY2a/MyaxbjebD6pLHFxEBWFchhQ+dqaxzZBdmIrxAfaUbt3A6qLOG+398WXS2PIM43SPY9EhVOYwGl3YCmA/WH1bT+AwyU3x3kY6sZxz++2AbWr8KV0jW7dMgKR8H4AS+Gwp9tPXRfVWFIL7E3XVE/zmVnLlGa+y1mIMhSCXcAeSYLU3Qzs3YC2dF8/ybmOVJY+hj3xwG30ey88j8lsi+EAEB7QyV+a998bOAjgJthsAGCH7XbgHb106LJUoB7nCtzbDOzdcB+S1xzIKxJLyzY0KB9OPS3ygozHMn0ndQU2ttdi74bq5FWJPS2o3rAXzd1bsSK2n7G6sMOxFMC236FHkVZD0k76n6l+vhp/oGVKM9/l1EkvEkBdKXw5MhJAS8oK1losUY3nJ9ev8Toyev5gF+TgqbVQTRPPY7K78cATX8A7j92UvEr21XWxv/Xf9zz2BlZv/znuBADYYasB8Nx/JlbI4tV1+PZz2edMN5hT+SjM4iDFNoy9mrtLcHFQbbvU3V6ryqekuZ/meofYIo6xl/bCCGN1EdsW36+5W/uz1Z+ZmuHEe4YXl5hIM/dyxhekKPbVq99xoL1oLE059erXYB2lq+vE4iD1vkbr5zI/jykLYrY/kJw/9WIh9fv4gtT6pnpRTWzxjyINzcVBqrRTFwclf57WwiQuDioPFlEUpTlz5pgOuIODg2X3L4mr89zTYkHD/nYM8BePLmvleC1TqsHBQVyac22xs1HSKob+xGs9D7g4iIiIyAQGTiIiIhMYOCc81U+wlfTPo5E+nkeiUjG52BkophVbJUjFzkTBrcBWScLWYmeDcsTzSFQq2OMkIiIywSKKonTq1Kli54OIiMYBV9XmbjKArJZwl+Oy5qGhIWTz1Rua2HhdTAxDQ0Ow/uSDYmejpImPLih2FiYEDtUSERGZwMBJRERkAgMnERGRCQycREREJjBwEhERmaAbOB1zK8czH0RERGUhbY+z3IJnZFO9wX+70OSxPS1JP3FWv0njB86M7JOHfNI44TmncvK5hZD8NyZeA57yenaXm4xDtWURPCObUG+xoFrYk/9je1pgaTiAwIAESZIgDQQAoTr5IWlkn1zzSeOH55zKyecWQlo9FZs2HYGl9Qgsm/4CLLuBwbOADM1xlnLwjGyqh2UN8Kwkobs538dGsOnJbUDzD7A+/g922tfj2UAd9ry4I/bD2kb2yS2fNJ54zqmcVCLwd7OAg3+BcCK26cRJrNk1AvvNs1FX1LxNXIYXB5Vq8LSv3w1p9/qs/iHqjMdGduDFPUDzvSuSj1t8M7DnReyIGNwnx3zSOOI5p3IyfzZWzgV6DpxO2rzn/y4Cc2di1fwi5WuCM7WqtlSDZ2HVoaZatam6RtWSM7IPlQ+ecyonIzh6QrXpxEX+U3MFZCpwhk+OFCofpWngEPRnpvbg0IDBfah88JxTOZk/Nc2IRiUWs8dZEIYD52UXNDPS6HFktQ+VD55zKicaPVHKC0OB87INmtU1qNPqQSh7HEb2ofLBc07l5MRFRLR6lml7opSrjIHzsg2aAGBfiVV1wIGjybMFkaMHgLpVWGk3uA+VD55zKicnTmPHSaD6quT1J3VXTQVOnsWL7HEWRNrAeVkHTQCAHet/0Iw9whpsGvuOAdYIe9D8g/hqSSP7UPngOadyMgLhtTOwL7sagXivc/5cPLusEj2vneQISIFM1nuDQTNmxVYMBOpRXW2BENvU3C1h6wqT+1D54DmncvLOcdRfdQN2r78R62Obel44goZ3ipqrCc0iiqL04SfTTR9YMfQnLFq0qABZKpyhoSHMmTOn2NmgEsPrYmIYGhqC9ScfFDsbJU18dAGv9Tzgv45CRERkAgMnERGRCQycREREJjBwEhERmcDASUREZIJFFEXp1KlTWR185ZVX5jk7RERUSFxVmzuLKIoSK5KIiMgYDtUSERGZwMBJRERkAgMnERGRCQycREREJjBwEhERmcDASUREZAIDJxERkQkMnERERCYwcBIREZnAwElERGQCAycREZEJDJxEREQmMHASERGZwMBJRERkAgMnERGRCQycREREJjBwEhERmcDASUREZAIDJxERkQkMnERERCYwcBIREZnAwElERGQCAycREZEJDJxEREQmMHASERGZwMBJRERkAgMnERGRCQycREREJjBwEhERmcDASUREZAIDJxERkQkMnERERCYwcBIREZnAwElERGQCAycREZEJDJxEREQmMHASERGZ8P8zcoVaLMtj1QAAAABJRU5ErkJggg==" alt="image-20221227151058079"></p> <p><strong>原理</strong></p> <p>添加synchronized关键字之后，StockService就具备了对象锁，由于添加了独占的排他锁，同一时刻只有一个请求能够获取到锁，并减库存。此时，所有请求只会one-by-one执行下去，也就不会发生超卖现象。</p> <p><img src="/notes/assets/img/1606448189738.245ca573.png" alt="1606448189738"></p> <h3 id="添加-juc-锁"><a href="#添加-juc-锁" class="header-anchor">#</a> 添加 juc 锁</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_PRODUCT_CODE<span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> stock <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                log.info(&quot;剩余：&quot; + stock.getCount());</span>
                <span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>原来和上述synchronized一致。</p> <h3 id="添加事务"><a href="#添加事务" class="header-anchor">#</a> 添加事务</h3> <p>如果添加了事务注解，所添加的锁会失效。问题发生的原因主要是：<strong>@Transactional注解的底层还是基于 AOP 思想来完成的，前置方法里开启了事务，然后进入到调用方法中开始加锁、执行业务、释放锁、然后才提交事务，但是在提交事务之前可能会其他线程已经查询到库存，导致超卖。</strong></p> <p><img src="/notes/assets/img/image-20221228095211151.e66feb3b.png" alt="image-20221228095211151"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span>READ_UNCOMMITTED<span class="token punctuation">)</span> <span class="token comment">//将事务的模式修改为读未提交</span>
</code></pre></div><p><strong>一定不能这么做，这样会发生脏读、不可重复读和幻读。</strong></p> <h2 id="多服务问题"><a href="#多服务问题" class="header-anchor">#</a> 多服务问题</h2> <p>但是上述的锁仅在单例模式或者但应用部署的时候才有效。</p> <h3 id="多例模式"><a href="#多例模式" class="header-anchor">#</a> 多例模式</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;prototype&quot;</span><span class="token punctuation">,</span> proxyMode <span class="token operator">=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span>TARGET_CLASS<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_PRODUCT_CODE<span class="token punctuation">,</span> <span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> stock <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                log.info(&quot;剩余：&quot; + stock.getCount());</span>
                <span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行 Jmeter 发现库存还剩下4904，明显不对。因为ReentrantLock和非静态方法的上synchronized都只是对当前实例有效。每次请求都会创建一个新的deduct()。</p> <p><img src="data:image/png;base64,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2v9j07GynwDvH6/wA+Be8vjQTmwQxhy+6VLizX2yP9ilqCslfGS37A/2FbfU4QqHH95VlidzpNbf5ep1AZ3A06ucjghOsuPqtywFR6f8PzYdkxWZVSJjy7Zt2ZmENBos/xLykqfZdmLjMObwUfjIUxrpWbs/emyfrg88VOzULVmnbsmafKDBYVdwcniX7OFtGh938ozflwZ2Vw1OqtUFdArPc0xMDk6y4/2yTkjnbFupBm8R6h+b1fj7SSn6rkYCzq7AiM4lwpq6dMX5j9O85GmundhIjDl8tLNH5wak9NyyK2G7jh6Q0pN3lVzZdeOuYnPS4As9CkuSupR44TFp7r5GF508i0s6cW1ZgYPbnTxe6gI6R0OTX00NTgIj12VfH1GgftbGj81e0aUpKXp0sPy4vQelqUu6kvWYp8l2YgMx5vBNlxJ//K107d96/ydX0s4uBbWs24vlu5OzD6SebTooSTu366UeKT37c1meqZ8eSj2/0dBOj3UBHaThVTmmBietFdb+oGtXcL/rbsVLHnQOxhzNix7brRHd14mvqj3B6NLeneV7wju2ufKsDV60+FDu2Uz16wI6Q8OByfzSFrvoM9+p+syAKX2X8ZgHnYMxhw/CR3Zr4sADxT5aqnytLC7p7Jw0OFwySXVnj84NlNz87dxW42nbalBTty6ggzQUmGy5oKSuCnfM68qDzsGYw4PDu3R9QBofL5k/UkHywi3F5h7TxMqKm5FtOjv5wGMlzpMUj3UBncJzYLJlg5LgfoUr3QGX3jF7yYPOwZijKc6EVXVpZGR1ie/1gS5JThBybHsxd/KCs9rm1C1Zp+5qdsc2aemhZiXnlc3a1z2rT1IaqwvoBJ4Cky0blEhS4CUNhaXZ2+VvdLO3Z6XwkF4KeMyDzsGYoynLGv2oNNgobP3XliU9KCwNvvBzlWO7NHSwS+mvnVcyiz/rypIU3FE+ty+8Y5u09F9dWmymLsBMdQOTLR2USJICGnk3qqnRExpfXQOqE6NTir67strCSx50DsYcGyN6bLcSxachXUq8WZjA+v6NlX3LGv36gQIDT63mc+ahFIMXYJN5tFYiQYljcEKZRL+CQUujzq5oytbEYIN50DkYc2yA5IX7Sn2wT7bzOXvtX7Lcq2pu3FX/jt26PrJPI86u9OQtRW4I2JSsXC5nS9J//vfrhg9+JP+Dent7fW9UK+XzeXV3d7e7GTAM18XmkM/n9fiHP7a7GUbLvfMk1zqMxv8uDAAAjEFgAgAAjEFgAgAAjEFgAgAAjEFgAgAAjFFclXPv3r11FfDEE0/42iAAQGuxKgcmKwYmXKgAAKDdeJUDAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACMQWACAACM8X9uktpbHldIRgAAAABJRU5ErkJggg==" alt="image-20221227163240312"></p> <h3 id="多服务模式"><a href="#多服务模式" class="header-anchor">#</a> 多服务模式</h3> <p>启动多个服务并使用nginx负载均衡，结构如下：</p> <p><img src="/notes/assets/img/1606453095867.aa1a56ad.png" alt="1606453095867"></p> <p>启动两个服务：8888、9999。</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAiAAAABeCAYAAAAaPq+EAAAbj0lEQVR4nO3db5AbZ30H8O9Ccqk5uyFOGnNXiol9Wl9pzik4MKxCp40noUhxJm5mbExo5lKaSpO+oNWO8fTNZTK5FxTPjUT7pkiE4CMDTX1T90Iu2jROXGiC1EIMrc8d5N2zjWG4q4Nrg30XOw7x0xfaXe1Ku9Lq3+p8/n5m9OKkZ599nmc1t799nt+uJCGEwFVFYPHyeazuu7HXDSEiIqIWvavXDWjW6wuv4sgb/9nrZhAREVEbrqoARD97BP8x/wpO/upYr5tCREREbbgqApBfX3kbxZ8fxL+enMIV8Q7OXnoDS29f6GmbtKQEKZqB0dNWEBERXZ18A5CFhQV85Stfwblz53w31nUdX/va13Dx4sWuNO7i20uY/cX38czRv8MPFr4LK11FCIHTSz+vv7GWhCRJlVdHgwUDpdmOVdaQlpTcfZEkRDMMfYiI6Op1nd8Hi4uLOHPmDPbt24dHHnkEN910k+tzXdexf/9+9Pf349KlS1i1alXLjfjFmwv4+YWTePPXi1i6fAFvX7mMc5fO4JdvncE7V97x2WYeG9477PmZkYlCVkeQFwIx600tiWjGQCEVabmdFRGkCgKpDtQUmJKGXkghAgBGBlFZRhR6h/rjRUNSigN5gWyscWkiIqJm+AYgkUgEO3fuxP79+2uCEGfw4RWcBLWw+FP8+89e8JzNWNP3Xgz0f6Dm/evffQPefuctvPXOJZ9aNUyoRSjpSbjOm7EsCivlRBpJYSyhIl6aA9CtAISIiKh76uaAyLKMnTt3YmlpCfv27cO5c+c6Fnyc+OWP8c/HvuYZfEiShG1Dn8WDm/685nX/0J/iwU1/js2/9bG69RdLc3U/t3M4jAyizuWNpOZZTstEXUs57hwQA5loeVvDKidJkKQktNodVy2laPa2wfksAVX3RZLgWW2DcuU+xJEDkItzyYeIiDqvYRKqMwh5+umnOxJ8XPz1mzj4kwO4IryXVz544ybceN0tmDyQx1effa7mNXPoe3jvb9ziU3sM2xMAcvHGJ/WiCnkUmBQCQggIPQ3Fa7uiinhprFzGWgbxkotjFJPlciKPBHKIO+oyMlFI8RwSeXN/QmCsFIdarN/MGtoE1GICeefaiJaEJKsYcdQt9DRm41XBQ4BykVTBbD/stnZvqYeIiK5Fge6CsYKQixcvth18AMCPz/wQb/3aP3H1YwN/hKP6CVy+/DYA4OabbsS2rXfZny+8cQYLb5zx3T6WFdDTSjkI8ZjVqEgg7wwoIilMphUgN101c1F1svejpDFpn6hj2O2qy1oa0l05FbGsjrTSuGoUVcjWjEU8ByW927HEpCEZz9XUbfWnqE7YbQhWjoiIqLsC34YryzJ27drVdvABAAtLP/X9bP2NEdx0/TrM6scBALdv2oj77r4LA7fegl3b7sHguvLMx+Gj9Z8FUr6KF8hbsyFSFDWrCMowhqq3Gx4BMIuSUb+cp5Fh/9kRo4RZACPDLc4kKGno1oyF0LFjSq4sAdWp29WfoOWIiIi6rKnngAwNDbUdfADwvbMFAD42cLc9+/HB9w/gY3d8CCd+Ws4TOTV/Gn/8Bx9H/3tWNZwFscSy5RN2WilClT1yMq5KEaTGEkBxCjMMGIiI6CrUkweR3fqeQc/33/+bG3Bz34A9+7HxA7+NuZ/8DMfNAKT4w1m8eekS1g++D0DjWZAK84RdrVhCdaqqNp0DlB3Y1umUh8gwRgDM1kwxzKHUbA5I4LoBozQLYATDkSbKERERdVlPApA71n0cq657j/339e/uw+/85kb8/q3uZAghBCRJwsIbZ/DVZ58DAEgArtT9/TwNyZrlFgOZ8RyQ2O6+NbcqSRRaEvEckBirk2jasnJybFEdhTsntHy3SXPM/tiBUjnfpKjK7rtetCRktYhEPmv2O2i5Cq9ghYiIqF2+zwHpplXX9WPXh/4SJ375Y7yv/wP4rfcM4F3Su7B4+TwuiSWMyBtx+GgJcz/9Oe6966N44//O4X9/cRa/u3E9brjhBvxs4TQAYMvtmzxqjyErgKQkQXK8q6R1iOo7OZQ08sPjkKS4/Vaiiw/eimUF8pAQlyWo9v50pGdl+29fRRWy5CiVyEM4GhpJFSCGk5DikiOgUZDWBZzdDloOiCGbT0CKy5DU8vjxThgiIuoUSYi60wldd/mdt/CTXx3D8V/+GL94cx7vX3MbPjFwH/5x5iAuX34bvydvwJ23D6Ov73qcX1zCq9//L8y/cQYDt97iujOmWVpSQnzW8XTRnjGQicpQR9wBBRER0UrWkxkQp7533wB57WbIaze73rdmQf5HP4H/0U/gN27ow6W3Ltufe89+XIWMGUwVgcQYgw8iIrp2LNtfw71d3oC+vuvtv53Bx8Ctt2DgVr8HkS1fRiZa9URRDUlZRVFJYzfjDyIiuob0fAbET1/f9Rh9MN644FUkkipgLClBcianJLj0QkRE156e54AQERHRtWfZLsEQERHRysUAhIiIiELHAISIiIhCxwCEiIiIQscAhIiIiEK3ogOQ42dP9boJRERE5GFFByCPv7wXT73+LSxeXup1U4iIiMhhRQcgQggcOv4a1BeewKET38NyeuSJlpQguX6StsuMDKLRDPjbtkREtBys6ADEsnh5CU/94Jt4/OW9bSzLaOVf2G3y5R1jaJjOAYntQZ6AaiATjcL5BHct2WC/NTs1kBlVgR3bEGm4fRIhhkVERHSN6smTUBcWFvDcc8/h05/+NG666SbPMrqu49VXX8VDDz2EVatWtbSfh/7pL2vekyQJd2+4C7s2P4DVff0t1VtDS0IaH/b/ZV0tCSmea75exfy1XiODqDyFHXoBqRZ+uldLSoiDj3wnIqLloyczIIuLizhz5gz27duHc+fO1Xyu6zr279+P8+fP49KlSx3dd0+WZWJZCCHMl460Aihp3fGez8sKaCIpFPIjUEebX0Jh8EFERMtRTwKQSCSCnTt3YmlpqSYIsYKP/v5+PPLII74zJO1qeVlGS0JqJ5dCm4BaTGDMOZVhZBBttPQRy1YCksD7SjqCj9qlHCIiol7pWQ6ILMs1QUhYwYfT8bOnQr1bRpvOQUnvRtD5CGe+RlILkP9hvqIZoxy0mDMfRmYU6shYS0s4REREndbTJFRnEPL000+HHnyETksinqua/Wgglq0s21T+Lr/08loOdI/lm4JzH1oSsjqCfDYGIxNtHMDwbhkiIuqynt8FYwUhFy9e7EnwsXHtejx5zx48eudD7SWlFlXIdU/kBjLjOSCxHbHqO2pkFUXkEG/qbhQDM1NFJMZS9p0tnnfcGBlE49Z+gUiqUJtrkk8ASCBfnXtCRETUJdf1ugFAOQjZtWsXbr755tCCj9V9/dh1x3bcfVt5RqBt1h0rPh8bmVGoRQAjABBDVghkKx8iKpcwJrKBl2bKSyp5CHODWDaPaSmKjPNOGSODqKwCitJan4iIiLpkWQQgADA0NBTKfrpyG24jRgajKpBIKGjhZlwPGibUEeSFM1yJIZufhjSawTYzENImVIzkBXaXopBLHdkxERFRRyybACQMG9euxyNbdmHj2vWh7tcZCOQ6EAhoyThyAHKSdzgzmtmGQiqCWFYgBsBg8EFERMtMz3NAwrC6rx+PfvSzePKePaEHH0A5cbStx3BoE1CLwGzJAIwMxnOAK2fD+dLTwNQMk0iJiGhZW9EzID1ZbukwIxOFrBaRyOeBuAxpqnzXi2+SaCSFQiHMFhIRETVvRQcgnZvxMJCJyuUkUpMsqTWlvN6rTU4tIRONu+qyxKuXVJQ0XtoBJPLmDIoQ2J6UvPdTLVH/6adWYOMsz2elEhFRWHryWzBERER0bbsmckCIiIhoeWEAQkRERKFjAEJEREShYwBCREREoWMAQkRERKFjAEJEREShYwBCREREoWMAQkRERKFjANKi42dP9boJREREVy0GIC16/OW9eOr1b2Hx8lKvm0JERHTVYQDSIiEEDh1/DeoLT+DQie+BT7QnIiIKjgFImxYvL+GpH3wTj7+8N7xlGSODqCRBkqLIGN2uW0NSkiBJEqId31mHaElIkgRJSkILd8fLfGys9pnHspvfm2ph7ouIrkor+tdww3T87Ck8/vJe3L3hLuza/ABW9/U3tb2WlBDPeX+mpHUUUhHvD8mD49eLG/wqcLg0JKU4yodZQVovgIe1i44cRuTrC/af4iNbMPfwQO/KmE4e/A7ufWENcl/egq1NdoloJeEMSAd1a1mmqMruq/tICgUhIETAE5g1QxDNoOHFaLN1t6KZ9qwk2jQqMWYRUzMh975bx9breIbxParHDAj+5M+2wchsg/E3Edx++HUMPbPQmzK2Czj4owvAlkEGH3TNYwDSBW0tyyhp6EJACAEhdKQV64Mc4i2esI3SbAtbdc9ya09YtGlz7kMpH9SiOhHyklF3LMfjeei/5yEGInhss/nGuk3I3LcGODyPQz0oYzs9j/z8Guz5pPfsCNG1hAFIF1nLMq3fLRNBqiCQT5h/Fqcw47uWX8lHsF6JvIFMVIKsFs3tVcjmlaruKJ/UKrkC6YP11+6NTNSxD2fOhbM+j/LRDHT4t6fSjaSrD16zJP5taFL1vvxyOezxrrySfjt11ukqpKEcfyjYMTmG8iHNYdpVjzunJMhY1y/n14+qY1unf+66q/tV5/vlt6+GY16us7m+XUBu7/MY2nsMJ813bnvfGu8xGFyN23pQxnLoJR1HBwdw7zrvTYiuJQxArgKx7XYEgtKcVwlnbkHzcvFg2xZVuXKyKW/Z8qyMFyMThVSdCFNUITv2oSWl2jb4Jc80uy+Yy12OwMHIRCHJKoo1Jb1oSFp1VuWeGJnx8hgrO7AtEoN1SHPT3qfUoGPd7jFp1L+5kscnuXhLSbdBx9w2NVrbN9/Iz+22e7dgD3T8wxHzjdPHkHoB2DO6qRI4hFimbAEvHgZu//BgTWBCdC1iANJFG9eux5P37MGjdz7UdFKqy9AwrJWY2ZLXFXoJ5UnwBPL28o1ALl6eQdGtdRxreaeQguzc3l72KUD9YJ12OJaH7DqtWZkAJPi3JwINE+bJJpGvWoIqqpjQABgZjFvnr0TeY5kqICODUevEZtfjaFdu3L4DyGqTa2lMT2PYo1otaQZyShq6K/HVwMxUuR5lxzZE4Agqc9PeV/VBx7qtY9K4f7Fs5fskhIAwp+OKUzMw6hxPuXpXgce8olgcsb/P9iyg53itQWLP/Zjb4zzhL2JuHviXr88gkppB5G8NHK3ZLswyAI7M4wAG8fl7fWZMiK4xDEC6YHVfPx796Gfx5D17sHHt+vYrnCvZV6gjwx4ZfZFhjAAAcoi3cFtoYiyFIHmCznKRlLWM4Dcr0yRHgmYubk25m3eywAy87HFQkN5tneAjSI0laqqry7Med5+mZgxHmxSkJx1jFEkhVX1jzdSoeRdTVVkAMGZgxh+V4xfbbi/DjHscq6Bj3dYxCdK/6uWZFmabAAQfcwclvRtWycosYBAXkNv7Og5gENmMmRia+UPsGbyAvV88bOZlhFnGLPfiPJNPiRwYgHSQJEnYuvETSN/3BLZuuAuSJHWkXit5EUhgu+cdpTFkRR7Of9FFVe7usynsWZeVyTPQq6MImLNUtSd/Y2bKDiArwVVl2as8m1BH0LHu9DExMojKKorOmTU9jWYnnIJqdsx9nZ5Hfh548HPO21zXIDEq43bM48UjIZdxtukOJp8SWRiAdEjHlltcygl51kWn84qwVgzZqmntmhNbsYR2Jity445cjAnVvqIdHqoqN11JUrSWHjw52+NYZqoswVRehVTEUcZ5tWwgM97kVbmjHnXCme8xbs8IDA/5l4OWrElCVXZMYtIc91zcnRw8oTbIIPFYMgk81gHLeWrQPztwUoZhVVfZh1c/6ny/go75CnXyyAKODsqVO2WICBDUks88+5j4zLOPib84sFu8cvw1ceXKlbbqyycggDqvRL5SWE8LBRCAItK682/3S0nrVuXuz5S0OCbyImH+7ay6pm5HuUbt8uqDoij2PvVKwZr26PXGwN5WF2ml3jglRL5RuUb7quqTnlY8y5SLVMamPNbO/ZptcfTVNc6usba2DzrWzZar/p5Yx7ZB/6qPk+cx8fl+eewr2JhXxtD+/rr2YR1jp/Mi+6Vvi41fKokT5juvfMP9d2/LzIsv/NW3xQMvna9pOdG1jDMgLerWckstc/q7yad5up6eGstWkvjaoKTz7oTPqjs9Yll3QqiS1jG5w6Min/bEso6kRKeRYTM/IYJUQa9pg+c2DcSylYRKp0TePdaRVMGjnN9SWASpSWuJIoe4lMR4veWzSApW+kpRnUDe8VGjsW62nJ+6/Ytl3WObyHuOWdDvV9Ax74StD9+Pgx9ewCdTZmJo6rvYO3CnK1E1tDJH5nEAaxDfzORTIidJCP6KWiuOnz3VmQRTIlvldur6j98PWo6Wg0PPPI8E7vR9NDvRtYozIC1i8EFEDZ0+hr8/zORTIi/8MToiom5ZtwnTX97U61YQLUucASEiIqLQMQeEiIiIQscZECIiIgodAxAiIiIKHQMQIiIiCh0DECIiIgodAxAiIiIKHQOQFh0/e6rXTSAiIrpqMQBp0eMv78VTr38Li5eXet0UIiKiqw4DkBYJIXDo+GtQX3gCh058D3ycChERUXAMQNq0eHkJT/3gm3j85b3hLcsYGUQlCZIURcbodt0akpIESZIQ7fjOOkRLQpIkSFISWrg7XuZjY7XPPJbd/N5UC3NfdWlINmxDmGWIyMIApEOOnz3V1rKMlpTMk2jta3me3JYzA5moOX7JcEOS+ioBS+9PzCucHQDFkUMRquwx5mGWaeDkwe8gkpqxX3uO9LaMs+zQXx/GoeBdIQqMAUgHdWtZpqjK7qv7SAoFISBEAYF+id2aIYhm0PB/YrN1t6KZ9qwk2jRy9h9FTM2E3PtuHVuv4xnG98i/QUjKKooAkMhDCIF8AgCKUEetNoZZpr5DzzyPe19Yg2xmG4zMNhh/NoB/+bo7MAizTMUFHPzRBWDLILYG6AdRsxiAdEFbyzJKGroQEEJACB1pxfogh3iLJ2yjNNvCVt2z3NoTFm26HH4oSvmgFtWJkJeMumPZHU870Esgn40BAGLZPMpxgYoJLeQydS3gxcPAg5/bUjnJb96C7EcEDrx4DCdDL+Nweh75+TXY88mBRp0gagkDkC5qd1kGiCBVsK6oABSnMOO7lu+c3i+/EvnyUoSsFs3tVcjmlaruKJ/UKrkC6YP11+6NTNSxD2fOhbM+j/LRDHT4t6fSjaR7Ccoj6PJvQ5Oq9+W33GWPd+Xlu7LjrNNVSEM5/lCwY3KsfIJCDtOuetw5JUHGun45v374LSHU9s9dd3W/6ny//PbVcMwry2dN9a2hIQybwfxsyS+MD6PMBeT2Po+hveYJ//R56FiDoXXuUlvvGATmF8Mv43DoJR1HBwdwb1V5ok5hAHIViG23IxCU5rxKaEhKccf0fnNy8WDbFlW5crIpb9nyrIwXIxOFFK9qSVGF7NiHlpRq21C9Tav7grnc5QgcjEwUkjXF3pCGpFVnIg9hXhGX6xkvj7GyA9siMViHNDftfUoNOtbtHpNG/ZsreXySi7eUlxR0zG1To7V9C5LTMzQMxSxvD68xg6lij8o0dAFzp93vnDx9oYdlAGu25PYPD+I2/4YTtYUBSBdtXLseT96zB4/e+RBW9/W3XpH9T87nqssooTwJnkDeXr4RyMXLMyi6tY5jLe8UUpCd29vLPgWoH6zTDsfykF2nNSsTgAT/9kSgYcI82STyVUtQ1lS2kcG4df4y19vdy1QBGRmMWic2ux5Hu3Lj9h1AVptcS2N6GsMe1WpJM5BT0tAdwQdgYMY8Iyk7tiECR1CZm/a+qg861m0dk8b9i2Ur3ychBIQ5HVecmoFR53jK1bsKPOYVxeKI/X22ZwH9xsspsg07rGrj5uxJdZAVZhmXNUjsuR9zezaVT+zrNuHzW4ADTzsSPU8fQ+oFR1AQZhnLkXkcwCA+f+8a354QtYsBSBes7uvHox/9LJ68Zw82rl3ffoVzJfsf2siwR0ZfZBgjAIAc4i3cOZMYSyFInqCzXCRlLSP4zco0yZGgaf8jl2RY56zZkuEYBwXp3dYJPoLUWKKmuro863H3aWrGcLRJQXrSMUaRFFLO+AIApkYRz3mUBVxXxPbxi223l2HGPY5V0LFu65gE6V/18kwLs00Ago+5g5LeDatkZRbQ4rjTqWa5LoJUwR2YKum8/Xf5GIRZpr6tD9+P3JZ5JM27Uoa+uIjPf26wZ2WAC8i9OM/kU+q663rdgJVEkiTcveEu7Nr8QHszHlWs5EUgge0xoHZ+PYasyAOOZZiiKiMKHYVu3YJgz7qsTEFOHE5FAAqAonXyd2xuzEzZAWQuLtUsdxWnZmCk6gSBQce608fEyCAqqygigbzIloMB+73OK495pxb0yrMzKftvDUkVABQMD/WiTH1bH74fxsOVv08e/A4wOOBa/gitzOl55OeBBz/F5FPqLs6AdEjHlltcyld51kWn84qwVgzZqmnt8jS5Q7GEdiYrcuOOXIwJ1b6irf4nW8lrqCw9eHK2x7HMVFmCqbwKqYijjPNq2UBmvMmrckc96oQz32PcnhEYHvIvBy1Zk4Sq7JjEpDnuubg7OXhCbXC69lgyCTzWAct5atA/O3BShmFVV9mHVz/qfL+Cjnlg5ZO+63tS8A/i3Dk4vS9TX/n21wc/talO/kX3ypw8soCjgzIe29xK24maIKgln3n2MfGZZx8Tf3Fgt3jl+GviypUrbdWXT0AAdV6JfKWwnhYKIABFpHXn3+6Xktatyt2fKWlxTORFwvzbWXVN3Y5yjdrl1QdFUex96pWCNe3R642Bva0u0kq9cUqIfKNyjfZV1Sc9rXiWKRepjE15rJ37Ndvi6KtrnF1jbW0fdKybLVf9PbGObYP+VR8nz2Pi8/3y2FewMa+Mof39de3DOsb1ee+r0pawy1ScF9kvfVts/FJJnDDfeeUb/yay/+v/ebhl5sUX/urb4oGXzvuOLVGncAakRZIkYevGTyB93xPYuuEuSJLUpT2ZiaVZ/7kPL0rasfwSy1aS+NrgXNsuN819p0csW70WrmNyh0dFPu2JZR1JiU4jw+aVbe16OxJ5720aiGUrCZVOibx7rCOpgkc5cymsRgSpybR9V0RcSmK8evnMVTwFK32lqE4g7/io0Vg3W85P3f7Fsu6xTeQ9xyzo9yvomHeHgrTe6KFoYZap2PrwJsx98XnzyaTfRf7Df1RJUg27zJF5HMAaxDcz+ZS6TxKCv6LWiuNnT3UmwZTIVrmd2hVAtlyOqDmHnnkeCdyJuYeZ/0HdxxmQFjH4IKIV5fQx/P1h4ME7GHxQOHgXDBERAes2YfrLm3rdCrqGcAaEiIiIQvf/tMvEijE+K2EAAAAASUVORK5CYII=" alt="image-20221228104913474"></p> <h4 id="安装配置-nginx"><a href="#安装配置-nginx" class="header-anchor">#</a> 安装配置 nginx</h4> <p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx: download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/notes/assets/img/image-20221228144339405.0dc04030.png" alt="image-20221228144339405"></p> <h4 id="修改配置文件"><a href="#修改配置文件" class="header-anchor">#</a> 修改配置文件</h4> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment">#user  nobody;</span>
<span class="token attr-name">worker_processes</span> <span class="token attr-value"> 1;</span>

<span class="token comment">#error_log  logs/error.log;</span>
<span class="token comment">#error_log  logs/error.log  notice;</span>
<span class="token comment">#error_log  logs/error.log  info;</span>

<span class="token comment">#pid        logs/nginx.pid;</span>


<span class="token attr-name">events</span> <span class="token attr-value">{</span>
<span class="token attr-name">    worker_connections</span> <span class="token attr-value"> 1024;</span>
}


<span class="token attr-name">http</span> <span class="token attr-value">{</span>
<span class="token attr-name">    include</span> <span class="token attr-value">      mime.types;</span>
<span class="token attr-name">    default_type</span> <span class="token attr-value"> application/octet-stream;</span>

<span class="token comment">    #log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
<span class="token comment">    #                  '$status $body_bytes_sent &quot;$http_referer&quot; '</span>
<span class="token comment">    #                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';</span>

<span class="token comment">    #access_log  logs/access.log  main;</span>

<span class="token attr-name">    sendfile</span> <span class="token attr-value">       on;</span>
<span class="token comment">    #tcp_nopush     on;</span>

<span class="token comment">    #keepalive_timeout  0;</span>
<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value"> 65;</span>

<span class="token comment">    #gzip  on;</span>
    
<span class="token attr-name">    upstream</span> <span class="token attr-value">distributedLock {</span>
<span class="token attr-name">        server</span> <span class="token attr-value">localhost:8888;</span>
<span class="token attr-name">        server</span> <span class="token attr-value">localhost:9999;</span>
    }

<span class="token attr-name">    server</span> <span class="token attr-value">{</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">      80;</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value"> localhost;</span>

<span class="token comment">        #charset koi8-r;</span>

<span class="token comment">        #access_log  logs/host.access.log  main;</span>

<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">            proxy_pass</span> <span class="token attr-value">http://distributedLock;</span>
        }

<span class="token comment">        #error_page  404              /404.html;</span>

<span class="token comment">        # redirect server error pages to the static page /50x.html</span>
<span class="token comment">        #</span>
<span class="token attr-name">        error_page</span> <span class="token attr-value">  500 502 503 504  /50x.html;</span>
<span class="token attr-name">        location</span> <span class="token punctuation">=</span> <span class="token attr-value">/50x.html {</span>
<span class="token attr-name">            root</span> <span class="token attr-value">  html;</span>
        }
    }
}
</code></pre></div><h4 id="启动"><a href="#启动" class="header-anchor">#</a> 启动</h4> <p><img src="/notes/assets/img/image-20221228145736488.971cc7f2.png" alt="image-20221228145736488"></p> <p>在浏览器中测试：localhost/stock/deduct 是我的nginx服务器地址</p> <p><img src="/notes/assets/img/image-20221228150351922.39afa8cf.png" alt="image-20221228150351922"></p> <p>经过测试，通过nginx访问服务一切正常。</p> <p><strong>再次使用Jmeter进行压测，发现库存出现超卖现象，仅仅吞吐有所提高。</strong></p> <h2 id="mysql-锁演示"><a href="#mysql-锁演示" class="header-anchor">#</a> MySQL 锁演示</h2> <p>除了使用jvm锁之外，还可以使用数据锁：<strong>悲观锁</strong> 或者 <strong>乐观锁</strong></p> <ul><li><p>一个SQL：直接更新时判断，在更新中判断库存是否大于0。</p> <ul><li><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> db_stock <span class="token keyword">set</span> <span class="token punctuation">`</span>count<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>count<span class="token punctuation">`</span><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">where</span> product_code <span class="token operator">=</span> <span class="token string">'1001'</span> <span class="token operator">and</span> <span class="token punctuation">`</span>count<span class="token punctuation">`</span> <span class="token operator">&gt;=</span><span class="token number">1</span>
</code></pre></div></li> <li><p>可以解决上述问题，但是会引发新的问题。</p> <ul><li><p>如果有多行记录会导致一起减少</p> <p><img src="data:image/png;base64,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" alt="image-20221229110917528"></p></li> <li><p>无法记录库存变化前后的状态</p></li></ul></li></ul></li></ul> <h3 id="mysql-锁范围"><a href="#mysql-锁范围" class="header-anchor">#</a> MySQL 锁范围</h3> <h4 id="表级所"><a href="#表级所" class="header-anchor">#</a> 表级所</h4> <p>MySQL 中锁定粒度最大的一种锁，是针对非索引字段加的锁，对当前操作的整张表加锁，实现简单，<strong>资源消耗也比较少</strong>，加锁快，<strong>不会出现死锁</strong>。其锁定粒度<strong>最大</strong>，触发锁冲突的概率最高，并发度最低，MyISAM 和 InnoDB 引擎都支持表级锁。</p> <p>如果下所示，终端1如果不提交 / 回滚事务，终端2就一直在等待，直到终端1提交，终端2经过7秒等待也完成插入。</p> <p><img src="/notes/assets/img/image-20221229144353276.3c991d18.png" alt="image-20221229144353276"></p> <p><img src="/notes/assets/img/image-20221229144410649.9b29e329.png" alt="image-20221229144410649"></p> <h4 id="行级锁"><a href="#行级锁" class="header-anchor">#</a> 行级锁</h4> <p>MySQL 中锁定粒度最小的一种锁，是针对<strong>索引字段</strong>加的锁，只针对<strong>当前操作的记录</strong>进行加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，并发度高，但加锁的<strong>开销也最大</strong>，加锁慢，会出现<strong>死锁</strong>。</p> <p>首先添加索引字段。可以看到，终端1还未提交事务，终端二已经完成了更新。</p> <p><img src="/notes/assets/img/image-20221229150857683.8e1048d0.png" alt="image-20221229150857683"></p> <p><img src="/notes/assets/img/image-20221229151944904.b63ede77.png" alt="image-20221229151944904"></p> <p><img src="/notes/assets/img/image-20221229151957100.00252cc4.png" alt="image-20221229151957100"></p> <blockquote><p><font color="red">使用行级锁的条件</font></p> <ol><li>锁的查询或者更新的条件必须是索引字段。</li> <li>查询或者更新的条件必须是具体值。</li></ol></blockquote> <h3 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁</h3> <p>在MySQL的InnoDB中，预设的Tansaction isolation level 为REPEATABLE READ（可重读）</p> <p><strong>在SELECT 的读取锁定主要分为两种方式：</strong></p> <ul><li>SELECT ... LOCK IN SHARE MODE　（共享锁）</li> <li>SELECT ... FOR UPDATE                     （排他锁）</li></ul> <p>这两种方式在事务(Transaction) 进行当中SELECT 到同一个数据表时，都必须等待其它事务数据被提交(Commit)后才会执行。</p> <p>而主要的不同在于LOCK IN SHARE MODE 在有一方事务要Update 同一个表单时很容易造成死锁。</p> <p>简单的说，如果SELECT 后面若要UPDATE 同一个表单，最好使用SELECT ... FOR UPDATE。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * 使用排它锁根据ProductCode查询
     * @param productCode   商品Code
     * @return 库存列表
     */</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select id,product_code, stock_code,`count` from lock.db_stock where product_code = #{productCode,jdbcType=VARCHAR} for update&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectForUpdate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;productCode&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> productCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> stocks <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectForUpdate</span><span class="token punctuation">(</span><span class="token string">&quot;1001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断哪个仓库最近且有货。这需要有个算法，这里就选择第一个</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stocks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 再减库存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="image-20221229190743407"></p> <h4 id="引发的问题"><a href="#引发的问题" class="header-anchor">#</a> 引发的问题</h4> <ol><li>性能问题：一个事务用悲观锁对数据加锁之后，其他事务将不能对加锁的数据进行除了查询以外的所有操作，如果事务执行时间比较长，其他事务一直在阻塞状态，一定会影响系统的吞吐量。</li> <li>死锁问题： 如果一个事务A正在对一条数据R1进行更新操作，然后另一个事务B正在对数据R2进行更新操作，然后事务A对数据R2进行更新操作，事务B对数据R1进行更新操作就会出现死锁。</li></ol> <p><img src="/notes/assets/img/image-20221230133110994.14d14160.png" alt="image-20221230133110994"></p> <p><img src="/notes/assets/img/image-20221230133131522.ad3a96ff.png" alt="image-20221230133131522"></p> <h3 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h3> <p>乐观锁（ Optimistic Locking ） 相对悲观锁而言，乐观锁假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则重试。那么如何实现乐观锁呢？</p> <p>使用数据版本（Version）记录机制实现，这是乐观锁最常用的实现方式。一般是通过为数据库表增加一个数字类型的 “version” 字段来实现。当读取数据时，将 version 字段的值一同读出，数据每更新一 次，对此version值加一。当我们提交更新的时候，判断数据库表对应记录 的当前版本信息与第一次取 出来的 version 值进行比对，如果数据库表当前版本号与第一次取出来的 version 值相等，则予以更新。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
     * 使用排它锁根据ProductCode查询
     * @param productCode   商品Code
     * @return 库存列表
     */</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select id,product_code, stock_code,`count` from lock.db_stock where product_code = #{productCode,jdbcType=VARCHAR} for update&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectForUpdate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;productCode&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> productCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询出来库存对象</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再减库存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取版本号</span>
            <span class="token class-name">Integer</span> oldVersion <span class="token operator">=</span> stock<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 更新</span>
            stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stock<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>oldVersion <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>stockMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stock<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_ID<span class="token punctuation">,</span> stock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_VERSION<span class="token punctuation">,</span> oldVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/notes/assets/img/image-20230103111137535.98738e9f.png" alt="image-20230103111137535"></p> <h4 id="引发的问题-2"><a href="#引发的问题-2" class="header-anchor">#</a> 引发的问题</h4> <ol><li>当运行压力测试的时候，错误率高达98%。后台抛出了栈内存异常。</li></ol> <p><img src="/notes/assets/img/image-20230103134233994.aa16cf0c.png" alt="image-20230103134233994"></p> <p><img src="/notes/assets/img/image-20230103134439446.5490dfd7.png" alt="image-20230103134439446"></p> <ol start="2"><li>因为程序中一直在自旋，这个问题是可能会出现的。程序中加上一个20ms的等待。</li></ol> <p><img src="/notes/assets/img/image-20230103140447130.c03989bd.png" alt="image-20230103140447130"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询出来库存对象</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 再减库存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取版本号</span>
        <span class="token class-name">Integer</span> oldVersion <span class="token operator">=</span> stock<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stock<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>oldVersion <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stockMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stock<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_ID<span class="token punctuation">,</span> stock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Stock</span><span class="token punctuation">.</span>COL_VERSION<span class="token punctuation">,</span> oldVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 休眠20ms</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>再次执行发现错误率依然高达99%，后台程序中一直在抛出<strong>超时</strong>异常。</li></ol> <p><img src="/notes/assets/img/image-20230103135358864.439f6202.png" alt="image-20230103135358864"></p> <p><img src="/notes/assets/img/image-20230103135507156.1fc17047.png" alt="image-20230103135507156"></p> <p><strong>这个主要是因为 @Transactional 注解导致的，加上事务注解就相当于开启了手动事务，整个方法的每一步都被加上了锁，一旦update执行失败，那么方法就会递归调用，导致其他的线程一直阻塞在这里，就出现了上述超时的异常，去掉事务注解后，MDL操作会自动加锁，其实MDL加锁过程是<code>系统自动控制，无法直接干预，也不需要直接干预，当我们对一个表做增删改查操作的时候，会自动加MDL读锁</code>，一旦update操作失败后，会立刻释放锁，下一个线程就可以继续执行。</strong></p> <p><img src="/notes/assets/img/image-20230103142136591.1eef167c.png" alt="image-20230103142136591"></p> <p><img src="/notes/assets/img/image-20230103143356658.ae5c043d.png" alt="image-20230103143356658"></p> <blockquote><p>乐观锁在并发量越大的情况下，性能越低（因为需要大量的重试）；并发量越小，性能越高。</p></blockquote> <h3 id="mysql-锁缺陷"><a href="#mysql-锁缺陷" class="header-anchor">#</a> MySQL 锁缺陷</h3> <p>在数据库集群情况下会导致数据库锁失效，并且很多数据库集群的中间件压根就不支持悲观锁。例如： mycat 在读写分离的场景下可能会导致乐观锁不可靠。 这把锁强依赖数据库的可用性，数据库是一个单点，一旦数据库挂掉，会导致业务系统不可用。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>性能：一个sql &gt; 悲观锁 &gt;  jvm锁 &gt; 乐观锁。</p> <ul><li>如果追求极致性能、业务场景简单并且不用数据前后变化状态的情况下，<strong>优先选择一个SQL</strong> 。</li> <li>如果写并发量较低（多读），争抢不是很严重的情况下<strong>优先选择乐观锁</strong>。</li> <li>如果写并发量较高，一般会经常冲突，此时选择乐观锁的话，会导致代码不断的重试。<strong>优先选择悲观锁</strong>。</li> <li>不推荐使用JVM本地锁。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">9/14/2023, 1:18:45 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html">
        基于 Redis 实现分布式锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/notes/assets/js/app.4394edef.js" defer></script><script src="/notes/assets/js/3.499ba1d5.js" defer></script><script src="/notes/assets/js/4.0eddc376.js" defer></script>
  </body>
</html>
