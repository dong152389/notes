<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于 Redis 实现分布式锁 | 我的笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/notes/favicon.ico">
    <script data-ad-client="ca-pub-4147143076931995" async="true" src="/notes//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="记录Java的学习过程">
    
    <link rel="preload" href="/notes/assets/css/0.styles.db9e9bf4.css" as="style"><link rel="preload" href="/notes/assets/js/app.4394edef.js" as="script"><link rel="preload" href="/notes/assets/js/3.499ba1d5.js" as="script"><link rel="preload" href="/notes/assets/js/5.a09c7da9.js" as="script"><link rel="prefetch" href="/notes/assets/js/1.38d69124.js"><link rel="prefetch" href="/notes/assets/js/10.a5dbd791.js"><link rel="prefetch" href="/notes/assets/js/100.855dee90.js"><link rel="prefetch" href="/notes/assets/js/101.5f61e033.js"><link rel="prefetch" href="/notes/assets/js/102.3469dfe6.js"><link rel="prefetch" href="/notes/assets/js/103.f97cd3c4.js"><link rel="prefetch" href="/notes/assets/js/104.d1be0323.js"><link rel="prefetch" href="/notes/assets/js/105.bff5ad21.js"><link rel="prefetch" href="/notes/assets/js/106.8bfda405.js"><link rel="prefetch" href="/notes/assets/js/107.fd4a3526.js"><link rel="prefetch" href="/notes/assets/js/108.ec803d12.js"><link rel="prefetch" href="/notes/assets/js/109.8bf97b71.js"><link rel="prefetch" href="/notes/assets/js/11.e807a7ed.js"><link rel="prefetch" href="/notes/assets/js/110.3cbf71f4.js"><link rel="prefetch" href="/notes/assets/js/111.d4476b7a.js"><link rel="prefetch" href="/notes/assets/js/112.3d5957bd.js"><link rel="prefetch" href="/notes/assets/js/113.f101f928.js"><link rel="prefetch" href="/notes/assets/js/114.b45be011.js"><link rel="prefetch" href="/notes/assets/js/115.36fae589.js"><link rel="prefetch" href="/notes/assets/js/116.9f5abe3a.js"><link rel="prefetch" href="/notes/assets/js/117.ea710cb4.js"><link rel="prefetch" href="/notes/assets/js/118.cc44a183.js"><link rel="prefetch" href="/notes/assets/js/119.58bcbadf.js"><link rel="prefetch" href="/notes/assets/js/12.b8e9ea0e.js"><link rel="prefetch" href="/notes/assets/js/120.38ae234a.js"><link rel="prefetch" href="/notes/assets/js/121.20e6693e.js"><link rel="prefetch" href="/notes/assets/js/122.9d14160c.js"><link rel="prefetch" href="/notes/assets/js/123.56e221ac.js"><link rel="prefetch" href="/notes/assets/js/124.80c6fac9.js"><link rel="prefetch" href="/notes/assets/js/125.b851edf2.js"><link rel="prefetch" href="/notes/assets/js/126.565b012b.js"><link rel="prefetch" href="/notes/assets/js/127.d7d6e0ea.js"><link rel="prefetch" href="/notes/assets/js/128.2242a066.js"><link rel="prefetch" href="/notes/assets/js/129.02e60c5d.js"><link rel="prefetch" href="/notes/assets/js/13.ee61224b.js"><link rel="prefetch" href="/notes/assets/js/130.869b1fef.js"><link rel="prefetch" href="/notes/assets/js/131.e7f3e93e.js"><link rel="prefetch" href="/notes/assets/js/132.29465758.js"><link rel="prefetch" href="/notes/assets/js/133.758d34b1.js"><link rel="prefetch" href="/notes/assets/js/134.b91b657f.js"><link rel="prefetch" href="/notes/assets/js/135.f22c78a9.js"><link rel="prefetch" href="/notes/assets/js/136.ff7a4dfb.js"><link rel="prefetch" href="/notes/assets/js/137.0217e3a6.js"><link rel="prefetch" href="/notes/assets/js/138.4530d752.js"><link rel="prefetch" href="/notes/assets/js/139.66f5ff99.js"><link rel="prefetch" href="/notes/assets/js/14.b0ee0bd3.js"><link rel="prefetch" href="/notes/assets/js/140.e98b7a29.js"><link rel="prefetch" href="/notes/assets/js/141.17370b53.js"><link rel="prefetch" href="/notes/assets/js/142.9171a17e.js"><link rel="prefetch" href="/notes/assets/js/143.123cb882.js"><link rel="prefetch" href="/notes/assets/js/144.a3ab3c1e.js"><link rel="prefetch" href="/notes/assets/js/145.df6095ce.js"><link rel="prefetch" href="/notes/assets/js/146.297a5691.js"><link rel="prefetch" href="/notes/assets/js/147.8b775c1d.js"><link rel="prefetch" href="/notes/assets/js/148.5d1953b6.js"><link rel="prefetch" href="/notes/assets/js/149.e86e91d0.js"><link rel="prefetch" href="/notes/assets/js/15.598de02e.js"><link rel="prefetch" href="/notes/assets/js/150.a98bca9c.js"><link rel="prefetch" href="/notes/assets/js/151.f29d3d49.js"><link rel="prefetch" href="/notes/assets/js/152.76982dca.js"><link rel="prefetch" href="/notes/assets/js/153.6cfba964.js"><link rel="prefetch" href="/notes/assets/js/154.cc02a668.js"><link rel="prefetch" href="/notes/assets/js/155.974eb41d.js"><link rel="prefetch" href="/notes/assets/js/156.ecf561d9.js"><link rel="prefetch" href="/notes/assets/js/157.79282e02.js"><link rel="prefetch" href="/notes/assets/js/158.bbd922f3.js"><link rel="prefetch" href="/notes/assets/js/159.89c0c986.js"><link rel="prefetch" href="/notes/assets/js/16.44d6776e.js"><link rel="prefetch" href="/notes/assets/js/160.baf9d921.js"><link rel="prefetch" href="/notes/assets/js/161.a9b8f635.js"><link rel="prefetch" href="/notes/assets/js/162.6d6a7ec5.js"><link rel="prefetch" href="/notes/assets/js/163.a3c7488c.js"><link rel="prefetch" href="/notes/assets/js/164.c9f0500c.js"><link rel="prefetch" href="/notes/assets/js/165.30411c9b.js"><link rel="prefetch" href="/notes/assets/js/166.bc3d5911.js"><link rel="prefetch" href="/notes/assets/js/167.c661fd7b.js"><link rel="prefetch" href="/notes/assets/js/168.cbc5ab9b.js"><link rel="prefetch" href="/notes/assets/js/169.5dee4e88.js"><link rel="prefetch" href="/notes/assets/js/17.d7b8971a.js"><link rel="prefetch" href="/notes/assets/js/170.9e2897f5.js"><link rel="prefetch" href="/notes/assets/js/171.057d9ad1.js"><link rel="prefetch" href="/notes/assets/js/172.fa910130.js"><link rel="prefetch" href="/notes/assets/js/173.4723064f.js"><link rel="prefetch" href="/notes/assets/js/174.8ad20ad0.js"><link rel="prefetch" href="/notes/assets/js/175.ad7ca5e6.js"><link rel="prefetch" href="/notes/assets/js/176.ddd3d12c.js"><link rel="prefetch" href="/notes/assets/js/177.5fb19a05.js"><link rel="prefetch" href="/notes/assets/js/178.8647fda3.js"><link rel="prefetch" href="/notes/assets/js/179.b08f05a2.js"><link rel="prefetch" href="/notes/assets/js/18.42070e39.js"><link rel="prefetch" href="/notes/assets/js/180.4013a5e3.js"><link rel="prefetch" href="/notes/assets/js/181.2ff5d065.js"><link rel="prefetch" href="/notes/assets/js/182.84cb537c.js"><link rel="prefetch" href="/notes/assets/js/183.f5eabd47.js"><link rel="prefetch" href="/notes/assets/js/184.a01b9e48.js"><link rel="prefetch" href="/notes/assets/js/185.e7d88f1a.js"><link rel="prefetch" href="/notes/assets/js/186.358a2348.js"><link rel="prefetch" href="/notes/assets/js/187.9c01f97b.js"><link rel="prefetch" href="/notes/assets/js/188.a26520e2.js"><link rel="prefetch" href="/notes/assets/js/189.e8101173.js"><link rel="prefetch" href="/notes/assets/js/19.deaea0cd.js"><link rel="prefetch" href="/notes/assets/js/190.4db66d1c.js"><link rel="prefetch" href="/notes/assets/js/191.c4fb68e3.js"><link rel="prefetch" href="/notes/assets/js/192.3898a6bb.js"><link rel="prefetch" href="/notes/assets/js/193.e1645fe5.js"><link rel="prefetch" href="/notes/assets/js/194.444e8222.js"><link rel="prefetch" href="/notes/assets/js/195.5a6c28d2.js"><link rel="prefetch" href="/notes/assets/js/196.70fb07df.js"><link rel="prefetch" href="/notes/assets/js/197.e0c5fd7e.js"><link rel="prefetch" href="/notes/assets/js/198.fff60e9b.js"><link rel="prefetch" href="/notes/assets/js/199.38151e80.js"><link rel="prefetch" href="/notes/assets/js/20.31d3a4b3.js"><link rel="prefetch" href="/notes/assets/js/200.746630e8.js"><link rel="prefetch" href="/notes/assets/js/201.c19c0234.js"><link rel="prefetch" href="/notes/assets/js/202.e3cbb9d0.js"><link rel="prefetch" href="/notes/assets/js/203.d433a129.js"><link rel="prefetch" href="/notes/assets/js/204.de75ac01.js"><link rel="prefetch" href="/notes/assets/js/205.55f064b3.js"><link rel="prefetch" href="/notes/assets/js/206.2e4c6536.js"><link rel="prefetch" href="/notes/assets/js/207.658b0485.js"><link rel="prefetch" href="/notes/assets/js/208.0414daa5.js"><link rel="prefetch" href="/notes/assets/js/209.a8c2b910.js"><link rel="prefetch" href="/notes/assets/js/21.998ed6e0.js"><link rel="prefetch" href="/notes/assets/js/210.aad4c8fc.js"><link rel="prefetch" href="/notes/assets/js/211.f116cd27.js"><link rel="prefetch" href="/notes/assets/js/212.f4628715.js"><link rel="prefetch" href="/notes/assets/js/213.ceadc213.js"><link rel="prefetch" href="/notes/assets/js/214.20425d7e.js"><link rel="prefetch" href="/notes/assets/js/215.ea509344.js"><link rel="prefetch" href="/notes/assets/js/216.a4ab1a13.js"><link rel="prefetch" href="/notes/assets/js/217.e7f07700.js"><link rel="prefetch" href="/notes/assets/js/218.d34a6368.js"><link rel="prefetch" href="/notes/assets/js/219.c6aa2c44.js"><link rel="prefetch" href="/notes/assets/js/22.0bde63c4.js"><link rel="prefetch" href="/notes/assets/js/220.a20be513.js"><link rel="prefetch" href="/notes/assets/js/221.7316596a.js"><link rel="prefetch" href="/notes/assets/js/222.841353ed.js"><link rel="prefetch" href="/notes/assets/js/223.e33bec57.js"><link rel="prefetch" href="/notes/assets/js/224.354d6301.js"><link rel="prefetch" href="/notes/assets/js/225.282386c1.js"><link rel="prefetch" href="/notes/assets/js/226.abb99fb7.js"><link rel="prefetch" href="/notes/assets/js/227.b2ab63ea.js"><link rel="prefetch" href="/notes/assets/js/228.df447bd0.js"><link rel="prefetch" href="/notes/assets/js/229.fd1b2705.js"><link rel="prefetch" href="/notes/assets/js/23.d600cd4a.js"><link rel="prefetch" href="/notes/assets/js/230.56479e93.js"><link rel="prefetch" href="/notes/assets/js/231.7fe06ae5.js"><link rel="prefetch" href="/notes/assets/js/232.40909175.js"><link rel="prefetch" href="/notes/assets/js/233.bba63cc0.js"><link rel="prefetch" href="/notes/assets/js/234.ca29b35e.js"><link rel="prefetch" href="/notes/assets/js/235.f8a823b0.js"><link rel="prefetch" href="/notes/assets/js/236.a2235fd6.js"><link rel="prefetch" href="/notes/assets/js/237.0a512d23.js"><link rel="prefetch" href="/notes/assets/js/238.74752a3f.js"><link rel="prefetch" href="/notes/assets/js/239.c2bca48c.js"><link rel="prefetch" href="/notes/assets/js/24.39be2e8d.js"><link rel="prefetch" href="/notes/assets/js/240.ced33249.js"><link rel="prefetch" href="/notes/assets/js/241.a18de0bf.js"><link rel="prefetch" href="/notes/assets/js/242.669b3661.js"><link rel="prefetch" href="/notes/assets/js/243.8d12af13.js"><link rel="prefetch" href="/notes/assets/js/244.94929fbd.js"><link rel="prefetch" href="/notes/assets/js/245.01f98b2d.js"><link rel="prefetch" href="/notes/assets/js/246.1c7cb7bc.js"><link rel="prefetch" href="/notes/assets/js/247.5d018884.js"><link rel="prefetch" href="/notes/assets/js/248.20cc0c3b.js"><link rel="prefetch" href="/notes/assets/js/249.a10fbf5a.js"><link rel="prefetch" href="/notes/assets/js/25.f7a1c429.js"><link rel="prefetch" href="/notes/assets/js/250.cea231a0.js"><link rel="prefetch" href="/notes/assets/js/251.52736b60.js"><link rel="prefetch" href="/notes/assets/js/252.60f6e80e.js"><link rel="prefetch" href="/notes/assets/js/253.e2ab134e.js"><link rel="prefetch" href="/notes/assets/js/254.d221539b.js"><link rel="prefetch" href="/notes/assets/js/255.9acb0f08.js"><link rel="prefetch" href="/notes/assets/js/256.22c747ac.js"><link rel="prefetch" href="/notes/assets/js/257.f836ea8d.js"><link rel="prefetch" href="/notes/assets/js/258.a11bcb0e.js"><link rel="prefetch" href="/notes/assets/js/259.08eb5bd9.js"><link rel="prefetch" href="/notes/assets/js/26.718316a9.js"><link rel="prefetch" href="/notes/assets/js/260.55db7d07.js"><link rel="prefetch" href="/notes/assets/js/261.a0f04612.js"><link rel="prefetch" href="/notes/assets/js/262.e507e349.js"><link rel="prefetch" href="/notes/assets/js/263.bc2798af.js"><link rel="prefetch" href="/notes/assets/js/264.aa2a7ed5.js"><link rel="prefetch" href="/notes/assets/js/265.b3125de8.js"><link rel="prefetch" href="/notes/assets/js/266.01bf6375.js"><link rel="prefetch" href="/notes/assets/js/267.ccea1a20.js"><link rel="prefetch" href="/notes/assets/js/268.be1e4e72.js"><link rel="prefetch" href="/notes/assets/js/269.dbd08cee.js"><link rel="prefetch" href="/notes/assets/js/27.94862e46.js"><link rel="prefetch" href="/notes/assets/js/270.1ca726b8.js"><link rel="prefetch" href="/notes/assets/js/271.f5474b97.js"><link rel="prefetch" href="/notes/assets/js/272.b0ef680f.js"><link rel="prefetch" href="/notes/assets/js/273.c4136437.js"><link rel="prefetch" href="/notes/assets/js/274.4e8bdfd6.js"><link rel="prefetch" href="/notes/assets/js/275.fb644fb5.js"><link rel="prefetch" href="/notes/assets/js/276.5cb09d9f.js"><link rel="prefetch" href="/notes/assets/js/277.57e58373.js"><link rel="prefetch" href="/notes/assets/js/278.43c33939.js"><link rel="prefetch" href="/notes/assets/js/279.914a110e.js"><link rel="prefetch" href="/notes/assets/js/28.a5e6fe66.js"><link rel="prefetch" href="/notes/assets/js/280.cf3b7a68.js"><link rel="prefetch" href="/notes/assets/js/281.de48ba8f.js"><link rel="prefetch" href="/notes/assets/js/282.c069db9c.js"><link rel="prefetch" href="/notes/assets/js/283.747f23a6.js"><link rel="prefetch" href="/notes/assets/js/284.d04f54b2.js"><link rel="prefetch" href="/notes/assets/js/285.39ac6b15.js"><link rel="prefetch" href="/notes/assets/js/286.43b88694.js"><link rel="prefetch" href="/notes/assets/js/287.2cafdc4d.js"><link rel="prefetch" href="/notes/assets/js/288.84d97b4e.js"><link rel="prefetch" href="/notes/assets/js/289.b2118bba.js"><link rel="prefetch" href="/notes/assets/js/29.ab3b6aaf.js"><link rel="prefetch" href="/notes/assets/js/290.16f2afe5.js"><link rel="prefetch" href="/notes/assets/js/291.bc6c61b0.js"><link rel="prefetch" href="/notes/assets/js/292.8bff7b6b.js"><link rel="prefetch" href="/notes/assets/js/293.a3a4b0f8.js"><link rel="prefetch" href="/notes/assets/js/294.0f2cb4da.js"><link rel="prefetch" href="/notes/assets/js/295.28aba777.js"><link rel="prefetch" href="/notes/assets/js/296.2371cb58.js"><link rel="prefetch" href="/notes/assets/js/297.61203718.js"><link rel="prefetch" href="/notes/assets/js/298.037c63f7.js"><link rel="prefetch" href="/notes/assets/js/299.b74b878c.js"><link rel="prefetch" href="/notes/assets/js/30.27ec9a11.js"><link rel="prefetch" href="/notes/assets/js/300.edf28f31.js"><link rel="prefetch" href="/notes/assets/js/301.b6986f4d.js"><link rel="prefetch" href="/notes/assets/js/302.48f59fa0.js"><link rel="prefetch" href="/notes/assets/js/303.c1e4d4ae.js"><link rel="prefetch" href="/notes/assets/js/304.b280da5f.js"><link rel="prefetch" href="/notes/assets/js/305.14e777bd.js"><link rel="prefetch" href="/notes/assets/js/306.3de8374a.js"><link rel="prefetch" href="/notes/assets/js/307.bb6b675d.js"><link rel="prefetch" href="/notes/assets/js/308.2dc4265f.js"><link rel="prefetch" href="/notes/assets/js/309.65b16b58.js"><link rel="prefetch" href="/notes/assets/js/31.20c8bfc3.js"><link rel="prefetch" href="/notes/assets/js/310.8e4c18ae.js"><link rel="prefetch" href="/notes/assets/js/311.c910a30b.js"><link rel="prefetch" href="/notes/assets/js/312.7036cc34.js"><link rel="prefetch" href="/notes/assets/js/313.103ece8b.js"><link rel="prefetch" href="/notes/assets/js/314.2e248349.js"><link rel="prefetch" href="/notes/assets/js/315.9affc380.js"><link rel="prefetch" href="/notes/assets/js/316.ebb4f037.js"><link rel="prefetch" href="/notes/assets/js/317.0dacd35e.js"><link rel="prefetch" href="/notes/assets/js/318.738240d2.js"><link rel="prefetch" href="/notes/assets/js/319.b54a8183.js"><link rel="prefetch" href="/notes/assets/js/32.2c249dba.js"><link rel="prefetch" href="/notes/assets/js/320.7262fc62.js"><link rel="prefetch" href="/notes/assets/js/321.b4d79334.js"><link rel="prefetch" href="/notes/assets/js/322.ad66b9bd.js"><link rel="prefetch" href="/notes/assets/js/323.a8dccd01.js"><link rel="prefetch" href="/notes/assets/js/324.d4051798.js"><link rel="prefetch" href="/notes/assets/js/325.c91a654f.js"><link rel="prefetch" href="/notes/assets/js/326.7ee08c62.js"><link rel="prefetch" href="/notes/assets/js/327.6215a570.js"><link rel="prefetch" href="/notes/assets/js/328.71120a1a.js"><link rel="prefetch" href="/notes/assets/js/329.22e47ea7.js"><link rel="prefetch" href="/notes/assets/js/33.e597a7df.js"><link rel="prefetch" href="/notes/assets/js/330.34079108.js"><link rel="prefetch" href="/notes/assets/js/331.d770f721.js"><link rel="prefetch" href="/notes/assets/js/332.aa85145a.js"><link rel="prefetch" href="/notes/assets/js/333.64e140e4.js"><link rel="prefetch" href="/notes/assets/js/334.cd240324.js"><link rel="prefetch" href="/notes/assets/js/335.cd547635.js"><link rel="prefetch" href="/notes/assets/js/336.91dab600.js"><link rel="prefetch" href="/notes/assets/js/337.2ec5cdc7.js"><link rel="prefetch" href="/notes/assets/js/338.59043c82.js"><link rel="prefetch" href="/notes/assets/js/339.8e5d1e06.js"><link rel="prefetch" href="/notes/assets/js/34.8d4b28aa.js"><link rel="prefetch" href="/notes/assets/js/340.9e2d2874.js"><link rel="prefetch" href="/notes/assets/js/341.61e6092a.js"><link rel="prefetch" href="/notes/assets/js/342.d0ee898b.js"><link rel="prefetch" href="/notes/assets/js/343.fb16ffba.js"><link rel="prefetch" href="/notes/assets/js/344.0bb46145.js"><link rel="prefetch" href="/notes/assets/js/345.ef6bfd94.js"><link rel="prefetch" href="/notes/assets/js/346.523ba3d0.js"><link rel="prefetch" href="/notes/assets/js/347.b7fd68da.js"><link rel="prefetch" href="/notes/assets/js/348.b6778cbf.js"><link rel="prefetch" href="/notes/assets/js/349.566ca9a1.js"><link rel="prefetch" href="/notes/assets/js/35.c2b72c34.js"><link rel="prefetch" href="/notes/assets/js/350.aa159fd9.js"><link rel="prefetch" href="/notes/assets/js/351.fe309038.js"><link rel="prefetch" href="/notes/assets/js/352.62097177.js"><link rel="prefetch" href="/notes/assets/js/353.8c8811bc.js"><link rel="prefetch" href="/notes/assets/js/354.d2ada007.js"><link rel="prefetch" href="/notes/assets/js/355.5d345cc6.js"><link rel="prefetch" href="/notes/assets/js/356.c6810cd7.js"><link rel="prefetch" href="/notes/assets/js/357.ac10961e.js"><link rel="prefetch" href="/notes/assets/js/358.0340e23d.js"><link rel="prefetch" href="/notes/assets/js/359.16bc2223.js"><link rel="prefetch" href="/notes/assets/js/36.57ca532c.js"><link rel="prefetch" href="/notes/assets/js/360.e45f7ea9.js"><link rel="prefetch" href="/notes/assets/js/361.a39d091e.js"><link rel="prefetch" href="/notes/assets/js/362.0283b5a9.js"><link rel="prefetch" href="/notes/assets/js/363.48fa48fe.js"><link rel="prefetch" href="/notes/assets/js/364.25a549cd.js"><link rel="prefetch" href="/notes/assets/js/365.2eddb807.js"><link rel="prefetch" href="/notes/assets/js/366.ef272f1a.js"><link rel="prefetch" href="/notes/assets/js/367.28e17043.js"><link rel="prefetch" href="/notes/assets/js/368.255a80fb.js"><link rel="prefetch" href="/notes/assets/js/369.ae66dd9f.js"><link rel="prefetch" href="/notes/assets/js/37.c545dd68.js"><link rel="prefetch" href="/notes/assets/js/370.88f9a32c.js"><link rel="prefetch" href="/notes/assets/js/371.7ffd8780.js"><link rel="prefetch" href="/notes/assets/js/372.605383d1.js"><link rel="prefetch" href="/notes/assets/js/373.c11f5dfe.js"><link rel="prefetch" href="/notes/assets/js/374.c00642a8.js"><link rel="prefetch" href="/notes/assets/js/375.0b004b06.js"><link rel="prefetch" href="/notes/assets/js/376.2769e761.js"><link rel="prefetch" href="/notes/assets/js/377.816e6da6.js"><link rel="prefetch" href="/notes/assets/js/378.cabaa608.js"><link rel="prefetch" href="/notes/assets/js/379.f3e43a5a.js"><link rel="prefetch" href="/notes/assets/js/38.3d798baf.js"><link rel="prefetch" href="/notes/assets/js/380.1ef68ac8.js"><link rel="prefetch" href="/notes/assets/js/381.f554891d.js"><link rel="prefetch" href="/notes/assets/js/382.4eeb9fb7.js"><link rel="prefetch" href="/notes/assets/js/383.de837b94.js"><link rel="prefetch" href="/notes/assets/js/384.085f9f09.js"><link rel="prefetch" href="/notes/assets/js/385.8fa51abb.js"><link rel="prefetch" href="/notes/assets/js/386.040eac11.js"><link rel="prefetch" href="/notes/assets/js/387.88990e8b.js"><link rel="prefetch" href="/notes/assets/js/388.1ea4a37c.js"><link rel="prefetch" href="/notes/assets/js/389.a323e4b9.js"><link rel="prefetch" href="/notes/assets/js/39.e9da77b7.js"><link rel="prefetch" href="/notes/assets/js/390.22026053.js"><link rel="prefetch" href="/notes/assets/js/391.9f02c56d.js"><link rel="prefetch" href="/notes/assets/js/392.d55d9034.js"><link rel="prefetch" href="/notes/assets/js/393.1cbbcf50.js"><link rel="prefetch" href="/notes/assets/js/394.55ea930c.js"><link rel="prefetch" href="/notes/assets/js/395.d0415c56.js"><link rel="prefetch" href="/notes/assets/js/396.a1f242c0.js"><link rel="prefetch" href="/notes/assets/js/397.ad062a1e.js"><link rel="prefetch" href="/notes/assets/js/398.401acbf5.js"><link rel="prefetch" href="/notes/assets/js/399.7fcb37f1.js"><link rel="prefetch" href="/notes/assets/js/4.0eddc376.js"><link rel="prefetch" href="/notes/assets/js/40.152fb70e.js"><link rel="prefetch" href="/notes/assets/js/400.7cad41d3.js"><link rel="prefetch" href="/notes/assets/js/401.bf6e604c.js"><link rel="prefetch" href="/notes/assets/js/402.5271fc7c.js"><link rel="prefetch" href="/notes/assets/js/403.a960210f.js"><link rel="prefetch" href="/notes/assets/js/404.220d9814.js"><link rel="prefetch" href="/notes/assets/js/405.fbeefca5.js"><link rel="prefetch" href="/notes/assets/js/406.1a7a3651.js"><link rel="prefetch" href="/notes/assets/js/407.92451b0d.js"><link rel="prefetch" href="/notes/assets/js/408.9081c518.js"><link rel="prefetch" href="/notes/assets/js/409.5b8705a8.js"><link rel="prefetch" href="/notes/assets/js/41.c973cd04.js"><link rel="prefetch" href="/notes/assets/js/410.2afd45ff.js"><link rel="prefetch" href="/notes/assets/js/411.30a6778b.js"><link rel="prefetch" href="/notes/assets/js/412.5b5fbb7a.js"><link rel="prefetch" href="/notes/assets/js/413.37b4db3c.js"><link rel="prefetch" href="/notes/assets/js/414.41f671f5.js"><link rel="prefetch" href="/notes/assets/js/415.5797eb0a.js"><link rel="prefetch" href="/notes/assets/js/416.5ec4dc00.js"><link rel="prefetch" href="/notes/assets/js/417.471b2657.js"><link rel="prefetch" href="/notes/assets/js/418.93bf4420.js"><link rel="prefetch" href="/notes/assets/js/419.483e75ac.js"><link rel="prefetch" href="/notes/assets/js/42.cefe7a26.js"><link rel="prefetch" href="/notes/assets/js/420.56ce2d80.js"><link rel="prefetch" href="/notes/assets/js/421.b1ed157a.js"><link rel="prefetch" href="/notes/assets/js/422.04adcf20.js"><link rel="prefetch" href="/notes/assets/js/423.4ef69085.js"><link rel="prefetch" href="/notes/assets/js/424.ee6c15ef.js"><link rel="prefetch" href="/notes/assets/js/425.ae40528c.js"><link rel="prefetch" href="/notes/assets/js/426.2ff5016e.js"><link rel="prefetch" href="/notes/assets/js/427.074660ad.js"><link rel="prefetch" href="/notes/assets/js/428.2eda923b.js"><link rel="prefetch" href="/notes/assets/js/429.2a6e7e7b.js"><link rel="prefetch" href="/notes/assets/js/43.bfaf3f9b.js"><link rel="prefetch" href="/notes/assets/js/430.f0fd4c44.js"><link rel="prefetch" href="/notes/assets/js/431.4c505b64.js"><link rel="prefetch" href="/notes/assets/js/432.2a188436.js"><link rel="prefetch" href="/notes/assets/js/433.8610f4fb.js"><link rel="prefetch" href="/notes/assets/js/434.ec313029.js"><link rel="prefetch" href="/notes/assets/js/435.0c6c1f6a.js"><link rel="prefetch" href="/notes/assets/js/436.2a3487db.js"><link rel="prefetch" href="/notes/assets/js/437.d132d27c.js"><link rel="prefetch" href="/notes/assets/js/438.ff4142c6.js"><link rel="prefetch" href="/notes/assets/js/439.0c474ccb.js"><link rel="prefetch" href="/notes/assets/js/44.d3333975.js"><link rel="prefetch" href="/notes/assets/js/440.7b882d15.js"><link rel="prefetch" href="/notes/assets/js/441.ab1bf371.js"><link rel="prefetch" href="/notes/assets/js/442.134f0456.js"><link rel="prefetch" href="/notes/assets/js/443.c6393d96.js"><link rel="prefetch" href="/notes/assets/js/444.2c9b16f1.js"><link rel="prefetch" href="/notes/assets/js/445.6decb9e1.js"><link rel="prefetch" href="/notes/assets/js/446.d6fccd3e.js"><link rel="prefetch" href="/notes/assets/js/447.90f4ab24.js"><link rel="prefetch" href="/notes/assets/js/448.55d87002.js"><link rel="prefetch" href="/notes/assets/js/449.308c7f75.js"><link rel="prefetch" href="/notes/assets/js/45.e63f1fc2.js"><link rel="prefetch" href="/notes/assets/js/450.72f5279e.js"><link rel="prefetch" href="/notes/assets/js/451.26d6e91c.js"><link rel="prefetch" href="/notes/assets/js/452.3184fdb4.js"><link rel="prefetch" href="/notes/assets/js/453.9d6d9af6.js"><link rel="prefetch" href="/notes/assets/js/454.f03ce01d.js"><link rel="prefetch" href="/notes/assets/js/455.f6fbc7a5.js"><link rel="prefetch" href="/notes/assets/js/456.cb5a72dd.js"><link rel="prefetch" href="/notes/assets/js/457.83d89808.js"><link rel="prefetch" href="/notes/assets/js/458.a4761ae2.js"><link rel="prefetch" href="/notes/assets/js/459.0a453ce2.js"><link rel="prefetch" href="/notes/assets/js/46.285c38fe.js"><link rel="prefetch" href="/notes/assets/js/460.39470724.js"><link rel="prefetch" href="/notes/assets/js/461.d84eac44.js"><link rel="prefetch" href="/notes/assets/js/462.2542bb78.js"><link rel="prefetch" href="/notes/assets/js/463.9b5715d0.js"><link rel="prefetch" href="/notes/assets/js/464.f9215414.js"><link rel="prefetch" href="/notes/assets/js/465.c6571f8d.js"><link rel="prefetch" href="/notes/assets/js/466.10c3a729.js"><link rel="prefetch" href="/notes/assets/js/467.917690aa.js"><link rel="prefetch" href="/notes/assets/js/468.e4e05fb0.js"><link rel="prefetch" href="/notes/assets/js/469.6ee1f0bf.js"><link rel="prefetch" href="/notes/assets/js/47.e179b803.js"><link rel="prefetch" href="/notes/assets/js/470.109daa98.js"><link rel="prefetch" href="/notes/assets/js/471.20e17539.js"><link rel="prefetch" href="/notes/assets/js/472.de465397.js"><link rel="prefetch" href="/notes/assets/js/473.697bece5.js"><link rel="prefetch" href="/notes/assets/js/474.c0500f50.js"><link rel="prefetch" href="/notes/assets/js/475.7a0de490.js"><link rel="prefetch" href="/notes/assets/js/476.3b6c2663.js"><link rel="prefetch" href="/notes/assets/js/477.fe61522a.js"><link rel="prefetch" href="/notes/assets/js/478.b33a7744.js"><link rel="prefetch" href="/notes/assets/js/479.29224709.js"><link rel="prefetch" href="/notes/assets/js/48.f6ca3943.js"><link rel="prefetch" href="/notes/assets/js/49.574091cd.js"><link rel="prefetch" href="/notes/assets/js/50.3a0ff583.js"><link rel="prefetch" href="/notes/assets/js/51.57db0225.js"><link rel="prefetch" href="/notes/assets/js/52.0ecf5693.js"><link rel="prefetch" href="/notes/assets/js/53.1f76ee65.js"><link rel="prefetch" href="/notes/assets/js/54.abcb27d8.js"><link rel="prefetch" href="/notes/assets/js/55.2e25c2d0.js"><link rel="prefetch" href="/notes/assets/js/56.bb6f65a5.js"><link rel="prefetch" href="/notes/assets/js/57.da9a0590.js"><link rel="prefetch" href="/notes/assets/js/58.1835be90.js"><link rel="prefetch" href="/notes/assets/js/59.af675de6.js"><link rel="prefetch" href="/notes/assets/js/6.3cd82c9a.js"><link rel="prefetch" href="/notes/assets/js/60.0ef43601.js"><link rel="prefetch" href="/notes/assets/js/61.c74e9f39.js"><link rel="prefetch" href="/notes/assets/js/62.1bedfdf6.js"><link rel="prefetch" href="/notes/assets/js/63.a0deef5f.js"><link rel="prefetch" href="/notes/assets/js/64.382724a8.js"><link rel="prefetch" href="/notes/assets/js/65.89029c37.js"><link rel="prefetch" href="/notes/assets/js/66.81ca5639.js"><link rel="prefetch" href="/notes/assets/js/67.cbbb38d7.js"><link rel="prefetch" href="/notes/assets/js/68.000bfd35.js"><link rel="prefetch" href="/notes/assets/js/69.c2d07d56.js"><link rel="prefetch" href="/notes/assets/js/7.7d6ad91c.js"><link rel="prefetch" href="/notes/assets/js/70.217180de.js"><link rel="prefetch" href="/notes/assets/js/71.98765c00.js"><link rel="prefetch" href="/notes/assets/js/72.1c955ea7.js"><link rel="prefetch" href="/notes/assets/js/73.d2706f61.js"><link rel="prefetch" href="/notes/assets/js/74.60cc2008.js"><link rel="prefetch" href="/notes/assets/js/75.4b361813.js"><link rel="prefetch" href="/notes/assets/js/76.38d96cc9.js"><link rel="prefetch" href="/notes/assets/js/77.438af426.js"><link rel="prefetch" href="/notes/assets/js/78.bcd8b2ed.js"><link rel="prefetch" href="/notes/assets/js/79.f5f68b99.js"><link rel="prefetch" href="/notes/assets/js/8.d3bec3c0.js"><link rel="prefetch" href="/notes/assets/js/80.56ed8ba9.js"><link rel="prefetch" href="/notes/assets/js/81.f8dbf3cf.js"><link rel="prefetch" href="/notes/assets/js/82.e794a34b.js"><link rel="prefetch" href="/notes/assets/js/83.e2c87fbb.js"><link rel="prefetch" href="/notes/assets/js/84.1afc1456.js"><link rel="prefetch" href="/notes/assets/js/85.b7c7c05b.js"><link rel="prefetch" href="/notes/assets/js/86.f3a12e4c.js"><link rel="prefetch" href="/notes/assets/js/87.4cd44f76.js"><link rel="prefetch" href="/notes/assets/js/88.57dc2780.js"><link rel="prefetch" href="/notes/assets/js/89.f604b335.js"><link rel="prefetch" href="/notes/assets/js/9.e1f148ec.js"><link rel="prefetch" href="/notes/assets/js/90.6ee867a3.js"><link rel="prefetch" href="/notes/assets/js/91.d509a153.js"><link rel="prefetch" href="/notes/assets/js/92.dbe29fc9.js"><link rel="prefetch" href="/notes/assets/js/93.00a12f11.js"><link rel="prefetch" href="/notes/assets/js/94.b910d5ad.js"><link rel="prefetch" href="/notes/assets/js/95.f2f8c392.js"><link rel="prefetch" href="/notes/assets/js/96.846bfa91.js"><link rel="prefetch" href="/notes/assets/js/97.2aaef136.js"><link rel="prefetch" href="/notes/assets/js/98.2fc7c21e.js"><link rel="prefetch" href="/notes/assets/js/99.c571e816.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.db9e9bf4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">我的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/guide/" class="nav-link">
  指南
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/guide/" class="nav-link">
  指南
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>传统锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/" aria-current="page" class="sidebar-link">传统锁回顾</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html" class="active sidebar-link">基于 Redis 实现分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#演示超卖现象" class="sidebar-link">演示超卖现象</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#解决方案" class="sidebar-link">解决方案</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redis-分布式锁" class="sidebar-link">Redis 分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#基本实现" class="sidebar-link">基本实现</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#防死锁" class="sidebar-link">防死锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#防误删" class="sidebar-link">防误删</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redis-中的-lua-脚本" class="sidebar-link">Redis 中的 lua 脚本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#现实问题" class="sidebar-link">现实问题</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#lua-介绍" class="sidebar-link">Lua 介绍</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#lua-基本语法" class="sidebar-link">Lua 基本语法</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redis-执行-lua-脚本" class="sidebar-link">Redis 执行 Lua 脚本</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#使用-lua-保证删除原子性" class="sidebar-link">使用 Lua 保证删除原子性</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#可重入锁" class="sidebar-link">可重入锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#举个例子-reentrantlock" class="sidebar-link">举个例子 ReentrantLock</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redis-可重入锁" class="sidebar-link">Redis 可重入锁</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#代码改造" class="sidebar-link">代码改造</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#自动续期" class="sidebar-link">自动续期</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#红锁算法" class="sidebar-link">红锁算法</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redisson-中的分布式锁" class="sidebar-link">Redisson 中的分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#redisson-是什么" class="sidebar-link">Redisson 是什么</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#可重入锁-reentrant-lock" class="sidebar-link">可重入锁（Reentrant Lock）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#公平锁-fair-lock" class="sidebar-link">公平锁（Fair Lock）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#联锁-multilock" class="sidebar-link">联锁（MultiLock）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#红锁-redlock" class="sidebar-link">红锁（RedLock）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#读写锁-readwritelock" class="sidebar-link">读写锁（ReadWriteLock）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#信号量-semaphore" class="sidebar-link">信号量（Semaphore）</a></li><li class="sidebar-sub-header"><a href="/notes/distributed-lock/基于 Redis 实现分布式锁.html#闭锁-countdownlatch" class="sidebar-link">闭锁（CountDownLatch）</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Zookeeper 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 Zookeeper 实现分布式锁.html" class="sidebar-link">基于 Zookeeper 实现分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL 锁</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/基于 MySQL 实现分布式锁.html" class="sidebar-link">基于 MySQL 实现分布式锁</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/distributed-lock/总结.html" class="sidebar-link">总结</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基于-redis-实现分布式锁"><a href="#基于-redis-实现分布式锁" class="header-anchor">#</a> 基于 Redis 实现分布式锁</h1> <h2 id="演示超卖现象"><a href="#演示超卖现象" class="header-anchor">#</a> 演示超卖现象</h2> <p>首先需要将maven依赖添加到项目中</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在application文件中配置Redis相关信息，因为我使用的Sentinel。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*.xml</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.25.10<span class="token punctuation">:</span>3306/lock<span class="token punctuation">?</span>characterEncoding=utf8<span class="token important">&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span>
  <span class="token key atrule">jackson</span><span class="token punctuation">:</span>
    <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss
    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">master</span><span class="token punctuation">:</span> mymaster
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 192.168.25.10<span class="token punctuation">:</span><span class="token number">26379</span>
        <span class="token punctuation">-</span> 192.168.25.10<span class="token punctuation">:</span><span class="token number">26380</span>
        <span class="token punctuation">-</span> 192.168.25.10<span class="token punctuation">:</span><span class="token number">26381</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span>
     <span class="token comment"># 必须配置Redis的密码，否则会抛出连接Redis失败的异常。</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">111111</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/notes/assets/img/image-20230104151507112.597e34a4.png" alt="image-20230104151507112"></p> <p><img src="data:image/png;base64,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" alt="image-20230104151608721"></p> <p>可以看到吞吐量非常的高。但是出现了超卖现象。</p> <h2 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h2> <p>可以用上一章所学的乐观锁的方式解决Redis的超卖。</p> <p><a href="/notes/redis/Redis 事务—锁机制.html#乐观锁"><strong>Redis 乐观锁</strong></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//operations 指代的就是RedisTemplate 对象</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span> operations<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
                operations<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> stock <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        operations<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//扣减库存</span>
                        operations<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">List</span> exec <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> exec <span class="token operator">||</span> <span class="token number">0</span> <span class="token operator">==</span> exec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> exec<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/notes/assets/img/image-20230104162309060.046dcab1.png" alt="image-20230104162309060"></p> <p><img src="data:image/png;base64,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" alt="image-20230104162453510"></p> <p>超卖问题得以解决，但是吞吐量下降明显。这种方式<strong>不推荐使用</strong>。</p> <h2 id="redis-分布式锁"><a href="#redis-分布式锁" class="header-anchor">#</a> Redis 分布式锁</h2> <h3 id="基本实现"><a href="#基本实现" class="header-anchor">#</a> 基本实现</h3> <p>借助于redis中的命令setnx(key, value)，key不存在就新增，存在就什么都不做。同时有多个客户端发送setnx命令，只有一个客户端可以成功，返回1（true）；其他的客户端返回0（false）。</p> <p><img src="/notes/assets/img/16066261922.a9aceec9.png" alt=""></p> <ol><li>多个客户端同时获取锁（setnx）。</li> <li>获取成功，执行业务逻辑，执行完成释放锁（del）。</li> <li>其他客户端等待重试。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加锁</span>
        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重试调用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> stock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//扣减库存</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">//解锁</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StockMapper</span><span class="token punctuation">,</span> <span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 也可以替换成while循环</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//扣减库存</span>
                    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//解锁</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/notes/assets/img/image-20230105100419482.28d12780.png" alt="image-20230105100419482"></p> <p><font color="red">出现问题：会出现死锁。</font></p> <h3 id="防死锁"><a href="#防死锁" class="header-anchor">#</a> 防死锁</h3> <p><strong>问题</strong>：setnx刚刚获取到锁，当前服务器宕机，导致del释放锁无法执行，进而导致锁无法锁无法释放（死锁）。</p> <p><strong>解决</strong>：给锁设置过期时间，自动释放锁。</p> <p>设置过期时间两种方式：</p> <ul><li>通过expire设置过期时间（缺乏原子性：如果在setnx和expire之间出现异常，锁也无法释放）。</li> <li>使用set指令设置过期时间：<code>set key value ex 3 nx</code>（既达到setnx的效果，又设置了过期时间）。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><font color="red">出现问题：会删除其他线程的锁。</font></p> <h3 id="防误删"><a href="#防误删" class="header-anchor">#</a> 防误删</h3> <p><strong>问题</strong>：可能会释放其他服务器的锁。</p> <p><strong>场景</strong>：如果业务逻辑的执行时间是7s。执行流程如下</p> <ol><li><p>index1业务逻辑没执行完，3秒后锁被自动释放。</p></li> <li><p>index2获取到锁，执行业务逻辑，3秒后锁被自动释放。</p></li> <li><p>index3获取到锁，执行业务逻辑。</p></li> <li><p>index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，导致index3的业务只执行1s就被别人释放。</p></li></ol> <p><strong>解决</strong>：setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁。</p> <p><img src="/notes/assets/img/1606707959639.73cda4dd.png" alt="1606707959639"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 也可以替换成while循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//先判断是否是自己的锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><font color="red">出现问题：删除缺乏原子性。</font></p> <p><strong>场景</strong>：</p> <ol><li>index1执行删除时，查询到的lock值确实和uuid相等。</li> <li>index1执行删除前，lock刚好过期时间已到，被redis自动释放。</li> <li>index2获取了lock。</li> <li>index1执行删除，此时会把index2的lock删除。</li></ol> <p><strong>解决方案</strong>：没有一个命令可以同时做到判断 + 删除，所有只能通过其他方式实现（<strong>LUA脚本</strong>）。</p> <h2 id="redis-中的-lua-脚本"><a href="#redis-中的-lua-脚本" class="header-anchor">#</a> Redis 中的 lua 脚本</h2> <h3 id="现实问题"><a href="#现实问题" class="header-anchor">#</a> 现实问题</h3> <p>redis采用单线程架构，可以保证单个命令的原子性，但是无法保证一组命令在高并发场景下的原子性。例如：</p> <p><img src="/notes/assets/img/1606711874388.1d5c03bf.png" alt="1606711874388"></p> <p>在串行场景下：A和B的值肯定都是3。</p> <p>在并发场景下：A和B的值可能在0-6之间。</p> <p><strong>极限情况下1</strong>：</p> <p><img src="/notes/assets/img/1606712580214.9bdd8aee.png" alt="1606712580214"></p> <p>则A的结果是0，B的结果是3。</p> <p><strong>极限情况下2</strong>：</p> <p><img src="/notes/assets/img/1606712697401.12002219.png" alt="1606712697401"></p> <p>则A和B的结果都是6</p> <h3 id="lua-介绍"><a href="#lua-介绍" class="header-anchor">#</a> Lua 介绍</h3> <p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> <p><strong>设计目的</strong></p> <p>​	其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p> <p><strong>Lua 特性</strong></p> <ul><li><strong>轻量级</strong>：它用标准C语言编写并以源代码形式开放，编译后仅仅一百余K，可以很方便的嵌入别的程序里。</li> <li><strong>可扩展</strong>：Lua提供了非常易于使用的扩展接口和机制：由宿主语言(通常是C或C++)提供这些功能，Lua可以使用它们，就像是本来就内置的功能一样。</li> <li>其它特性：
<ul><li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li> <li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li> <li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li> <li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li></ul></li></ul> <h3 id="lua-基本语法"><a href="#lua-基本语法" class="header-anchor">#</a> Lua 基本语法</h3> <p>对lua脚本感兴趣的同学，请移步到官方教程或者《菜鸟教程》。这里仅以redis中可能会用到的部分语法作介绍。</p> <div class="language-lua extra-class"><pre class="language-lua"><code>a <span class="token operator">=</span> <span class="token number">5</span>               <span class="token comment">-- 全局变量</span>
<span class="token keyword">local</span> b <span class="token operator">=</span> <span class="token number">5</span>         <span class="token comment">-- 局部变量， redis只支持局部变量</span>
a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>x      <span class="token comment">-- 等价于       a=10; b=2*x</span>
</code></pre></div><p>流程控制：</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span><span class="token punctuation">(</span> 布尔表达式 <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">then</span>
   <span class="token comment">--[ 在布尔表达式 1 为 true 时执行该语句块 --]</span>
<span class="token keyword">elseif</span><span class="token punctuation">(</span> 布尔表达式 <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">then</span>
   <span class="token comment">--[ 在布尔表达式 2 为 true 时执行该语句块 --]</span>
<span class="token keyword">else</span> 
   <span class="token comment">--[ 如果以上布尔表达式都不为 true 则执行该语句块 --]</span>
<span class="token keyword">end</span>
</code></pre></div><h3 id="redis-执行-lua-脚本"><a href="#redis-执行-lua-脚本" class="header-anchor">#</a> Redis 执行 Lua 脚本</h3> <p>在redis中需要通过eval命令执行lua脚本。</p> <p>格式：</p> <div class="language-lua extra-class"><pre class="language-lua"><code>EVAL script numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">...</span><span class="token punctuation">]</span> arg <span class="token punctuation">[</span>arg <span class="token punctuation">...</span><span class="token punctuation">]</span>
script：lua脚本字符串，这段Lua脚本不需要（也不应该）定义函数。
numkeys：lua脚本中KEYS数组的大小
key <span class="token punctuation">[</span>key <span class="token punctuation">...</span><span class="token punctuation">]</span>：KEYS数组中的元素
arg <span class="token punctuation">[</span>arg <span class="token punctuation">...</span><span class="token punctuation">]</span>：ARGV数组中的元素
</code></pre></div><p><strong>案例1</strong>：基本案例</p> <div class="language-shell extra-class"><pre class="language-shell"><code>EVAL <span class="token string">&quot;return 10&quot;</span> <span class="token number">0</span>
</code></pre></div><p>输出：(integer) 10</p> <p><strong>案例2</strong>：动态传参</p> <div class="language-shell extra-class"><pre class="language-shell"><code>EVAL <span class="token string">&quot;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&quot;</span> <span class="token number">5</span> <span class="token number">10</span> <span class="token number">20</span> <span class="token number">30</span> <span class="token number">40</span> <span class="token number">50</span> <span class="token number">60</span> <span class="token number">70</span> <span class="token number">80</span> <span class="token number">90</span>
<span class="token comment"># 输出：10 20 60 70</span>
<span class="token comment"># 5 值得是KEY的个数，那么10 20 30 40 50 都是 KEY ，而 60 70 80 90 为 ARG</span>

EVAL <span class="token string">&quot;if KEYS[1] &gt; ARGV[1] then return 1 else return 0 end&quot;</span> <span class="token number">1</span> <span class="token number">10</span> <span class="token number">20</span>
<span class="token comment"># 输出：0</span>

EVAL <span class="token string">&quot;if KEYS[1] &gt; ARGV[1] then return 1 else return 0 end&quot;</span> <span class="token number">1</span> <span class="token number">20</span> <span class="token number">10</span>
<span class="token comment"># 输出：1</span>
</code></pre></div><p>~~传入了两个参数10和20，KEYS的长度是1，所以KEYS中有一个元素10，剩余的一个20就是ARGV数组的元素。</p> <p><strong>案例3</strong>：执行redis类库方法</p> <p>redis.call()中的redis是redis中提供的lua脚本类库，仅在redis环境中可以使用该类库。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">set</span> aaa <span class="token number">10</span>  -- 设置一个aaa值为10
EVAL <span class="token string">&quot;return redis.call('get', 'aaa')&quot;</span> <span class="token number">0</span>
<span class="token comment"># 通过return把call方法返回给redis客户端，打印：&quot;10&quot;</span>
</code></pre></div><p>注意：**脚本里使用的所有键都应该由 KEYS 数组来传递。**但并不是强制性的，代价是这样写出的脚本不能被 Redis 集群所兼容。</p> <p><strong>案例4</strong>：给redis类库方法动态传参</p> <div class="language-shell extra-class"><pre class="language-shell"><code>EVAL <span class="token string">&quot;return redis.call('set', KEYS[1], ARGV[1])&quot;</span> <span class="token number">1</span> bbb <span class="token number">20</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="1600610957600"></p> <p><strong>案例5</strong>：pcall函数的使用</p> <div class="language-shell extra-class"><pre class="language-shell"><code>-- 当call<span class="token punctuation">(</span><span class="token punctuation">)</span> 在执行命令的过程中发生错误时，脚本会停止执行，并返回一个脚本错误，输出错误信息
EVAL <span class="token string">&quot;return redis.call('sets', KEYS[1], ARGV[1]), redis.call('set', KEYS[2], ARGV[2])&quot;</span> <span class="token number">2</span> bbb ccc <span class="token number">20</span> <span class="token number">30</span>
-- pcall函数不影响后续指令的执行
EVAL <span class="token string">&quot;return redis.pcall('sets', KEYS[1], ARGV[1]), redis.pcall('set', KEYS[2], ARGV[2])&quot;</span> <span class="token number">2</span> bbb ccc <span class="token number">20</span> <span class="token number">30</span>
</code></pre></div><p><img src="/notes/assets/img/image-20230105173707009.f967bbe4.png" alt="image-20230105173707009"></p> <h3 id="使用-lua-保证删除原子性"><a href="#使用-lua-保证删除原子性" class="header-anchor">#</a> 使用 Lua 保证删除原子性</h3> <p>删除脚本：</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span> <span class="token keyword">end</span>
</code></pre></div><p>代码实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 也可以替换成while循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//先判断是否是自己的锁</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">&quot;deduct:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="可重入锁"><a href="#可重入锁" class="header-anchor">#</a> 可重入锁</h2> <p>由于上述加锁命令使用了 SETNX ，一旦键存在就无法再设置成功，这就导致后续同一线程内继续加锁，将会加锁失败。当一个线程执行一段代码成功获取锁之后，继续执行时，又遇到加锁的子任务代码，可重入性就保证线程能继续执行，而不可重入就是需要等待锁释放之后，再次获取锁成功，才能继续往下执行。</p> <p>用一段 Java 代码解释可重入：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// pass</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假设线程 X 在 a 方法获取锁之后，调用 b 方法，如果此时不可重入，线程就必须等待释放，再次争抢锁。但锁明明是被 X 线程拥有，却还需要等待自己释放锁，然后再去抢锁，这看起来就很奇怪，我释放我自己。</p> <p>可重入性就可以解决这个尴尬的问题，当线程拥有锁之后，往后再遇到加锁方法，直接将加锁次数加 1，然后再执行方法逻辑。退出加锁方法之后，加锁次数再减 1，当加锁次数为 0 时，锁才被真正的释放。</p> <p>可以看到可重入锁最大特性就是计数，计算加锁的次数。所以当可重入锁需要在分布式环境实现时，我们也就需要统计加锁次数。</p> <h3 id="举个例子-reentrantlock"><a href="#举个例子-reentrantlock" class="header-anchor">#</a> 举个例子 ReentrantLock</h3> <p>ReentrantLock 底层主要利用CAS+AQS队列来实现。它支持公平锁和非公平锁，两者的实现类似。</p> <h4 id="cas-理解"><a href="#cas-理解" class="header-anchor">#</a> CAS 理解</h4> <div class="language- extra-class"><pre class="language-text"><code>cas，比较并交换。cas算法的过程是这样的，cas包括有三个值：
 v表示要更新的变量
 e表示预期值，就是旧的值
 n表示新值
更新时，判断只有e的值等于v变量的当前旧值时，才会将n新值赋给v，更新为新值。
否则，则认为已经有其他线程更新过了，则当前线程什么都不操作，最后cas放回当前v变量的真实值。
Java 中调用的是 Unsafe.class 中的 compareAndSwap 方法来实现的，这个是一个底层类，直接调用的硬件。看不到源码。
</code></pre></div><p>CAS是一种<strong>乐观锁</strong>，它抱着乐观的态度认为自己一定可以成果。当多个线程同时使用CAS操作一个变量时，<font color="red">只有一个会胜出</font>，并成功更新，其余均会失败。失败的线程不会被挂起，仅是被告知失败，并且允许再次尝试，当然也允许失败的线程放弃操作。基于这样的原理， CAS操作即使没有锁，也可以发现其他线程对当前线程的干扰，并进行恰当的处理。</p> <p>CAS会导致“<strong>ABA问题</strong>”。CAS算法实现一个重要前提需要取出内存中某时刻的数据，而在下时 刻比较并替换，那么在这个时间差类会导致数据的变化。</p> <p>比如：</p> <blockquote><p>一个线程one从内存位置V中取出A，这时候另一个线程two也从内存中取出 A，并且 two 进行了一些操作变成了 B,然后 two 又将 V 位置的数据变成 A，这时候线程one进行CAS操 作发现内存中仍然是A，然后one操作成功。</p></blockquote> <p>尽管线程one的CAS操作成功，但是不代表这个过程就是没有问题的。</p> <p>部分乐观锁的实现是通过版本号（version）的方式来解决ABA问题，乐观锁每次在执行数据的修改操作时，都会带上一个版本号，一旦版本号和数据的版本号一致就可以执行修改操作并对版本号执行 +1 操作，否则就执行失败。因为每次操作的版本号都会随之增加，所以不会出现ABA问题，因为版本号只会增加不会减少。</p> <h4 id="aqs-理解"><a href="#aqs-理解" class="header-anchor">#</a> AQS 理解</h4> <p>AQS，即 AbstractQueuedSynchronizer, 队列同步器，它是 Java 并发用来构建锁和其他同步组件的基础框架。</p> <p>AQS 是一个抽象类，主是是以继承的方式使用。AQS 本身是没有实现任何同步接口的，它仅仅只是定义了同步状态的获取和释放的方法来供自定义的同步组件的使用。一般是同步组件的静态内部类，即通过组合的方式使用。</p> <p>AQS定义了一套多线程访问共享资源的同步器框架，许多同步类实现都依赖于它，如常用ReentrantLock/Semaphore/CountDownLatch它维护了一个volatile int state（代表共享资源）和一个<strong>FIFO</strong>（先进先出）线程等待队列（多线程争用资源被阻塞时会进入此队列）。</p> <h4 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h4> <p><strong>加锁</strong></p> <p>通过 lock 获取锁，由于构造方法中创建的是非公平锁的实例。其实调用的是 NonfairSync 中的 lock 方法。</p> <p><img src="/notes/assets/img/image-20230109102126890.ad072ab0.png" alt="image-20230109102126890"></p> <p><img src="/notes/assets/img/image-20230109102333784.bf768261.png" alt="image-20230109102333784"></p> <p>可以看到 NonfairSync 继承了 Sync 而 Sync 继承的就是 <strong>AQS 同步器</strong>类。</p> <p><img src="/notes/assets/img/image-20230109102657660.d585a2b6.png" alt=""></p> <p><img src="/notes/assets/img/image-20230109102612223.50fdd736.png" alt="image-20230109102612223"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 获得锁</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
      * 若通过CAS设置变量State（同步状态）成功，也就是获取锁成功，则将当前线程设置为独占线程。
      * 若通过CAS设置变量State（同步状态）失败，也就是获取锁失败，则进入Acquire方法进行后续处理。
      */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 比较并设置状态成功，状态0表示锁没有被占用</span>
        <span class="token comment">// 把当前线程设置独占了锁</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token comment">// 锁已经被占用，或者set失败</span>
        <span class="token comment">// 以独占模式获取对象，忽略中断</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Acquire方法是FairSync和UnfairSync的父类AQS中的核心方法。</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 acquire 中会首先要获取锁，<strong>如果获取锁失败了，就将当前线程添加到等待队列。</strong> tryAcquire 的实现是在 NonfairSync 中实现的，如果没有获取到锁且没有添加到队列则直接中断线程。</p> <p><img src="/notes/assets/img/image-20230109105242215.eb73e5a0.png" alt="image-20230109105242215"></p> <p><img src="/notes/assets/img/image-20230109144542035.57f55a3a.png" alt="image-20230109144542035"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 非公平方式获取</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前线程</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取状态</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 表示没有线程正在竞争该锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 比较并设置状态成功，状态0表示锁没有被占用</span>
            <span class="token comment">// 设置当前线程独占</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 成功</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当前线程拥有该锁</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span> <span class="token comment">// 增加重入次数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置状态</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 成功</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">// 失败</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><font color="red">tryAcquire 中如果获取到了锁则返回 True，而 acquire 方法中取的是“非”，就意味着如果获取到了锁就直接结束 if 判断。否则才要进入等待队列。</font></p></blockquote> <p><img src="/notes/assets/img/image-20230109160843331.df9e48d3.png" alt="image-20230109160843331"></p> <p><img src="/notes/assets/img/image-20230109161214766.5acc56d1.png" alt="image-20230109161214766"></p> <p><strong>解锁</strong></p> <p><img src="/notes/assets/img/image-20230109164422097.2aa4e189.png" alt="image-20230109164422097"></p> <p><img src="/notes/assets/img/image-20230109164615706.a581f06f.png" alt="image-20230109164615706"></p> <h3 id="redis-可重入锁"><a href="#redis-可重入锁" class="header-anchor">#</a> Redis 可重入锁</h3> <p>解决方案：Lua + Hash。</p> <h4 id="加锁"><a href="#加锁" class="header-anchor">#</a> 加锁</h4> <p>Redis 提供了 Hash （哈希表）这种可以存储键值对数据结构。所以我们可以使用 Redis Hash 存储的锁的重入次数，然后利用 lua 脚本判断逻辑。</p> <ol><li>判断锁是否存在（exists），则直接获取锁 <code>hset key field value</code>。</li> <li>如果锁存在则判断是否自己的锁（hexists），如果是自己的锁则重入：<code>hincrby key field increment</code></li> <li>否则重试：递归 循环</li></ol> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'exists'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">or</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexists'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">then</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
</code></pre></div><p>假设值为：KEYS:[<strong>lock</strong>]， ARGV[<strong>uuid</strong>, <strong>expire</strong>]</p> <h4 id="解锁"><a href="#解锁" class="header-anchor">#</a> 解锁</h4> <ol><li>判断自己的锁是否存在（hexists），不存在则返回 nil。</li> <li>如果自己的锁存在，则减1（hincrby -1），判断减 1 后的值是否为 0，为 0 则释放锁（del）并返回 1。</li> <li>不为 0，返回 0。</li></ol> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexists'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span>
<span class="token keyword">elseif</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token keyword">then</span> 
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> 
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><h3 id="代码改造"><a href="#代码改造" class="header-anchor">#</a> 代码改造</h3> <p>由于加解锁代码量相对较多，这里可以封装成一个工具类：</p> <p><img src="data:image/png;base64,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" alt="image-20230111105458781"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 工厂类，方便拓展各种锁的实现
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLockFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DistributedRedisLock</span> <span class="token function">getRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DistributedRedisLock</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">,</span> key<span class="token punctuation">,</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>锁的实现可以参照 JUC 包中 Lock 接口的实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 基于 Redis 的分布式锁的实现
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> field<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expire<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">TimeUnit</span> tu <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">;</span>

    <span class="token comment">//需要一个构造方法将key、field、expire传递过来还有RedisTemplate</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedRedisLock</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expire <span class="token operator">=</span> expire<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">tryLock</span><span class="token punctuation">(</span>expire<span class="token punctuation">,</span> tu<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加锁 无时效
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果不传时间就是永久</span>
            <span class="token keyword">return</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> tu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加锁 有时效
     * if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1
     * 		then
     * 			redis.call('hincrby', KEYS[1], ARGV[1], 1)
     * 			redis.call('expire', KEYS[1], ARGV[2])
     * 			return 1
     * 		else
     * 			return 0
     * 		end
     * @param time 时间
     * @param unit 单位
     * @return
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> l <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回值0和返回值1是Java中额Boolean类型</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1 then redis.call('hincrby', KEYS[1], ARGV[1], 1) redis.call('expire', KEYS[1], ARGV[2]) return 1 else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//会返回三个值 null 0 1，所以选择 Long 类型更好</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('hexists', KEYS[1], ARGV[1]) == 0 then return nil elseif redis.call('hincrby', KEYS[1], ARGV[1], -1) == 0 then return redis.call('del', KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> res <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明释放的不是自己的锁</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@NotNull</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DistributedLockFactory</span> distributedLockFactory<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DistributedRedisLock</span> lock <span class="token operator">=</span> distributedLockFactory<span class="token punctuation">.</span><span class="token function">getRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;mylock&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使用测试"><a href="#使用测试" class="header-anchor">#</a> 使用测试</h4> <p><img src="/notes/assets/img/image-20230111110814335.e6841210.png" alt="image-20230111110814335"></p> <h4 id="出现问题"><a href="#出现问题" class="header-anchor">#</a> 出现问题</h4> <p>测试可重入性的时候发现在执行到 test  的时候会出现阻塞现象，必须等到锁释放的才能继续，这个原因是在调用getRedisLock每次都会生成一个DistributedRedisLock实例，所以导致每次UUID都不一致。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DistributedRedisLock</span> lock <span class="token operator">=</span> distributedLockFactory<span class="token punctuation">.</span><span class="token function">getRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;mylock&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 测试 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DistributedRedisLock</span> lock <span class="token operator">=</span> distributedLockFactory<span class="token punctuation">.</span><span class="token function">getRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;mylock&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;test的业务开始执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h4> <p>在初始化的时候将UUID传递过去，如果只用线程名称作为Field的话，可能会造成多部署的时候，线程名称重复导致出问题。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 工厂类，方便拓展各种锁的实现
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLockFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> uuid<span class="token punctuation">;</span>

    <span class="token comment">//在初始化的时候就将UUID生成</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedLockFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DistributedRedisLock</span> <span class="token function">getRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DistributedRedisLock</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">,</span> key<span class="token punctuation">,</span> expire<span class="token punctuation">,</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 基于 Redis 的分布式锁的实现
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> field<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> expire<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> tu <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">;</span>

    <span class="token comment">//需要一个构造方法将key、field、expire传递过来还有RedisTemplate</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedRedisLock</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expire<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> uuid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expire <span class="token operator">=</span> expire<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/**
     * 加锁 有时效
     * if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1
     * 		then
     * 			redis.call('hincrby', KEYS[1], ARGV[1], 1)
     * 			redis.call('expire', KEYS[1], ARGV[2])
     * 			return 1
     * 		else
     * 			return 0
     * 		end
     * @param time 时间
     * @param unit 单位
     * @return
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> l <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回值0和返回值1是Java中额Boolean类型</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1 then redis.call('hincrby', KEYS[1], ARGV[1], 1) redis.call('expire', KEYS[1], ARGV[2]) return 1 else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//会返回三个值 null 0 1，所以选择 Long 类型更好</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('hexists', KEYS[1], ARGV[1]) == 0 then return nil elseif redis.call('hincrby', KEYS[1], ARGV[1], -1) == 0 then return redis.call('del', KEYS[1]) else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> res <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明释放的不是自己的锁</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//将线程名称拼上UUID防止冲突</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="自动续期"><a href="#自动续期" class="header-anchor">#</a> 自动续期</h3> <p>如果业务没有执行完毕，但是锁自动释放，导致其他线程获取锁造成一系列的问题。所以要使得锁和业务同步存在。</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexists'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
<span class="token keyword">then</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> 
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 基于 Redis 的分布式锁的实现
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> field<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> expire<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> tu <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">;</span>

    <span class="token comment">//需要一个构造方法将key、field、expire传递过来还有RedisTemplate</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedRedisLock</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> expire<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> uuid <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expire <span class="token operator">=</span> expire<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">/**
     * 加锁 有时效
     * if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1
     * 		then
     * 			redis.call('hincrby', KEYS[1], ARGV[1], 1)
     * 			redis.call('expire', KEYS[1], ARGV[2])
     * 			return 1
     * 		else
     * 			return 0
     * 		end
     * @param time 时间
     * @param unit 单位
     * @return
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> l <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回值0和返回值1是Java中额Boolean类型</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('exists', KEYS[1]) == 0 or redis.call('hexists', KEYS[1], ARGV[1]) == 1 then redis.call('hincrby', KEYS[1], ARGV[1], 1) redis.call('expire', KEYS[1], ARGV[2]) return 1 else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//新增自动续期</span>
        <span class="token function">autoRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 自动续期
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autoRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">&quot;if redis.call('hexists', KEYS[1], ARGV[1]) == 1 then return redis.call('expire', KEYS[1], ARGV[2]) else return 0 end&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">/*
            task – 要安排的任务。
            delay – 在执行任务之前延迟（以毫秒为单位）。
            period – 连续任务执行之间的时间（以毫秒为单位）。
         */</span>
        <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> field<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>expire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//如果成功继续重置</span>
                    <span class="token function">autoRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;续期了！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> expire <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> expire <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="红锁算法"><a href="#红锁算法" class="header-anchor">#</a> 红锁算法</h2> <p>redis集群状态下的问题：</p> <ol><li>客户端 A 从 master 获取到锁。</li> <li>在 master 将锁同步到 slave 之前，master 宕掉了。</li> <li>slave 节点被晋级为 master 节点。</li> <li>客户端B取得了同一个资源被客户端A已经获取到的另外一个锁。</li></ol> <p><strong>安全失效</strong>！</p> <p>解决集群下锁失效，参照redis官方网站针对redlock文档：https://redis.io/topics/distlock</p> <p><img src="/notes/assets/img/image-20230113165909659.da046351.png" alt="image-20230113165909659"></p> <h2 id="redisson-中的分布式锁"><a href="#redisson-中的分布式锁" class="header-anchor">#</a> Redisson 中的分布式锁</h2> <p><img src="/notes/assets/img/image-20220501155501783.c6d7dd29.png" alt="image-20220501155501783"></p> <h3 id="redisson-是什么"><a href="#redisson-是什么" class="header-anchor">#</a> Redisson 是什么</h3> <p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p> <p><img src="/notes/assets/img/1568176834908.32bd17c8.png" alt="1568176834908"></p> <p>官方文档地址：<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">目录 · redisson/redisson Wiki · GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p><a href="/notes/redis/Redis 主从复制.html#安装"><strong>Redis Sentinel 安装</strong></a></p> <h3 id="可重入锁-reentrant-lock"><a href="#可重入锁-reentrant-lock" class="header-anchor">#</a> 可重入锁（Reentrant Lock）</h3> <p>基于 Redis 的 Redisson 分布式可重入锁<code>RLock</code> Java对象实现了<code>java.util.concurrent.locks.Lock</code>接口。</p> <p>大家都知道，如果负责储存这个分布式锁的Redisson节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗检查锁的超时时间是30秒钟，也可以通过修改<code>Config.lockWatchdogTimeout</code>来另行指定。</p> <p><code>RLock</code>对象完全符合Java的Lock规范。也就是说只有拥有锁的进程才能解锁，其他进程解锁则会抛出<code>IllegalMonitorStateException</code>错误。</p> <p>另外 Redisson 还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p> <ol><li><p>添加依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.18.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>添加配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Redisson配置类
 *  采用哨兵模式
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedissonProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * redisson协议前缀
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SCHEMA_PREFIX <span class="token operator">=</span> <span class="token string">&quot;redis://&quot;</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonProperties</span> redissonProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSentinelServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSentinelAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMasterName</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addSentinelAddress</span><span class="token punctuation">(</span><span class="token function">getNodes</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSentinelPassword</span><span class="token punctuation">(</span>redissonProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getNodes</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>nodes<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> SCHEMA_PREFIX <span class="token operator">+</span> nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> newNodes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>代码中使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;mylock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> stock <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stock<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//扣减库存</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="redisson可重入锁的底层代码"><a href="#redisson可重入锁的底层代码" class="header-anchor">#</a> Redisson可重入锁的底层代码</h4> <p><img src="/notes/assets/img/image-20230307095210402.b573fd64.png" alt="image-20230307095210402"></p> <blockquote><p>此处的tryAcquire方法不是AQS中的方法</p></blockquote> <p><img src="/notes/assets/img/image-20230307100630318.213d706e.png" alt="image-20230307100630318"></p> <p><img src="/notes/assets/img/image-20230307100745054.f0d578e5.png" alt="image-20230307100745054"></p> <p><img src="/notes/assets/img/image-20230307101351953.6073d77c.png" alt="image-20230307101351953"></p> <p><img src="/notes/assets/img/image-20230307102020112.1f994906.png" alt="image-20230307102020112"></p> <blockquote><p>详细可看：<a href="https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8" target="_blank" rel="noopener noreferrer">8. 分布式锁和同步器 · redisson/redisson Wiki (github.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="公平锁-fair-lock"><a href="#公平锁-fair-lock" class="header-anchor">#</a> 公平锁（Fair Lock）</h3> <p>基于 Redis 的 Redisson 分布式可重入公平锁也是实现了<code>java.util.concurrent.locks.Lock</code>接口的一种<code>RLock</code>对象。同时还提供了<a href="http://static.javadoc.io/org.redisson/redisson/3.18.1/org/redisson/api/RLockAsync.html" target="_blank" rel="noopener noreferrer">异步（Async）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://static.javadoc.io/org.redisson/redisson/3.18.1/org/redisson/api/RLockReactive.html" target="_blank" rel="noopener noreferrer">反射式（Reactive）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="http://static.javadoc.io/org.redisson/redisson/3.18.1/org/redisson/api/RLockRx.html" target="_blank" rel="noopener noreferrer">RxJava2标准<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的接口。它保证了当多个 Redisson 客户端线程同时请求加锁时，优先分配给先发出请求的线程。所有请求线程会在一个队列中排队，当某个线程出现宕机时，Redisson 会等待5秒后继续下一个线程，也就是说如果前面有5个线程都处于等待状态，那么后面的线程会等待至少25秒。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RLock</span> fairLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getFairLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最常见的使用方法</span>
fairLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 10秒钟以后自动解锁</span>
<span class="token comment">// 无需调用unlock方法手动解锁</span>
fairLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> fairLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
fairLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="联锁-multilock"><a href="#联锁-multilock" class="header-anchor">#</a> 联锁（MultiLock）</h3> <p>基于Redis的Redisson分布式联锁<a href="http://static.javadoc.io/org.redisson/redisson/3.18.0/org/redisson/RedissonMultiLock.html" target="_blank" rel="noopener noreferrer"><code>RedissonMultiLock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对象可以将多个<code>RLock</code>对象关联为一个联锁，每个<code>RLock</code>对象实例可以来自于不同的Redisson实例。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonInstance1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonInstance2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonInstance3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">RedissonMultiLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同时加锁：lock1 lock2 lock3</span>
<span class="token comment">// 所有的锁都上锁成功才算成功。</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>大家都知道，如果负责储存某些分布式锁的某些Redis节点宕机以后，而且这些锁正好处于锁住的状态时，这些锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改<a href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92" target="_blank" rel="noopener noreferrer">Config.lockWatchdogTimeout<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来另行指定。</p> <p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedissonMultiLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 给lock1，lock2，lock3加锁，如果没有手动解开的话，10秒钟后将会自动解开</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 为加锁等待100秒时间，并在加锁成功10秒钟后自动解开</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="红锁-redlock"><a href="#红锁-redlock" class="header-anchor">#</a> 红锁（RedLock）</h3> <p>基于Redis的Redisson红锁<code>RedissonRedLock</code>对象实现了<a href="http://redis.cn/topics/distlock.html" target="_blank" rel="noopener noreferrer">Redlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>介绍的加锁算法。该对象也可以用来将多个<code>RLock</code>对象关联为一个红锁，每个<code>RLock</code>对象实例可以来自于不同的Redisson实例。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonInstance1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonInstance2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonInstance3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">RedissonRedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonRedLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同时加锁：lock1 lock2 lock3</span>
<span class="token comment">// 红锁在大部分节点上加锁成功就算成功。半数以上</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>大家都知道，如果负责储存某些分布式锁的某些Redis节点宕机以后，而且这些锁正好处于锁住的状态时，这些锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改<a href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92" target="_blank" rel="noopener noreferrer">Config.lockWatchdogTimeout<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来另行指定。</p> <p>另外Redisson还通过加锁的方法提供了<code>leaseTime</code>的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedissonRedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonRedLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 给lock1，lock2，lock3加锁，如果没有手动解开的话，10秒钟后将会自动解开</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 为加锁等待100秒时间，并在加锁成功10秒钟后自动解开</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="读写锁-readwritelock"><a href="#读写锁-readwritelock" class="header-anchor">#</a> 读写锁（ReadWriteLock）</h3> <p>基于Redis的Redisson分布式可重入读写锁<a href="http://static.javadoc.io/org.redisson/redisson/3.4.3/org/redisson/api/RReadWriteLock.html" target="_blank" rel="noopener noreferrer"><code>RReadWriteLock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Java对象实现了<code>java.util.concurrent.locks.ReadWriteLock</code>接口。其中读锁和写锁都继承了<a href="https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8#81-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81reentrant-lock" target="_blank" rel="noopener noreferrer">RLock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口。</p> <p>分布式可重入读写锁允许同时有多个读锁和一个写锁处于加锁状态。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RReadWriteLock</span> rwlock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyRWLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最常见的使用方法</span>
rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 10秒钟以后自动解锁</span>
<span class="token comment">// 无需调用unlock方法手动解锁</span>
rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> rwlock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
<span class="token keyword">boolean</span> res <span class="token operator">=</span> rwlock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>打开开两个浏览器窗口测试：</p> <ul><li>同时访问写：一个写完之后，等待一会儿（约10s），另一个写开始</li> <li>同时访问读：不用等待</li> <li>先写后读：读要等待（约10s）写完成</li> <li>先读后写：写要等待（约10s）读完成</li></ul> <h3 id="信号量-semaphore"><a href="#信号量-semaphore" class="header-anchor">#</a> 信号量（Semaphore）</h3> <p>基于Redis的Redisson的分布式信号量（<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphore.html" target="_blank" rel="noopener noreferrer">Semaphore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）Java对象<code>RSemaphore</code>采用了与<code>java.util.concurrent.Semaphore</code>相似的接口和用法。同时还提供了<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreAsync.html" target="_blank" rel="noopener noreferrer">异步（Async）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreReactive.html" target="_blank" rel="noopener noreferrer">反射式（Reactive）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RSemaphoreRx.html" target="_blank" rel="noopener noreferrer">RxJava2标准<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的接口。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSemaphore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RSemaphore</span> semaphore <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">&quot;semaphore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    semaphore<span class="token punctuation">.</span><span class="token function">trySetPermits</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置信号量</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;开始执行了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;执行完成了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>多次请求发现只有三个请求被放行，其他的请求被排队，直到前面执行完毕后。</p> <blockquote><p>但是重新设置trySetPermits()，发现并未被更改，应该是Redis的BUG。</p></blockquote> <h3 id="闭锁-countdownlatch"><a href="#闭锁-countdownlatch" class="header-anchor">#</a> 闭锁（CountDownLatch）</h3> <p>基于Redisson的Redisson分布式闭锁（<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/api/RCountDownLatch.html" target="_blank" rel="noopener noreferrer">CountDownLatch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）Java对象<code>RCountDownLatch</code>采用了与<code>java.util.concurrent.CountDownLatch</code>相似的接口和用法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;latch&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    testService<span class="token punctuation">.</span><span class="token function">testLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;班长锁门了&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;countDown&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testCountDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    testService<span class="token punctuation">.</span><span class="token function">testCountDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;有一个学生出门了&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RCountDownLatch</span> latch <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;latch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    latch<span class="token punctuation">.</span><span class="token function">trySetCount</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCountDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RCountDownLatch</span> latch <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">&quot;latch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>latch方法会一直等待countDown方法全部释放完后才会响应，过程中一直阻塞。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">9/14/2023, 1:18:45 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/distributed-lock/" class="prev router-link-active">
        传统锁回顾
      </a></span> <span class="next"><a href="/notes/distributed-lock/基于 Zookeeper 实现分布式锁.html">
        基于 Zookeeper 实现分布式锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/notes/assets/js/app.4394edef.js" defer></script><script src="/notes/assets/js/3.499ba1d5.js" defer></script><script src="/notes/assets/js/5.a09c7da9.js" defer></script>
  </body>
</html>
