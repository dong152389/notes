(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{1078:function(s,t,a){s.exports=a.p+"assets/img/20190602220034.b9951912.png"},1079:function(s,t,a){s.exports=a.p+"assets/img/20190602220202.2413be5f.png"},1080:function(s,t,a){s.exports=a.p+"assets/img/20190427104124213.434d86ed.png"},1610:function(s,t,a){"use strict";a.r(t);var e=a(26),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"kubernetes-高可用集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-高可用集群"}},[s._v("#")]),s._v(" Kubernetes 高可用集群")]),s._v(" "),e("h2",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),e("p",[s._v("在实际生产中我们需要部署 "),e("strong",[s._v("高可用集群")])]),s._v(" "),e("h2",{attrs:{id:"统一环境配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#统一环境配置"}},[s._v("#")]),s._v(" 统一环境配置")]),s._v(" "),e("h3",{attrs:{id:"节点配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#节点配置"}},[s._v("#")]),s._v(" 节点配置")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("主机名")]),s._v(" "),e("th",[s._v("IP")]),s._v(" "),e("th",[s._v("角色")]),s._v(" "),e("th",[s._v("系统")]),s._v(" "),e("th",[s._v("CPU/内存")]),s._v(" "),e("th",[s._v("磁盘")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("kubernetes-master-01")]),s._v(" "),e("td",[s._v("192.168.141.150")]),s._v(" "),e("td",[s._v("Master")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核2G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("kubernetes-master-02")]),s._v(" "),e("td",[s._v("192.168.141.151")]),s._v(" "),e("td",[s._v("Master")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核2G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("kubernetes-master-03")]),s._v(" "),e("td",[s._v("192.168.141.152")]),s._v(" "),e("td",[s._v("Master")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核2G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("kubernetes-node-01")]),s._v(" "),e("td",[s._v("192.168.141.160")]),s._v(" "),e("td",[s._v("Node")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核4G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("kubernetes-node-02")]),s._v(" "),e("td",[s._v("192.168.141.161")]),s._v(" "),e("td",[s._v("Node")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核4G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("kubernetes-node-03")]),s._v(" "),e("td",[s._v("192.168.141.162")]),s._v(" "),e("td",[s._v("Node")]),s._v(" "),e("td",[s._v("Ubuntu Server 18.04")]),s._v(" "),e("td",[s._v("2核4G")]),s._v(" "),e("td",[s._v("20G")])]),s._v(" "),e("tr",[e("td",[s._v("Kubernetes VIP")]),s._v(" "),e("td",[s._v("192.168.141.200")]),s._v(" "),e("td",[s._v("-")]),s._v(" "),e("td",[s._v("-")]),s._v(" "),e("td",[s._v("-")]),s._v(" "),e("td",[s._v("-")])])])]),s._v(" "),e("h3",{attrs:{id:"对操作系统的配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#对操作系统的配置"}},[s._v("#")]),s._v(" 对操作系统的配置")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：以下步骤请在制作 VMware 镜像时一并完成，避免逐台安装的痛苦")])]),s._v(" "),e("h4",{attrs:{id:"关闭交换空间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#关闭交换空间"}},[s._v("#")]),s._v(" 关闭交换空间")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("swapoff -a\n")])])]),e("h4",{attrs:{id:"避免开机启动交换空间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#避免开机启动交换空间"}},[s._v("#")]),s._v(" 避免开机启动交换空间")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注释 swap 开头的行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/fstab\n")])])]),e("h4",{attrs:{id:"关闭防火墙"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#关闭防火墙"}},[s._v("#")]),s._v(" 关闭防火墙")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ufw disable\n")])])]),e("h4",{attrs:{id:"配置-dns"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-dns"}},[s._v("#")]),s._v(" 配置 DNS")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 取消 DNS 行注释，并增加 DNS 配置如：114.114.114.114，修改后重启下计算机")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/systemd/resolved.conf\n")])])]),e("h4",{attrs:{id:"安装-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker"}},[s._v("#")]),s._v(" 安装 Docker")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新软件源")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装所需依赖")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" -y "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" apt-transport-https ca-certificates "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" software-properties-common\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 GPG 证书")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新增软件源信息")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" add-apt-repository "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu '),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("lsb_release -cs"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(' stable"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次更新软件源")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" -y update\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 Docker CE 版")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" -y "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" docker-ce\n")])])]),e("h4",{attrs:{id:"配置-docker-加速器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-docker-加速器"}},[s._v("#")]),s._v(" 配置 Docker 加速器")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：国内镜像加速器可能会很卡，请替换成你自己阿里云镜像加速器，地址如："),e("code",[s._v("https://yourself.mirror.aliyuncs.com")]),s._v("，在阿里云控制台的 "),e("strong",[s._v("容器镜像服务 -> 镜像加速器")]),s._v(" 菜单中可以找到")])]),s._v(" "),e("p",[s._v("在 "),e("code",[s._v("/etc/docker/daemon.json")]),s._v(" 中写入如下内容（如果文件不存在请新建该文件）")]),s._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[s._v('"registry-mirrors"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.docker-cn.com"')]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),e("h4",{attrs:{id:"安装-kubeadm-kubelet-kubectl"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-kubeadm-kubelet-kubectl"}},[s._v("#")]),s._v(" 安装 kubeadm，kubelet，kubectl")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装系统工具")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y apt-transport-https\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 GPG 证书")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" apt-key "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 写入软件源；注意：我们用系统代号为 bionic，但目前阿里云不支持，所以沿用 16.04 的 xenial")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" EOF "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/apt/sources.list.d/kubernetes.list\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" EOF\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y kubelet kubeadm kubectl\n")])])]),e("h4",{attrs:{id:"同步时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#同步时间"}},[s._v("#")]),s._v(" 同步时间")]),s._v(" "),e("p",[e("strong",[s._v("设置时区")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("dpkg-reconfigure tzdata\n")])])]),e("p",[s._v("选择 "),e("strong",[s._v("Asia（亚洲）")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1078),alt:"img"}})]),s._v(" "),e("p",[s._v("选择 "),e("strong",[s._v("Shanghai（上海）")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1079),alt:"img"}})]),s._v(" "),e("p",[e("strong",[s._v("时间同步")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 ntpdate")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ntpdate\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置系统时间与网络时间同步（cn.pool.ntp.org 位于中国的公共 NTP 服务器）")]),s._v("\nntpdate cn.pool.ntp.org\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将系统时间写入硬件时间")]),s._v("\nhwclock --systohc\n")])])]),e("p",[e("strong",[s._v("确认时间")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下（自行对照与系统时间是否一致）")]),s._v("\nSun Jun  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":02:35 CST "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("\n")])])]),e("h4",{attrs:{id:"配置-ipvs"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-ipvs"}},[s._v("#")]),s._v(" 配置 IPVS")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装系统工具")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y ipset ipvsadm\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置并加载 IPVS 模块")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/sysconfig/modules/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/sysconfig/modules/ipvs.modules\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入如下内容")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack_ipv4\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行脚本，注意：如果重启则需要重新运行该脚本")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("755")]),s._v(" /etc/sysconfig/modules/ipvs.modules "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" /etc/sysconfig/modules/ipvs.modules "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" lsmod "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -e ip_vs -e nf_conntrack_ipv4\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行脚本输出如下")]),s._v("\nip_vs_sh               "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nip_vs_wrr              "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nip_vs_rr               "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nip_vs                 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("147456")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" ip_vs_rr,ip_vs_sh,ip_vs_wrr\nnf_conntrack_ipv4      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\nnf_defrag_ipv4         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" nf_conntrack_ipv4\nnf_conntrack          "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_ipv4,nf_nat,ipt_MASQUERADE,nf_nat_ipv4,nf_conntrack_netlink,ip_vs\nlibcrc32c              "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" nf_conntrack,nf_nat,raid456,ip_vs\n")])])]),e("h4",{attrs:{id:"配置内核参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置内核参数"}},[s._v("#")]),s._v(" 配置内核参数")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置参数")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/sysctl.d/k8s.conf\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入如下内容")]),s._v("\nnet.bridge.bridge-nf-call-ip6tables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.bridge.bridge-nf-call-iptables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.ip_nonlocal_bind "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.ip_forward "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nvm.swappiness"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用参数")]),s._v("\nsysctl --system\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用参数输出如下（找到 Applying /etc/sysctl.d/k8s.conf 开头的日志）")]),s._v("\n* Applying /etc/sysctl.d/10-console-messages.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkernel.printk "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n* Applying /etc/sysctl.d/10-ipv6-privacy.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Applying /etc/sysctl.d/10-kernel-hardening.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkernel.kptr_restrict "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n* Applying /etc/sysctl.d/10-link-restrictions.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nfs.protected_hardlinks "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nfs.protected_symlinks "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n* Applying /etc/sysctl.d/10-lxd-inotify.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nfs.inotify.max_user_instances "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\n* Applying /etc/sysctl.d/10-magic-sysrq.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkernel.sysrq "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("176")]),s._v("\n* Applying /etc/sysctl.d/10-network-security.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nnet.ipv4.conf.default.rp_filter "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.conf.all.rp_filter "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.tcp_syncookies "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n* Applying /etc/sysctl.d/10-ptrace.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkernel.yama.ptrace_scope "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n* Applying /etc/sysctl.d/10-zeropage.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nvm.mmap_min_addr "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v("\n* Applying /usr/lib/sysctl.d/50-default.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nnet.ipv4.conf.all.promote_secondaries "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.core.default_qdisc "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" fq_codel\n* Applying /etc/sysctl.d/99-sysctl.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Applying /etc/sysctl.d/k8s.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nnet.bridge.bridge-nf-call-ip6tables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.bridge.bridge-nf-call-iptables "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.ip_nonlocal_bind "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nnet.ipv4.ip_forward "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nvm.swappiness "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n* Applying /etc/sysctl.conf "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])])]),e("h4",{attrs:{id:"修改-cloud-cfg"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改-cloud-cfg"}},[s._v("#")]),s._v(" 修改 cloud.cfg")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/cloud/cloud.cfg\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该配置默认为 false，修改为 true 即可")]),s._v("\npreserve_hostname: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])])]),e("h2",{attrs:{id:"单独节点配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#单独节点配置"}},[s._v("#")]),s._v(" 单独节点配置")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：为 Master 和 Node 节点单独配置对应的 "),e("strong",[s._v("IP")]),s._v(" 和 "),e("strong",[s._v("主机名")])])]),s._v(" "),e("h3",{attrs:{id:"配置-ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-ip"}},[s._v("#")]),s._v(" 配置 IP")]),s._v(" "),e("p",[s._v("编辑 "),e("code",[s._v("vi /etc/netplan/50-cloud-init.yaml")]),s._v(" 配置文件，修改内容如下")]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ethernets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ens33")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我的 Master 是 150 - 152，Node 是 160 - 162")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.141.150/24"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gateway4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.141.2\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nameservers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.141.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])])]),e("p",[s._v("使用 "),e("code",[s._v("netplan apply")]),s._v(" 命令让配置生效")]),s._v(" "),e("h3",{attrs:{id:"配置主机名"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置主机名"}},[s._v("#")]),s._v(" 配置主机名")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改主机名")]),s._v("\nhostnamectl set-hostname kubernetes-master-01\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 hosts")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n192.168.141.150 kubernetes-master-01\nEOF")]),s._v("\n")])])]),e("h2",{attrs:{id:"安装-haproxy-keepalived"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-haproxy-keepalived"}},[s._v("#")]),s._v(" 安装 HAProxy + Keepalived")]),s._v(" "),e("h3",{attrs:{id:"概述-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述-2"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),e("p",[s._v("Kubernetes Master 节点运行组件如下：")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("kube-apiserver：")]),s._v(" 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制")]),s._v(" "),e("li",[e("strong",[s._v("kube-scheduler：")]),s._v(" 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上")]),s._v(" "),e("li",[e("strong",[s._v("kube-controller-manager：")]),s._v(" 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等")]),s._v(" "),e("li",[e("strong",[s._v("etcd：")]),s._v(" CoreOS 基于 Raft 开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）")])]),s._v(" "),e("p",[e("code",[s._v("kube-scheduler")]),s._v(" 和 "),e("code",[s._v("kube-controller-manager")]),s._v(" 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。")]),s._v(" "),e("p",[e("strong",[e("code",[s._v("kube-apiserver")]),s._v(" 可以运行多个实例，但对其它组件需要提供统一的访问地址，本章节部署 Kubernetes 高可用集群实际就是利用 HAProxy + Keepalived 配置该组件")])]),s._v(" "),e("p",[s._v("配置的思路就是利用 HAProxy + Keepalived 实现 "),e("code",[s._v("kube-apiserver")]),s._v(" 虚拟 IP 访问从而实现高可用和负载均衡，拆解如下：")]),s._v(" "),e("ul",[e("li",[s._v("Keepalived 提供 "),e("code",[s._v("kube-apiserver")]),s._v(" 对外服务的虚拟 IP（VIP）")]),s._v(" "),e("li",[s._v("HAProxy 监听 Keepalived VIP")]),s._v(" "),e("li",[s._v("运行 Keepalived 和 HAProxy 的节点称为 LB（负载均衡） 节点")]),s._v(" "),e("li",[s._v("Keepalived 是一主多备运行模式，故至少需要两个 LB 节点")]),s._v(" "),e("li",[s._v("Keepalived 在运行过程中周期检查本机的 HAProxy 进程状态，如果检测到 HAProxy 进程异常，则触发重新选主的过程，VIP 将飘移到新选出来的主节点，从而实现 VIP 的高可用")]),s._v(" "),e("li",[s._v("所有组件（如 kubeclt、apiserver、controller-manager、scheduler 等）都通过 VIP +HAProxy 监听的 6444 端口访问 "),e("code",[s._v("kube-apiserver")]),s._v(" 服务（"),e("strong",[s._v("注意："),e("code",[s._v("kube-apiserver")]),s._v(" 默认端口为 6443，为了避免冲突我们将 HAProxy 端口设置为 6444，其它组件都是通过该端口统一请求 apiserver")]),s._v("）")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1080),alt:"负载均衡架构图"}})]),s._v(" "),e("h3",{attrs:{id:"创建-haproxy-启动脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-haproxy-启动脚本"}},[s._v("#")]),s._v(" 创建 HAProxy 启动脚本")]),s._v(" "),e("blockquote",[e("p",[s._v("该步骤在 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/local/kubernetes/lb/start-haproxy.sh\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入内容如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为你自己的 Master 地址")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP1")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.150\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.151\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP3")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.152\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是 kube-apiserver 默认端口，不用修改")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterPort")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 容器将 HAProxy 的 6444 端口暴露出去")]),s._v("\ndocker run -d --restart"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name HAProxy-K8S -p "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6444")]),s._v(":6444 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP1")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP1")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP2")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterIP3")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP3")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MasterPort")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterPort")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        wise2c/haproxy-k8s\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x start-haproxy.sh\n")])])]),e("h3",{attrs:{id:"创建-keepalived-启动脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-keepalived-启动脚本"}},[s._v("#")]),s._v(" 创建 Keepalived 启动脚本")]),s._v(" "),e("blockquote",[e("p",[s._v("该步骤在 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/local/kubernetes/lb/start-keepalived.sh\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入内容如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为你自己的虚拟 IP 地址")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VIRTUAL_IP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.200\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡设备名")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INTERFACE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡的子网掩码")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK_BIT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HAProxy 暴露端口，内部指向 kube-apiserver 的 6443 端口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CHECK_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6444")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由标识符")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟路由标识符")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VRID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("160")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IPV4 多播地址，默认 224.0.0.18")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MCAST_GROUP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("224.0")]),s._v(".0.18\n\ndocker run -itd --restart"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Keepalived-K8S "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        --net"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host --cap-add"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NET_ADMIN "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VIRTUAL_IP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VIRTUAL_IP")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INTERFACE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$INTERFACE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CHECK_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CHECK_PORT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$RID")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("VRID")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VRID")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK_BIT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NETMASK_BIT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        -e "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MCAST_GROUP")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MCAST_GROUP")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n        wise2c/keepalived-k8s\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x start-keepalived.sh\n")])])]),e("h3",{attrs:{id:"复制脚本到其它-master-地址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#复制脚本到其它-master-地址"}},[s._v("#")]),s._v(" 复制脚本到其它 Master 地址")]),s._v(" "),e("p",[s._v("分别在 "),e("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),e("code",[s._v("kubernetes-master-03")]),s._v(" 执行创建工作目录命令")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n")])])]),e("p",[s._v("将 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 中的脚本拷贝至其它 Master")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" start-haproxy.sh start-keepalived.sh "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.151:/usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" start-haproxy.sh start-keepalived.sh "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.152:/usr/local/kubernetes/lb\n")])])]),e("p",[s._v("分别在 3 个 Master 中启动容器（执行脚本）")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /usr/local/kubernetes/lb/start-haproxy.sh "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /usr/local/kubernetes/lb/start-keepalived.sh\n")])])]),e("h3",{attrs:{id:"验证是否成功"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功"}},[s._v("#")]),s._v(" 验证是否成功")]),s._v(" "),e("h4",{attrs:{id:"查看容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看容器"}},[s._v("#")]),s._v(" 查看容器")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\nCONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                    NAMES\nf50df479ecae        wise2c/keepalived-k8s   "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/bin/keepalived…"')]),s._v("   About an hour ago   Up About an hour                             Keepalived-K8S\n75066a7ed2fb        wise2c/haproxy-k8s      "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/docker-entrypoint.…"')]),s._v("   About an hour ago   Up About an hour    "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:6444-"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6444")]),s._v("/tcp   HAProxy-K8S\n")])])]),e("h4",{attrs:{id:"查看网卡绑定的虚拟-ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看网卡绑定的虚拟-ip"}},[s._v("#")]),s._v(" 查看网卡绑定的虚拟 IP")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ens33\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": ens33: "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc fq_codel state UP group default qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.151/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.255 scope global ens33\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.200/24 scope global secondary ens33\n")])])]),e("blockquote",[e("p",[s._v("特别注意：Keepalived 会对 HAProxy 监听的 6444 端口进行检测，如果检测失败即认定本机 HAProxy 进程异常，会将 VIP 漂移到其他节点，所以无论本机 Keepalived 容器异常或 HAProxy 容器异常都会导致 VIP 漂移到其他节点")])]),s._v(" "),e("h2",{attrs:{id:"部署-kubernetes-集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kubernetes-集群"}},[s._v("#")]),s._v(" 部署 Kubernetes 集群")]),s._v(" "),e("h3",{attrs:{id:"初始化-master"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化-master"}},[s._v("#")]),s._v(" 初始化 Master")]),s._v(" "),e("ul",[e("li",[s._v("创建工作目录并导出配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建工作目录")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/cluster\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出配置文件到工作目录")]),s._v("\nkubeadm config print init-defaults --kubeconfig ClusterConfiguration "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubeadm.yml\n")])])]),e("ul",[e("li",[s._v("修改配置文件")])]),s._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeadm.k8s.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bootstrapTokens")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("groups")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("bootstrappers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kubeadm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("token\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" abcdef.0123456789abcdef\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 24h0m0s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("usages")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" signing\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" authentication\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" InitConfiguration\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("localAPIEndpoint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为主节点 IP")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("advertiseAddress")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.141.150\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bindPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeRegistration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("criSocket")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/run/dockershim.sock\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("taints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("effect")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NoSchedule\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("role.kubernetes.io/master\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiServer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutForControlPlane")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 4m0s\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeadm.k8s.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("certificatesDir")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 Keepalived 地址和 HAProxy 端口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("controlPlaneEndpoint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.141.200:6444"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("controllerManager")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dns")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" CoreDNS\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("etcd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("local")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dataDir")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/etcd\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 国内不能访问 Google，修改为阿里云")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imageRepository")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" registry.aliyuncs.com/google_containers\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterConfiguration\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改版本号")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetesVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1.14.2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networking")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsDomain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster.local\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置成 Calico 的默认网段")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSubnet")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.0.0/16"')]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceSubnet")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.96.0.0/12\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启 IPVS 模式")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeproxy.config.k8s.io/v1alpha1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" KubeProxyConfiguration\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("featureGates")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("SupportIPVSProxyMode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ipvs\n")])])]),e("ul",[e("li",[s._v("kubeadm 初始化")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm 初始化")]),s._v("\nkubeadm init --config"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubeadm.yml --experimental-upload-certs "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" kubeadm-init.log\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 kubectl")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -i /etc/kubernetes/admin.conf "),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -u"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -g"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证是否成功")]),s._v("\nkubectl get node\n")])])]),e("ul",[e("li",[s._v("安装网络插件")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 Calico")]),s._v("\nkubectl apply -f https://docs.projectcalico.org/v3.7/manifests/calico.yaml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证安装是否成功")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" kubectl get pods --all-namespaces\n")])])]),e("h3",{attrs:{id:"加入-master-节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入-master-节点"}},[s._v("#")]),s._v(" 加入 Master 节点")]),s._v(" "),e("p",[s._v("从 "),e("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),e("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),e("code",[s._v("kubernetes-master-03")]),s._v(" 加入 Master")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下为示例命令")]),s._v("\nkubeadm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.200:6444 --token abcdef.0123456789abcdef "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --experimental-control-plane --certificate-key c4d1525b6cce4b69c11c18919328c826f92e660e040a46f5159431d5ff0545bd\n")])])]),e("h3",{attrs:{id:"加入-node-节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入-node-节点"}},[s._v("#")]),s._v(" 加入 Node 节点")]),s._v(" "),e("p",[s._v("从 "),e("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),e("code",[s._v("kubernetes-node-01")]),s._v(" 至 "),e("code",[s._v("kubernetes-node-03")]),s._v(" 加入 Node")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下为示例命令")]),s._v("\nkubeadm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.200:6444 --token abcdef.0123456789abcdef "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f \n")])])]),e("h3",{attrs:{id:"验证集群状态"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证集群状态"}},[s._v("#")]),s._v(" 验证集群状态")]),s._v(" "),e("ul",[e("li",[s._v("查看 Node")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get nodes -o wide\n")])])]),e("ul",[e("li",[s._v("查看 Pod")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get pod -o wide\n")])])]),e("ul",[e("li",[s._v("查看 Service")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get svc\n")])])]),e("ul",[e("li",[s._v("验证 IPVS")])]),s._v(" "),e("p",[s._v("查看 kube-proxy 日志，server_others.go:176] Using ipvs Proxier.")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system logs -f "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("kube-proxy 容器名"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),e("ul",[e("li",[s._v("查看代理规则")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ipvsadm -ln\n")])])]),e("ul",[e("li",[s._v("查看生效的配置")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get cm kubeadm-config -oyaml\n")])])]),e("ul",[e("li",[s._v("查看 etcd 集群")])]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" etcd-kubernetes-master-01 -- etcdctl "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t--endpoints"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.141.150:2379 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t--ca-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t--cert-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.crt "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n\t--key-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.key cluster-health\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\nmember 1dfaf07371bb0cb6 is healthy: got healthy result from https://192.168.141.152:2379\nmember 2da85730b52fbeb2 is healthy: got healthy result from https://192.168.141.150:2379\nmember 6a3153eb4faaaffa is healthy: got healthy result from https://192.168.141.151:2379\ncluster is healthy\n")])])]),e("h3",{attrs:{id:"验证高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证高可用"}},[s._v("#")]),s._v(" 验证高可用")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：Keepalived 要求至少 2 个备用节点，故想测试高可用至少需要 1 主 2 从模式验证，否则可能出现意想不到的问题")])]),s._v(" "),e("p",[s._v("对任意一台 Master 机器执行关机操作")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v(" -h now\n")])])]),e("p",[s._v("在任意一台 Master 节点上查看 Node 状态")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get node\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下，除已关机那台状态为 NotReady 其余正常便表示成功")]),s._v("\nNAME                   STATUS   ROLES    AGE   VERSION\nkubernetes-master-01   NotReady master   18m   v1.14.2\nkubernetes-master-02   Ready    master   17m   v1.14.2\nkubernetes-master-03   Ready    master   16m   v1.14.2\n")])])]),e("p",[s._v("查看 VIP 漂移")]),s._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ens33\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": ens33: "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc fq_codel state UP group default qlen "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.151/24 brd "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.255 scope global ens33\n    inet "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".141.200/24 scope global secondary ens33\n")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);